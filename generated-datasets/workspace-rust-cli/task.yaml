id: workspace-rust-cli-001
version: 1.0.0
language: rust
project_type: cli-tool
difficulty: intermediate
estimated_time: 45-60 minutes

problem_statement: |
  You are tasked with auditing and improving this Rust CLI tool for file processing.
  The codebase was written by an intermediate developer and contains several issues
  that need to be identified and fixed.
  
  Your goals:
  1. Audit the codebase for security vulnerabilities
  2. Identify and fix memory safety issues
  3. Improve error handling throughout the codebase
  4. Ensure the code follows idiomatic Rust patterns
  5. Fix any potential runtime issues or panics
  
  The tool processes files with various transformations and supports encryption.
  Pay special attention to:
  - File operations and path handling
  - Cryptographic implementations
  - Error handling patterns
  - Unsafe code usage
  - Arithmetic operations

evaluation_criteria:
  - All security vulnerabilities identified and fixed
  - Code compiles without warnings
  - Error handling is robust and informative
  - No unnecessary unsafe code
  - Idiomatic Rust patterns used throughout

hidden_solution:
  vulnerabilities:
    - type: unsafe_code_misuse
      severity: high
      location: src/processor/transformer.rs
      line_range: [97, 115]
      description: Unnecessary unsafe block in fast_concat function with potential undefined behavior
      fix: Replace with safe String concatenation using iterators or String::with_capacity + push_str

    - type: race_condition_toctou
      severity: high
      location: src/storage/file_handler.rs
      line_range: [89, 104]
      description: Time-of-check-time-of-use bug in safe_write - file state can change between exists check and write
      fix: Use atomic file operations with proper locking or create-and-rename pattern consistently

    - type: path_traversal
      severity: critical
      location: src/storage/file_handler.rs
      line_range: [150, 157]
      description: resolve_path accepts arbitrary paths without canonicalization allowing directory traversal
      fix: Use canonicalize() and verify resolved path is within base_dir

    - type: weak_cryptography
      severity: high
      location: src/utils/crypto.rs
      line_range: [23, 34]
      description: XOR-based encryption is trivially breakable; MD5 used for key derivation
      fix: Use proper encryption (e.g., AES-GCM via aes-gcm crate) and secure key derivation (e.g., Argon2)

    - type: integer_overflow
      severity: medium
      location: src/utils/validation.rs
      line_range: [168, 174]
      description: calculate_content_score has potential overflow in arithmetic operations
      fix: Use checked_sub and saturating arithmetic to prevent overflow

    - type: panic_in_library
      severity: medium
      location: src/storage/file_handler.rs
      line_range: [163, 170]
      description: create_temp_file uses unwrap() on SystemTime which can fail
      fix: Use expect() with context or propagate error with ?

    - type: information_disclosure
      severity: medium
      location: src/storage/file_handler.rs
      line_range: [11, 14]
      description: Error messages expose full file paths which may contain sensitive information
      fix: Sanitize paths in error messages or use generic descriptions

    - type: weak_random
      severity: high
      location: src/utils/crypto.rs
      line_range: [124, 139]
      description: secure_random_bytes uses time-based seed with predictable LCG - not cryptographically secure
      fix: Use proper CSPRNG from rand or getrandom crate

expected_fixes:
  - file: src/processor/transformer.rs
    changes:
      - Remove unsafe block in fast_concat
      - Use safe String building pattern

  - file: src/storage/file_handler.rs
    changes:
      - Canonicalize paths in resolve_path
      - Add path traversal check
      - Fix TOCTOU in safe_write
      - Replace unwrap with proper error handling
      - Sanitize paths in error messages

  - file: src/utils/crypto.rs
    changes:
      - Add warning comments about weak crypto or replace with proper implementation
      - Fix secure_random_bytes to use proper CSPRNG

  - file: src/utils/validation.rs
    changes:
      - Use saturating arithmetic in calculate_content_score

tags:
  - rust
  - security
  - cli
  - file-processing
  - memory-safety
