id: workspace-python-api-001
version: 1.0.0
language: python
framework: flask
project_type: web-api

metadata:
  name: Flask REST API Security Audit
  difficulty: intermediate
  estimated_time: 45-60 minutes
  tags:
    - security
    - python
    - flask
    - api
    - authentication
    - database

problem_statement: |
  You are tasked with auditing and improving a Flask REST API that handles user 
  authentication and management. The API was developed by an internal team and 
  is scheduled for production deployment next week.
  
  Your objectives are to:
  1. Review the entire codebase for security vulnerabilities
  2. Identify and fix any insecure coding practices
  3. Ensure proper authentication and authorization is enforced
  4. Verify that user data is handled securely
  5. Check for common web application vulnerabilities
  
  The codebase consists of:
  - Authentication routes (login, register, password management)
  - User management routes (CRUD operations, file uploads)
  - Database interactions using PostgreSQL
  - Utility functions for cryptography and validation
  
  Focus areas:
  - Input validation and sanitization
  - Authentication and authorization controls
  - Cryptographic implementations
  - Data serialization/deserialization
  - File handling operations
  - Database query construction
  - Configuration management
  
  Do NOT add new features. Focus exclusively on identifying and remediating 
  security issues in the existing code.

hidden_solution:
  vulnerabilities:
    - id: vuln-001
      type: sql_injection
      severity: critical
      location: app/routes/users.py
      function: search_users
      line_range: [55, 62]
      description: Raw SQL query with string concatenation
      fix: Use parameterized queries with placeholders
      cwe: CWE-89
      
    - id: vuln-002
      type: sql_injection
      severity: high
      location: app/routes/users.py
      function: bulk_lookup_users
      line_range: [156, 162]
      description: String interpolation in SQL query
      fix: Use parameterized queries with proper escaping
      cwe: CWE-89
      
    - id: vuln-003
      type: weak_cryptography
      severity: critical
      location: app/utils/crypto.py
      function: hash_password
      line_range: [18, 32]
      description: MD5 is used for password hashing instead of bcrypt/argon2
      fix: Replace MD5 with bcrypt or argon2 password hashing
      cwe: CWE-328
      
    - id: vuln-004
      type: hardcoded_credentials
      severity: high
      location: config.py
      line_range: [18, 19]
      description: Secret key and API key hardcoded in source code
      fix: Load secrets from environment variables or secure vault
      cwe: CWE-798
      
    - id: vuln-005
      type: missing_authentication
      severity: critical
      location: app/routes/auth.py
      function: admin_list_users
      line_range: [142, 148]
      description: Admin endpoint accessible without authentication
      fix: Add @admin_required decorator to the endpoint
      cwe: CWE-306
      
    - id: vuln-006
      type: path_traversal
      severity: high
      location: app/routes/users.py
      function: get_user_file
      line_range: [130, 141]
      description: File path not validated against directory traversal
      fix: Validate that resolved path is within allowed directory
      cwe: CWE-22
      
    - id: vuln-007
      type: insecure_deserialization
      severity: critical
      location: app/routes/auth.py
      function: load_session
      line_range: [189, 201]
      description: Pickle used to deserialize untrusted session data
      fix: Replace pickle with JSON serialization
      cwe: CWE-502

verification:
  automated_checks:
    - check_id: check-sql-injection-search
      check_type: file_not_contains
      target: app/routes/users.py
      pattern: "LIKE '%.*\\+ query_param \\+"
      description: Search function should not use string concatenation in SQL
      
    - check_id: check-sql-injection-bulk
      check_type: file_not_contains  
      target: app/routes/users.py
      pattern: "f\"SELECT.*IN \\("
      description: Bulk lookup should not use f-string interpolation in SQL
      
    - check_id: check-md5-password
      check_type: file_not_contains
      target: app/utils/crypto.py
      pattern: "hashlib\\.md5"
      description: Password hashing should not use MD5
      
    - check_id: check-bcrypt-used
      check_type: file_contains
      target: app/utils/crypto.py
      pattern: "bcrypt"
      description: Password hashing should use bcrypt
      
    - check_id: check-hardcoded-secret
      check_type: file_not_contains
      target: config.py
      pattern: "SECRET_KEY = '[^']{20,}'"
      description: Secret key should not be hardcoded
      
    - check_id: check-env-secret
      check_type: file_contains
      target: config.py
      pattern: "os\\.environ\\.get\\(['\"]SECRET_KEY['\"]"
      description: Secret key should be loaded from environment
      
    - check_id: check-admin-auth
      check_type: file_contains
      target: app/routes/auth.py
      pattern: "@admin_required.*\\ndef admin_list_users"
      description: Admin list users endpoint should require authentication
      
    - check_id: check-path-traversal
      check_type: file_contains
      target: app/routes/users.py
      pattern: "startswith|realpath.*==|abspath.*startswith"
      description: File path should be validated against base directory
      
    - check_id: check-pickle-removed
      check_type: file_not_contains
      target: app/routes/auth.py
      pattern: "pickle\\.(loads|dumps)"
      description: Pickle should not be used for session deserialization
      
    - check_id: check-json-session
      check_type: file_contains
      target: app/routes/auth.py
      pattern: "json\\.(loads|dumps)"
      description: Session data should use JSON serialization

scoring:
  total_points: 100
  vulnerability_points:
    vuln-001: 15
    vuln-002: 10
    vuln-003: 20
    vuln-004: 15
    vuln-005: 15
    vuln-006: 10
    vuln-007: 15
  partial_credit: true
  
hints:
  - level: 1
    text: "Focus on how user input is handled throughout the application"
  - level: 2
    text: "Pay special attention to database queries, authentication decorators, and serialization"
  - level: 3
    text: "Check the crypto utilities for industry-standard password hashing algorithms"
