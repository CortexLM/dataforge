id: jmix-framework/jmix-5079
repo: jmix-framework/jmix
base_commit: e5bb49eaa22cb130733396c4ea5a148db5353714
merge_commit: c99e35d3fcbf943e2c329327d8f293a424befddb
language: java
difficulty_score: 2
created_at: 2026-02-17T17:23:03.401901315Z
patch: "diff --git a/jmix-multitenancy/multitenancy-flowui/src/main/java/io/jmix/multitenancyflowui/impl/SameTenantRoleHierarchyCandidatePredicate.java b/jmix-multitenancy/multitenancy-flowui/src/main/java/io/jmix/multitenancyflowui/impl/SameTenantRoleHierarchyCandidatePredicate.java\nindex 442fe136aa..c50ff35e8e 100644\n--- a/jmix-multitenancy/multitenancy-flowui/src/main/java/io/jmix/multitenancyflowui/impl/SameTenantRoleHierarchyCandidatePredicate.java\n+++ b/jmix-multitenancy/multitenancy-flowui/src/main/java/io/jmix/multitenancyflowui/impl/SameTenantRoleHierarchyCandidatePredicate.java\n@@ -16,9 +16,11 @@\n \n package io.jmix.multitenancyflowui.impl;\n \n+import io.jmix.multitenancy.core.TenantProvider;\n import io.jmix.security.model.BaseRole;\n import io.jmix.security.model.RoleSource;\n import io.jmix.securityflowui.util.RoleHierarchyCandidatePredicate;\n+import org.springframework.beans.factory.annotation.Autowired;\n \n import java.util.Objects;\n \n@@ -28,18 +30,31 @@\n  */\n public class SameTenantRoleHierarchyCandidatePredicate implements RoleHierarchyCandidatePredicate {\n \n+    @Autowired\n+    protected TenantProvider tenantProvider;\n+\n     @Override\n     public boolean test(BaseRole currentRole, BaseRole baseRoleCandidate) {\n         if (RoleSource.ANNOTATED_CLASS.equals(baseRoleCandidate.getSource())) {\n+            // Design-time roles are always allowed\n             return true;\n         }\n-        if (currentRole == null || baseRoleCandidate == null) {\n+        if (baseRoleCandidate == null) {\n             return false;\n         }\n \n-        String childRoleTenantId = currentRole.getTenantId();\n+        String currentRoleTenantId;\n+        if (currentRole == null) {\n+            // 'Null' current role means this role is during creation process - get tenant fron current user\n+            String currentUserTenant = tenantProvider.getCurrentUserTenantId();\n+            // Convert \"NO_TENANT\" to null to match null tenant of role\n+            currentRoleTenantId = TenantProvider.NO_TENANT.equals(currentUserTenant) ? null : currentUserTenant;\n+        } else {\n+            currentRoleTenantId = currentRole.getTenantId();\n+        }\n+\n         String baseRoleCandidateTenantId = baseRoleCandidate.getTenantId();\n \n-        return Objects.equals(baseRoleCandidateTenantId, childRoleTenantId);\n+        return Objects.equals(baseRoleCandidateTenantId, currentRoleTenantId);\n     }\n }\n\\ No newline at end of file\ndiff --git a/jmix-security/security-flowui/src/main/java/io/jmix/securityflowui/action/AssignToUsersAction.java b/jmix-security/security-flowui/src/main/java/io/jmix/securityflowui/action/AssignToUsersAction.java\nindex 5175c016ef..fed809283d 100644\n--- a/jmix-security/security-flowui/src/main/java/io/jmix/securityflowui/action/AssignToUsersAction.java\n+++ b/jmix-security/security-flowui/src/main/java/io/jmix/securityflowui/action/AssignToUsersAction.java\n@@ -72,7 +72,7 @@ public class AssignToUsersAction<E extends BaseRoleModel>\n     protected RoleAssignmentPersistence roleAssignmentPersistence;\n     protected UserRepository userRepository;\n \n-    protected RoleAssignmentCandidatePredicate compositeRoleAssignmentCandidatePredicate;\n+    protected RoleAssignmentCandidatePredicate compositeRoleAssignmentCandidatePredicate = (userDetails, baseRole) -> true;\n \n     protected ResourceRoleRepository resourceRoleRepository;\n     protected RowLevelRoleRepository rowLevelRoleRepository;\n@@ -191,13 +191,15 @@ protected void openDialog() {\n                         return true;\n                     }\n                     Collection<?> selectedItems = validationContext.getSelectedItems();\n-                    for (Object item : selectedItems) {\n-                        if (item instanceof UserDetails userDetails) {\n-                            boolean applicable = compositeRoleAssignmentCandidatePredicate.test(userDetails, baseRole);\n-                            if (!applicable) {\n-                                log.warn(\"Role '{}' can't be assigned to user '{}'\", baseRole.getName(), userDetails.getUsername());\n-                                showNotificationIncorrectUserSelected(userDetails);\n-                                return false;\n+                    if (compositeRoleAssignmentCandidatePredicate != null && CollectionUtils.isNotEmpty(selectedItems)) {\n+                        for (Object item : selectedItems) {\n+                            if (item instanceof UserDetails userDetails) {\n+                                boolean applicable = compositeRoleAssignmentCandidatePredicate.test(userDetails, baseRole);\n+                                if (!applicable) {\n+                                    log.warn(\"Role '{}' can't be assigned to user '{}'\", baseRole.getName(), userDetails.getUsername());\n+                                    showNotificationIncorrectUserSelected(userDetails);\n+                                    return false;\n+                                }\n                             }\n                         }\n                     }\ndiff --git a/jmix-security/security-flowui/src/main/java/io/jmix/securityflowui/util/PredicateUtils.java b/jmix-security/security-flowui/src/main/java/io/jmix/securityflowui/util/PredicateUtils.java\nindex 3dca552bd5..fda9542be3 100644\n--- a/jmix-security/security-flowui/src/main/java/io/jmix/securityflowui/util/PredicateUtils.java\n+++ b/jmix-security/security-flowui/src/main/java/io/jmix/securityflowui/util/PredicateUtils.java\n@@ -81,9 +81,11 @@ public static <T, U, P extends BiPredicate<T, U>> P combineBiPredicates(List<P>\n                 Using loop instead of 'and()' to work with custom type of predicates\n                 and to mitigate possible stack overflow due to undetermined amount of predicates (low probability)\n              */\n-            for (P p : predicates) {\n-                if (!p.test(t, u)) {\n-                    return false;\n+            if (predicates != null) {\n+                for (P p : predicates) {\n+                    if (!p.test(t, u)) {\n+                        return false;\n+                    }\n                 }\n             }\n             return true;\ndiff --git a/jmix-security/security-flowui/src/main/java/io/jmix/securityflowui/view/resourcerole/ResourceRoleModelDetailView.java b/jmix-security/security-flowui/src/main/java/io/jmix/securityflowui/view/resourcerole/ResourceRoleModelDetailView.java\nindex 85cf4f71b1..a620b54962 100644\n--- a/jmix-security/security-flowui/src/main/java/io/jmix/securityflowui/view/resourcerole/ResourceRoleModelDetailView.java\n+++ b/jmix-security/security-flowui/src/main/java/io/jmix/securityflowui/view/resourcerole/ResourceRoleModelDetailView.java\n@@ -209,12 +209,11 @@ private void setupRoleReadOnlyMode(boolean isDatabaseSource) {\n     @Subscribe(\"childRolesTable.add\")\n     public void onChildRolesTableAdd(ActionPerformedEvent event) {\n         ResourceRoleModel resourceRoleModel = getEditedEntity();\n-        ResourceRole currentRole = roleRepository.findRoleByCode(resourceRoleModel.getCode());\n \n         DialogWindow<ResourceRoleModelLookupView> lookupDialog = dialogWindows.lookup(childRolesTable)\n                 .withViewClass(ResourceRoleModelLookupView.class)\n                 .withViewConfigurer(configurer -> {\n-                    configurer.setCurrentRole(currentRole);\n+                    configurer.setCurrentRoleModel(resourceRoleModel);\n                 })\n                 .build();\n \ndiff --git a/jmix-security/security-flowui/src/main/java/io/jmix/securityflowui/view/resourcerole/ResourceRoleModelLookupView.java b/jmix-security/security-flowui/src/main/java/io/jmix/securityflowui/view/resourcerole/ResourceRoleModelLookupView.java\nindex 47911885a3..88a8b6c6fc 100644\n--- a/jmix-security/security-flowui/src/main/java/io/jmix/securityflowui/view/resourcerole/ResourceRoleModelLookupView.java\n+++ b/jmix-security/security-flowui/src/main/java/io/jmix/securityflowui/view/resourcerole/ResourceRoleModelLookupView.java\n@@ -18,10 +18,12 @@\n \n import com.vaadin.flow.router.Route;\n import com.vaadin.flow.router.RouteAlias;\n+import io.jmix.core.EntityStates;\n import io.jmix.flowui.UiComponents;\n import io.jmix.flowui.model.CollectionContainer;\n import io.jmix.flowui.view.*;\n-import io.jmix.security.model.BaseRole;\n+import io.jmix.security.model.BaseRoleModel;\n+import io.jmix.security.model.ResourceRole;\n import io.jmix.security.model.ResourceRoleModel;\n import io.jmix.security.model.RoleModelConverter;\n import io.jmix.security.role.ResourceRoleRepository;\n@@ -58,19 +60,21 @@ public class ResourceRoleModelLookupView extends StandardListView<ResourceRoleMo\n     private RoleModelConverter roleModelConverter;\n     @Autowired\n     private ResourceRoleRepository roleRepository;\n+    @Autowired\n+    private EntityStates entityStates;\n \n     @Autowired(required = false)\n     protected List<RoleAssignmentCandidatePredicate> roleAssignmentCandidatePredicates = Collections.emptyList();\n     @Autowired(required = false)\n     protected List<RoleHierarchyCandidatePredicate> roleHierarchyCandidatePredicates = Collections.emptyList();\n \n-    protected RoleAssignmentCandidatePredicate compositeRoleAssignmentCandidatePredicate;\n-    protected RoleHierarchyCandidatePredicate compositeRoleHierarchyCandidatePredicate;\n+    protected RoleAssignmentCandidatePredicate compositeRoleAssignmentCandidatePredicate = (userDetails, baseRole) -> true;\n+    protected RoleHierarchyCandidatePredicate compositeRoleHierarchyCandidatePredicate = (baseRole, candidateRole) -> true;\n \n     private List<String> excludedRolesCodes = Collections.emptyList();\n \n     private UserDetails user;\n-    private BaseRole currentRole;\n+    private BaseRoleModel currentRoleModel;\n \n     @Subscribe\n     public void onInit(InitEvent event) {\n@@ -103,13 +107,19 @@ protected void loadRoles(@Nullable RoleFilterChangeEvent event) {\n                 )\n                 .filter(role -> {\n                     boolean allowed = true;\n-                    if (currentRole != null) {\n+                    if (currentRoleModel != null) {\n                         // apply hierarchy predicates to find available base role candidates\n-                        allowed = allowed && compositeRoleHierarchyCandidatePredicate.test(currentRole, role);\n+                        boolean isNewRole = entityStates.isNew(currentRoleModel);\n+                        if (isNewRole) {\n+                            allowed = compositeRoleHierarchyCandidatePredicate.test(null, role);\n+                        } else if (currentRoleModel.getCode() != null) {\n+                            ResourceRole currentRole = roleRepository.findRoleByCode(currentRoleModel.getCode());\n+                            allowed = compositeRoleHierarchyCandidatePredicate.test(currentRole, role);\n+                        }\n                     }\n                     if (allowed && user != null) {\n                         // apply user-based predicates to find roles available for user\n-                        allowed = allowed && compositeRoleAssignmentCandidatePredicate.test(user, role);\n+                        allowed = compositeRoleAssignmentCandidatePredicate.test(user, role);\n                     }\n                     return allowed;\n                 })\n@@ -128,7 +138,7 @@ public void setUser(UserDetails user) {\n         this.user = user;\n     }\n \n-    public void setCurrentRole(BaseRole currentRole) {\n-        this.currentRole = currentRole;\n+    public void setCurrentRoleModel(BaseRoleModel currentRoleModel) {\n+        this.currentRoleModel = currentRoleModel;\n     }\n }\ndiff --git a/jmix-security/security-flowui/src/main/java/io/jmix/securityflowui/view/rowlevelrole/RowLevelRoleModelDetailView.java b/jmix-security/security-flowui/src/main/java/io/jmix/securityflowui/view/rowlevelrole/RowLevelRoleModelDetailView.java\nindex 603200ff9d..2dfe3632f1 100644\n--- a/jmix-security/security-flowui/src/main/java/io/jmix/securityflowui/view/rowlevelrole/RowLevelRoleModelDetailView.java\n+++ b/jmix-security/security-flowui/src/main/java/io/jmix/securityflowui/view/rowlevelrole/RowLevelRoleModelDetailView.java\n@@ -153,12 +153,11 @@ private void setupRoleReadOnlyMode() {\n     @Subscribe(\"childRolesTable.add\")\n     public void onChildRolesTableAdd(ActionPerformedEvent event) {\n         RowLevelRoleModel rowLevelRoleModel = getEditedEntity();\n-        RowLevelRole currentRole = roleRepository.findRoleByCode(rowLevelRoleModel.getCode());\n \n         DialogWindow<RowLevelRoleModelLookupView> lookupDialog = dialogWindows.lookup(childRolesTable)\n                 .withViewClass(RowLevelRoleModelLookupView.class)\n                 .withViewConfigurer(configurer -> {\n-                    configurer.setCurrentRole(currentRole);\n+                    configurer.setCurrentRoleModel(rowLevelRoleModel);\n                 })\n                 .build();\n \ndiff --git a/jmix-security/security-flowui/src/main/java/io/jmix/securityflowui/view/rowlevelrole/RowLevelRoleModelLookupView.java b/jmix-security/security-flowui/src/main/java/io/jmix/securityflowui/view/rowlevelrole/RowLevelRoleModelLookupView.java\nindex 30fe2bbc50..c433802063 100644\n--- a/jmix-security/security-flowui/src/main/java/io/jmix/securityflowui/view/rowlevelrole/RowLevelRoleModelLookupView.java\n+++ b/jmix-security/security-flowui/src/main/java/io/jmix/securityflowui/view/rowlevelrole/RowLevelRoleModelLookupView.java\n@@ -18,11 +18,13 @@\n \n import com.vaadin.flow.router.Route;\n import com.vaadin.flow.router.RouteAlias;\n+import io.jmix.core.EntityStates;\n import io.jmix.flowui.UiComponents;\n import io.jmix.flowui.model.CollectionContainer;\n import io.jmix.flowui.view.*;\n-import io.jmix.security.model.BaseRole;\n+import io.jmix.security.model.BaseRoleModel;\n import io.jmix.security.model.RoleModelConverter;\n+import io.jmix.security.model.RowLevelRole;\n import io.jmix.security.model.RowLevelRoleModel;\n import io.jmix.security.role.RowLevelRoleRepository;\n import io.jmix.securityflowui.component.rolefilter.RoleFilter;\n@@ -58,19 +60,21 @@ public class RowLevelRoleModelLookupView extends StandardListView<RowLevelRoleMo\n     private RoleModelConverter roleModelConverter;\n     @Autowired\n     private RowLevelRoleRepository roleRepository;\n+    @Autowired\n+    private EntityStates entityStates;\n \n     @Autowired(required = false)\n     protected List<RoleAssignmentCandidatePredicate> roleAssignmentCandidatePredicates = Collections.emptyList();\n     @Autowired(required = false)\n     protected List<RoleHierarchyCandidatePredicate> roleHierarchyCandidatePredicates = Collections.emptyList();\n \n-    protected RoleAssignmentCandidatePredicate compositeRoleAssignmentCandidatePredicate;\n-    protected RoleHierarchyCandidatePredicate compositeRoleHierarchyCandidatePredicate;\n+    protected RoleAssignmentCandidatePredicate compositeRoleAssignmentCandidatePredicate = (userDetails, baseRole) -> true;\n+    protected RoleHierarchyCandidatePredicate compositeRoleHierarchyCandidatePredicate = (baseRole, candidateRole) -> true;\n \n     private List<String> excludedRolesCodes = Collections.emptyList();\n \n     private UserDetails user;\n-    private BaseRole currentRole;\n+    private BaseRoleModel currentRoleModel;\n \n     @Subscribe\n     public void onInit(InitEvent event) {\n@@ -103,13 +107,19 @@ private void loadRoles(@Nullable RoleFilterChangeEvent event) {\n                 )\n                 .filter(role -> {\n                     boolean allowed = true;\n-                    if (currentRole != null) {\n+                    if (currentRoleModel != null) {\n                         // apply hierarchy predicates to find available base role candidates\n-                        allowed = allowed && compositeRoleHierarchyCandidatePredicate.test(currentRole, role);\n+                        boolean isNewRole = entityStates.isNew(currentRoleModel);\n+                        if (isNewRole) {\n+                            allowed = compositeRoleHierarchyCandidatePredicate.test(null, role);\n+                        } else if (currentRoleModel.getCode() != null) {\n+                            RowLevelRole currentRole = roleRepository.findRoleByCode(currentRoleModel.getCode());\n+                            allowed = compositeRoleHierarchyCandidatePredicate.test(currentRole, role);\n+                        }\n                     }\n                     if (allowed && user != null) {\n                         // apply user-based predicates to find roles available for user\n-                        allowed = allowed && compositeRoleAssignmentCandidatePredicate.test(user, role);\n+                        allowed = compositeRoleAssignmentCandidatePredicate.test(user, role);\n                     }\n                     return allowed;\n                 })\n@@ -127,7 +137,7 @@ public void setUser(UserDetails user) {\n         this.user = user;\n     }\n \n-    public void setCurrentRole(BaseRole currentRole) {\n-        this.currentRole = currentRole;\n+    public void setCurrentRoleModel(BaseRoleModel currentRoleModel) {\n+        this.currentRoleModel = currentRoleModel;\n     }\n }\n\\ No newline at end of file\ndiff --git a/jmix-security/security-flowui/src/main/java/io/jmix/securityflowui/view/usersubstitution/UserSubstitutionDetailView.java b/jmix-security/security-flowui/src/main/java/io/jmix/securityflowui/view/usersubstitution/UserSubstitutionDetailView.java\nindex 185a33a0cd..e097d816fd 100644\n--- a/jmix-security/security-flowui/src/main/java/io/jmix/securityflowui/view/usersubstitution/UserSubstitutionDetailView.java\n+++ b/jmix-security/security-flowui/src/main/java/io/jmix/securityflowui/view/usersubstitution/UserSubstitutionDetailView.java\n@@ -58,7 +58,7 @@ public class UserSubstitutionDetailView extends StandardDetailView<UserSubstitut\n     @Autowired(required = false)\n     protected List<UserSubstitutionCandidatePredicate> userSubstitutionCandidatePredicates = Collections.emptyList();\n \n-    protected UserSubstitutionCandidatePredicate compositeUserSubstitutionCandidatePredicate;\n+    protected UserSubstitutionCandidatePredicate compositeUserSubstitutionCandidatePredicate = (userDetails, substitutionCandidate) -> true;\n \n     @Subscribe\n     public void onInit(final InitEvent event) {\n"
test_patch: ''
fail_to_pass:
- ./gradlew :core:compileJava --no-daemon
- ./gradlew :security:compileJava --no-daemon
pass_to_pass:
- ./gradlew :core:compileJava --no-daemon -q
- ./gradlew :security:compileJava --no-daemon -q
install_config:
  install: ./mvnw -q -DskipTests package
  java: '21'
  test_cmd: ./mvnw test
meta:
  added_lines: '74'
  difficulty: medium
  files_changed: '8'
  pr_title: 'NPE when assigning a role to users. Unable to add base roles during role creation #5047 #5073'
  removed_lines: '37'
  source: gh-archive-pr
  test_files: '[{"path":"jmix-security/security-flowui/src/test/java/io/jmix/securityflowui/action/AssignToUsersActionUnitTest.java","content":"/*\n * Copyright 2025 Haulmont.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\npackage io.jmix.securityflowui.action;\n\nimport io.jmix.security.model.BaseRole;\nimport org.junit.jupiter.api.Test;\nimport org.springframework.security.core.GrantedAuthority;\nimport org.springframework.security.core.userdetails.UserDetails;\n\nimport java.util.Collection;\nimport java.util.Collections;\n\nimport static org.junit.jupiter.api.Assertions.*;\n\n/**\n * Unit tests for AssignToUsersAction.\n * These tests verify the fix for NullPointerException when role assignment candidate predicates are not set.\n */\npublic class AssignToUsersActionUnitTest {\n\n    @Test\n    void testDefaultRoleAssignmentCandidatePredicateDoesNotThrowNPE() {\n        // Create AssignToUsersAction - the fix provides a default predicate\n        AssignToUsersAction action = new AssignToUsersAction();\n        \n        // The compositeRoleAssignmentCandidatePredicate should have a default value\n        // that doesn''t throw NPE when no predicates are injected\n        // Note: We can''t directly test the private field, but we can verify the class\n        // was constructed without error and has the expected ID\n        assertNotNull(action);\n        assertEquals(\"sec_assignToUsers\", action.getId());\n    }\n\n    @Test\n    void testActionConstructionWithId() {\n        // Test the constructor with custom ID\n        AssignToUsersAction action = new AssignToUsersAction(\"customId\");\n        \n        assertNotNull(action);\n        assertEquals(\"customId\", action.getId());\n    }\n\n    // Helper method to create mock UserDetails\n    private UserDetails createMockUserDetails(String username) {\n        return new UserDetails() {\n            @Override\n            public Collection<? extends GrantedAuthority> getAuthorities() {\n                return Collections.emptyList();\n            }\n\n            @Override\n            public String getPassword() {\n                return \"password\";\n            }\n\n            @Override\n            public String getUsername() {\n                return username;\n            }\n\n            @Override\n            public boolean isAccountNonExpired() {\n                return true;\n            }\n\n            @Override\n            public boolean isAccountNonLocked() {\n                return true;\n            }\n\n            @Override\n            public boolean isCredentialsNonExpired() {\n                return true;\n            }\n\n            @Override\n            public boolean isEnabled() {\n                return true;\n            }\n        };\n    }\n\n    // Helper method to create mock BaseRole\n    private BaseRole createMockBaseRole(String roleCode) {\n        return new BaseRole() {\n            @Override\n            public String getCode() {\n                return roleCode;\n            }\n\n            @Override\n            public String getName() {\n                return roleCode;\n            }\n\n            @Override\n            public String getSource() {\n                return \"DATABASE\";\n            }\n\n            @Override\n            public String getTenantId() {\n                return null;\n            }\n\n            @Override\n            public Collection<? extends GrantedAuthority> getAuthorities() {\n                return Collections.emptyList();\n            }\n        };\n    }\n}\n"},{"path":"jmix-multitenancy/multitenancy-flowui/src/test/java/io/jmix/multitenancyflowui/impl/SameTenantRoleHierarchyCandidatePredicateUnitTest.java","content":"/*\n * Copyright 2025 Haulmont.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\npackage io.jmix.multitenancyflowui.impl;\n\nimport io.jmix.security.model.BaseRole;\nimport io.jmix.security.model.RoleSource;\nimport org.junit.jupiter.api.Test;\nimport org.springframework.security.core.GrantedAuthority;\n\nimport java.util.Collection;\nimport java.util.Collections;\n\nimport static org.junit.jupiter.api.Assertions.*;\n\n/**\n * Unit tests for SameTenantRoleHierarchyCandidatePredicate.\n * These tests verify the fix for NPE when currentRole is null during role creation.\n */\npublic class SameTenantRoleHierarchyCandidatePredicateUnitTest {\n\n    @Test\n    void testNullCurrentRoleWithAnnotatedClassSource() {\n        SameTenantRoleHierarchyCandidatePredicate predicate = new SameTenantRoleHierarchyCandidatePredicate();\n        \n        // Annotated class roles should always be allowed regardless of current role being null\n        BaseRole baseRole = createMockRole(RoleSource.ANNOTATED_CLASS, \"annotatedRole\", null);\n        \n        // When currentRole is null (role creation process), annotated class should return true\n        // This should NOT throw NullPointerException (the bug fix)\n        boolean result = predicate.test(null, baseRole);\n        \n        assertTrue(result, \"Annotated class source should always return true even with null current role\");\n    }\n\n    @Test\n    void testNullCurrentRoleWithDatabaseSource() {\n        SameTenantRoleHierarchyCandidatePredicate predicate = new SameTenantRoleHierarchyCandidatePredicate();\n        \n        // Database role with currentRole null should return false\n        // (since we can''t determine tenant without a current user context in this unit test)\n        BaseRole baseRole = createMockRole(RoleSource.DATABASE, \"databaseRole\", \"testTenant\");\n        \n        // When currentRole is null, the old code would throw NPE\n        // The fix should handle this gracefully\n        boolean result = predicate.test(null, baseRole);\n        \n        // Without tenant provider, it should return false (currentRole is null)\n        assertFalse(result, \"Should return false when currentRole is null for database source\");\n    }\n\n    @Test\n    void testNullBaseRoleCandidate() {\n        SameTenantRoleHierarchyCandidatePredicate predicate = new SameTenantRoleHierarchyCandidatePredicate();\n        \n        // Null base role candidate should return false\n        BaseRole currentRole = createMockRole(RoleSource.DATABASE, \"currentRole\", \"testTenant\");\n        \n        boolean result = predicate.test(currentRole, null);\n        \n        assertFalse(result, \"Null base role candidate should return false\");\n    }\n\n    @Test\n    void testCurrentRoleWithSameTenant() {\n        SameTenantRoleHierarchyCandidatePredicate predicate = new SameTenantRoleHierarchyCandidatePredicate();\n        \n        // Both roles with same tenant should be allowed\n        BaseRole currentRole = createMockRole(RoleSource.DATABASE, \"currentRole\", \"tenantA\");\n        BaseRole baseRole = createMockRole(RoleSource.DATABASE, \"baseRole\", \"tenantA\");\n        \n        boolean result = predicate.test(currentRole, baseRole);\n        \n        assertTrue(result, \"Roles with same tenant should be allowed\");\n    }\n\n    @Test\n    void testCurrentRoleWithDifferentTenant() {\n        SameTenantRoleHierarchyCandidatePredicate predicate = new SameTenantRoleHierarchyCandidatePredicate();\n        \n        // Roles with different tenants should not be allowed\n        BaseRole currentRole = createMockRole(RoleSource.DATABASE, \"currentRole\", \"tenantA\");\n        BaseRole baseRole = createMockRole(RoleSource.DATABASE, \"baseRole\", \"tenantB\");\n        \n        boolean result = predicate.test(currentRole, baseRole);\n        \n        assertFalse(result, \"Roles with different tenants should not be allowed\");\n    }\n\n    @Test\n    void testBothRolesWithNullTenant() {\n        SameTenantRoleHierarchyCandidatePredicate predicate = new SameTenantRoleHierarchyCandidatePredicate();\n        \n        // Both roles with null tenant should be allowed\n        BaseRole currentRole = createMockRole(RoleSource.DATABASE, \"currentRole\", null);\n        BaseRole baseRole = createMockRole(RoleSource.DATABASE, \"baseRole\", null);\n        \n        boolean result = predicate.test(currentRole, baseRole);\n        \n        assertTrue(result, \"Both roles with null tenant should be allowed\");\n    }\n\n    @Test\n    void testAnnotatedClassRoleAlwaysAllowed() {\n        SameTenantRoleHierarchyCandidatePredicate predicate = new SameTenantRoleHierarchyCandidatePredicate();\n        \n        // Design-time roles (annotated class) should always be allowed as base roles\n        // regardless of tenant matching\n        BaseRole currentRole = createMockRole(RoleSource.DATABASE, \"currentRole\", \"tenantA\");\n        BaseRole baseRole = createMockRole(RoleSource.ANNOTATED_CLASS, \"designTimeRole\", \"tenantB\");\n        \n        boolean result = predicate.test(currentRole, baseRole);\n        \n        assertTrue(result, \"Annotated class roles should always be allowed regardless of tenant\");\n    }\n\n    @Test\n    void testCurrentRoleTenantNullBaseRoleTenantNotNull() {\n        SameTenantRoleHierarchyCandidatePredicate predicate = new SameTenantRoleHierarchyCandidatePredicate();\n        \n        // Current role with null tenant, base role with tenant should not match\n        BaseRole currentRole = createMockRole(RoleSource.DATABASE, \"currentRole\", null);\n        BaseRole baseRole = createMockRole(RoleSource.DATABASE, \"baseRole\", \"tenantA\");\n        \n        boolean result = predicate.test(currentRole, baseRole);\n        \n        assertFalse(result, \"Role with tenant should not be allowed when current role has null tenant\");\n    }\n\n    // Mock implementation of BaseRole for testing\n    private BaseRole createMockRole(RoleSource source, String code, String tenantId) {\n        return new BaseRole() {\n            @Override\n            public String getCode() {\n                return code;\n            }\n\n            @Override\n            public String getName() {\n                return code;\n            }\n\n            @Override\n            public String getSource() {\n                return source != null ? source.name() : null;\n            }\n\n            @Override\n            public String getTenantId() {\n                return tenantId;\n            }\n\n            @Override\n            public Collection<? extends GrantedAuthority> getAuthorities() {\n                return Collections.emptyList();\n            }\n        };\n    }\n}\n"}]'
  test_generation: agentic-docker
prompt: |-
  Fix two bugs in the role management functionality:

  1. Fix the NullPointerException that occurs when assigning a role to users. The system should handle role assignment gracefully without throwing NPE.

  2. Enable the ability to add base roles during the role creation process. Users should be able to select and assign base roles when creating a new role.

  Both issues affect the security role management workflow and need to be resolved to ensure proper role administration.
original_pr_body: |-
  jmix-framework/jmix (#5079): NPE when assigning a role to users. Unable to add base roles during role creation #5047 #5073

  See #5047 #5073
quality_score: 0.6
quality_passed: true
docker_passed: false
workspace_path: null
status: ready
