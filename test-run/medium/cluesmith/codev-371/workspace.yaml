id: cluesmith/codev-371
repo: cluesmith/codev
base_commit: 88f92e5f9354477efbdb5a486a13c27e45a9242c
merge_commit: e22b3341c6937d7e2aaca81dc9c1fb614155cdf3
language: typescript
difficulty_score: 2
created_at: 2026-02-17T09:23:27.528001924Z
patch: "diff --git a/packages/codev/src/__tests__/consult.test.ts b/packages/codev/src/__tests__/consult.test.ts\nindex bee03332..b4bb766c 100644\n--- a/packages/codev/src/__tests__/consult.test.ts\n+++ b/packages/codev/src/__tests__/consult.test.ts\n@@ -79,12 +79,15 @@ describe('consult command', () => {\n       // Note: Codex now uses experimental_instructions_file config flag (not env var)\n       // The args are built dynamically in runConsultation, not stored in MODEL_CONFIGS\n       // Claude uses Agent SDK (not CLI) — see 'Claude Agent SDK integration' tests\n+      // Bugfix #370: --yolo removed from MODEL_CONFIGS; added conditionally in\n+      // runConsultation only for protocol mode (not general mode)\n       const configs: Record<string, { cli: string; args: string[] }> = {\n-        gemini: { cli: 'gemini', args: ['--yolo'] },\n+        gemini: { cli: 'gemini', args: [] },\n         codex: { cli: 'codex', args: ['exec', '--full-auto'] },\n       };\n \n       expect(configs.gemini.cli).toBe('gemini');\n+      expect(configs.gemini.args).toEqual([]);\n       expect(configs.codex.args).toContain('--full-auto');\n     });\n \n@@ -635,6 +638,92 @@ describe('consult command', () => {\n     });\n   });\n \n+  describe('Gemini --yolo mode restriction (Bugfix #370)', () => {\n+    it('general mode should NOT pass --yolo to Gemini CLI', async () => {\n+      // Bugfix #370: consult -m gemini general \"...\" was passing --yolo, allowing\n+      // Gemini to auto-approve file writes in the main worktree. General mode\n+      // consultations must be read-only.\n+      vi.resetModules();\n+\n+      fs.mkdirSync(path.join(testBaseDir, 'codev', 'roles'), { recursive: true });\n+      fs.writeFileSync(\n+        path.join(testBaseDir, 'codev', 'roles', 'consultant.md'),\n+        '# Consultant Role'\n+      );\n+      process.chdir(testBaseDir);\n+\n+      // Mock execSync so commandExists('gemini') returns true\n+      const { execSync } = await import('node:child_process');\n+      vi.mocked(execSync).mockImplementation((cmd: string) => {\n+        if (cmd.includes('which')) return Buffer.from('/usr/bin/gemini');\n+        return Buffer.from('');\n+      });\n+\n+      const { spawn } = await import('node:child_process');\n+      const { consult } = await import('../commands/consult/index.js');\n+\n+      await consult({ model: 'gemini', prompt: 'audit all files' });\n+\n+      // Verify spawn was called without --yolo\n+      const spawnCalls = vi.mocked(spawn).mock.calls;\n+      const geminiCall = spawnCalls.find(call => call[0] === 'gemini');\n+      expect(geminiCall).toBeDefined();\n+      const args = geminiCall![1] as string[];\n+      expect(args).not.toContain('--yolo');\n+    });\n+\n+    it('protocol mode should pass --yolo to Gemini CLI', async () => {\n+      // Protocol mode (--type) uses structured reviews where --yolo is needed\n+      // for file access during code review.\n+      vi.resetModules();\n+\n+      // Clear spawn mock calls from previous tests\n+      const { spawn: spawnBefore } = await import('node:child_process');\n+      vi.mocked(spawnBefore).mockClear();\n+\n+      fs.mkdirSync(path.join(testBaseDir, 'codev', 'roles'), { recursive: true });\n+      fs.mkdirSync(path.join(testBaseDir, 'codev', 'specs'), { recursive: true });\n+      fs.mkdirSync(path.join(testBaseDir, 'codev', 'consult-types'), { recursive: true });\n+      fs.writeFileSync(\n+        path.join(testBaseDir, 'codev', 'roles', 'consultant.md'),\n+        '# Consultant Role'\n+      );\n+      // resolveProtocolPrompt builds \"${type}-review.md\", so type 'spec' → 'spec-review.md'\n+      fs.writeFileSync(\n+        path.join(testBaseDir, 'codev', 'consult-types', 'spec-review.md'),\n+        '# Review the spec'\n+      );\n+      // resolveArchitectQuery needs a spec file matching issue number (padded to 4 digits)\n+      fs.writeFileSync(\n+        path.join(testBaseDir, 'codev', 'specs', '0001-test-feature.md'),\n+        '# Test Feature Spec'\n+      );\n+      process.chdir(testBaseDir);\n+\n+      // Mock execSync to return git info for protocol mode queries\n+      const { execSync } = await import('node:child_process');\n+      vi.mocked(execSync).mockImplementation((cmd: string) => {\n+        if (cmd.includes('which')) return Buffer.from('/usr/bin/gemini');\n+        if (cmd.includes('git')) return Buffer.from('');\n+        return Buffer.from('');\n+      });\n+\n+      const { spawn } = await import('node:child_process');\n+      const { consult } = await import('../commands/consult/index.js');\n+\n+      // type 'spec' resolves to template 'spec-review.md'\n+      // --issue required from architect context\n+      await consult({ model: 'gemini', type: 'spec', issue: '1' });\n+\n+      // Verify spawn was called WITH --yolo\n+      const spawnCalls = vi.mocked(spawn).mock.calls;\n+      const geminiCall = spawnCalls.find(call => call[0] === 'gemini');\n+      expect(geminiCall).toBeDefined();\n+      const args = geminiCall![1] as string[];\n+      expect(args).toContain('--yolo');\n+    });\n+  });\n+\n   describe('diff stat approach (Bugfix #240)', () => {\n     it('should export getDiffStat for file-based review', async () => {\n       vi.resetModules();\ndiff --git a/packages/codev/src/commands/consult/index.ts b/packages/codev/src/commands/consult/index.ts\nindex 88226324..61218694 100644\n--- a/packages/codev/src/commands/consult/index.ts\n+++ b/packages/codev/src/commands/consult/index.ts\n@@ -26,7 +26,7 @@ interface ModelConfig {\n }\n \n const MODEL_CONFIGS: Record<string, ModelConfig> = {\n-  gemini: { cli: 'gemini', args: ['--yolo'], envVar: 'GEMINI_SYSTEM_MD' },\n+  gemini: { cli: 'gemini', args: [], envVar: 'GEMINI_SYSTEM_MD' },\n };\n \n // Models that use an Agent SDK instead of CLI subprocess\n@@ -526,6 +526,7 @@ async function runConsultation(\n   role: string,\n   outputPath?: string,\n   metricsCtx?: MetricsContext,\n+  generalMode?: boolean,\n ): Promise<void> {\n   // SDK-based models\n   if (model === 'claude') {\n@@ -568,7 +569,10 @@ async function runConsultation(\n     env['GEMINI_SYSTEM_MD'] = tempFile;\n \n     // No --output-format json — let Gemini output text directly\n-    cmd = [config.cli, ...config.args, query];\n+    // Only use --yolo in protocol mode (structured reviews).\n+    // General mode must NOT use --yolo to prevent unintended file writes (#370).\n+    const yoloArgs = generalMode ? [] : ['--yolo'];\n+    cmd = [config.cli, ...yoloArgs, ...config.args, query];\n   } else {\n     throw new Error(`Unknown model: ${model}`);\n   }\n@@ -1294,7 +1298,8 @@ export async function consult(options: ConsultOptions): Promise<void> {\n   console.error('='.repeat(60));\n   console.error('');\n \n-  await runConsultation(model, query, workspaceRoot, role, options.output, metricsCtx);\n+  const isGeneralMode = !hasType;\n+  await runConsultation(model, query, workspaceRoot, role, options.output, metricsCtx, isGeneralMode);\n }\n \n // Exported for testing\n"
test_patch: ''
fail_to_pass:
- cd packages/codev && npm install --ignore-scripts && npm test -- src/__tests__/gemini-yolo.test.ts
pass_to_pass:
- cd packages/codev && npm test -- src/__tests__/bugfix-280-consult-diff.test.ts
install_config:
  install: npm install
  node: '20'
  test_cmd: npm test
meta:
  added_lines: '98'
  difficulty: medium
  files_changed: '2'
  pr_title: '[Bugfix #370] Fix Gemini --yolo mode in general consultations'
  removed_lines: '4'
  source: gh-archive-pr
  test_files: '[{"path":"packages/codev/src/__tests__/gemini-yolo.test.ts","content":"/**\n * Tests for Gemini yolo flag handling in consult command\n */\n\nimport { describe, it, expect, beforeEach, afterEach, vi } from ''vitest'';\nimport * as fs from ''node:fs'';\nimport * as path from ''node:path'';\nimport { tmpdir } from ''node:os'';\n\n// Mock child_process\nvi.mock(''node:child_process'', () => ({\n  spawn: vi.fn(() => ({\n    stdout: {\n      on: vi.fn(),\n    },\n    on: vi.fn((event: string, callback: (code: number) => void) => {\n      if (event === ''close'') callback(0);\n    }),\n  })),\n  execSync: vi.fn((cmd: string) => {\n    if (cmd.includes(''which gemini'')) {\n      return Buffer.from(''/usr/bin/gemini'');\n    }\n    return Buffer.from('''');\n  }),\n}));\n\n// Mock chalk\nvi.mock(''chalk'', () => ({\n  default: {\n    bold: (s: string) => s,\n    green: (s: string) => s,\n    yellow: (s: string) => s,\n    red: (s: string) => s,\n    blue: (s: string) => s,\n    dim: (s: string) => s,\n  },\n}));\n\ndescribe(''Gemini yolo flag handling'', () => {\n  const testBaseDir = path.join(tmpdir(), `codev-consult-yolo-test-${Date.now()}`);\n  let originalCwd: string;\n\n  beforeEach(() => {\n    originalCwd = process.cwd();\n    fs.mkdirSync(testBaseDir, { recursive: true });\n    vi.spyOn(console, ''error'').mockImplementation(() => {});\n  });\n\n  afterEach(() => {\n    process.chdir(originalCwd);\n    vi.restoreAllMocks();\n    if (fs.existsSync(testBaseDir)) {\n      fs.rmSync(testBaseDir, { recursive: true });\n    }\n  });\n\n  it(''general mode should not pass --yolo to Gemini'', async () => {\n    vi.resetModules();\n\n    fs.mkdirSync(path.join(testBaseDir, ''codev'', ''roles''), { recursive: true });\n    fs.writeFileSync(\n      path.join(testBaseDir, ''codev'', ''roles'', ''consultant.md''),\n      ''# Consultant Role''\n    );\n\n    process.chdir(testBaseDir);\n\n    const { spawn } = await import(''node:child_process'');\n    vi.mocked(spawn).mockClear();\n    const { consult } = await import(''../commands/consult/index.js'');\n\n    const prompt = ''summarize risk hotspots in the repo'';\n    await consult({ model: ''gemini'', prompt });\n\n    const spawnCalls = vi.mocked(spawn).mock.calls;\n    const geminiCall = spawnCalls.find(call => call[0] === ''gemini'');\n    expect(geminiCall).toBeDefined();\n\n    const args = geminiCall![1] as string[];\n    expect(args).not.toContain(''--yolo'');\n    expect(args[args.length - 1]).toContain(prompt);\n  });\n\n  it(''protocol mode should pass --yolo to Gemini'', async () => {\n    vi.resetModules();\n\n    fs.mkdirSync(path.join(testBaseDir, ''codev'', ''roles''), { recursive: true });\n    fs.mkdirSync(path.join(testBaseDir, ''codev'', ''protocols'', ''rapid'', ''consult-types''), { recursive: true });\n    fs.mkdirSync(path.join(testBaseDir, ''codev'', ''specs''), { recursive: true });\n\n    fs.writeFileSync(\n      path.join(testBaseDir, ''codev'', ''roles'', ''consultant.md''),\n      ''# Consultant Role''\n    );\n    fs.writeFileSync(\n      path.join(testBaseDir, ''codev'', ''protocols'', ''rapid'', ''consult-types'', ''spec-review.md''),\n      ''# Rapid review instructions''\n    );\n    fs.writeFileSync(\n      path.join(testBaseDir, ''codev'', ''specs'', ''0007-bright-idea.md''),\n      ''# Bright Idea Spec''\n    );\n\n    process.chdir(testBaseDir);\n\n    const { spawn } = await import(''node:child_process'');\n    vi.mocked(spawn).mockClear();\n    const { consult } = await import(''../commands/consult/index.js'');\n\n    await consult({ model: ''gemini'', protocol: ''rapid'', type: ''spec'', issue: ''7'' });\n\n    const spawnCalls = vi.mocked(spawn).mock.calls;\n    const geminiCall = spawnCalls.find(call => call[0] === ''gemini'');\n    expect(geminiCall).toBeDefined();\n\n    const args = geminiCall![1] as string[];\n    expect(args).toContain(''--yolo'');\n    expect(args[args.length - 1]).toContain(''Review Specification'');\n  });\n});\n"}]'
  test_generation: agentic-docker
prompt: |-
  cluesmith/codev (#371): [Bugfix #370] Fix Gemini --yolo mode in general consultations

  Prevent Gemini general consultations from receiving elevated file-write access. Ensure the general mode invocation does not pass any flag that enables auto-approval or write permissions, while protocol/typed consultations still include the flag needed for structured reviews with file access. Update behavior so only protocol mode gets write access and general mode remains read-only.
original_pr_body: |-
  cluesmith/codev (#371): [Bugfix #370] Fix Gemini --yolo mode in general consultations

  ## Summary
  Fixes #370

  ## Root Cause
  `MODEL_CONFIGS` hardcoded `args: ['--yolo']` for Gemini, passing it unconditionally to both general mode (`--prompt`) and protocol mode (`--type`). In general mode, this gave Gemini full write access via auto-approval, allowing it to silently modify files in the main worktree.

  ## Fix
  - Removed `--yolo` from `MODEL_CONFIGS.gemini.args` (now `[]`)
  - Added `generalMode` parameter to `runConsultation()`
  - `--yolo` is now only passed in protocol mode (when `--type` is set), where structured reviews need file access
  - General mode consultations no longer get write access

  ## Test Plan
  - [x] Added regression test: general mode does NOT pass `--yolo` to Gemini CLI
  - [x] Added regression test: protocol mode DOES pass `--yolo` to Gemini CLI
  - [x] Updated existing model config test to reflect new default
  - [x] All 37 consult tests pass
  - [x] Build succeeds
  - [x] Full test suite passes (1 pre-existing flaky test in `send-integration.test.ts` — unrelated)
quality_score: 0.5
quality_passed: true
docker_passed: false
workspace_path: null
status: ready
