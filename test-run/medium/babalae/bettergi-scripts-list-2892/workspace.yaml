id: babalae/bettergi-scripts-list-2892
repo: babalae/bettergi-scripts-list
base_commit: 16241cb9aa06baa551dda5d26a1d1d64aa2b3944
merge_commit: bd88d115f674e375cad546c721779c5b0b7d8e95
language: javascript
difficulty_score: 2
created_at: 2026-02-17T09:30:29.586246201Z
patch: "diff --git \"a/repo/js/\\350\\207\\252\\345\\212\\250\\350\\264\\255\\344\\271\\260\\346\\257\\217\\345\\244\\251&3\\345\\244\\251&\\346\\257\\217\\345\\221\\250\\345\\210\\267\\346\\226\\260\\345\\225\\206\\345\\223\\201/README.md\" \"b/repo/js/\\350\\207\\252\\345\\212\\250\\350\\264\\255\\344\\271\\260\\346\\257\\217\\345\\244\\251&3\\345\\244\\251&\\346\\257\\217\\345\\221\\250\\345\\210\\267\\346\\226\\260\\345\\225\\206\\345\\223\\201/README.md\"\nindex ba1b4e215..ddbaa4481 100644\n--- \"a/repo/js/\\350\\207\\252\\345\\212\\250\\350\\264\\255\\344\\271\\260\\346\\257\\217\\345\\244\\251&3\\345\\244\\251&\\346\\257\\217\\345\\221\\250\\345\\210\\267\\346\\226\\260\\345\\225\\206\\345\\223\\201/README.md\"\n+++ \"b/repo/js/\\350\\207\\252\\345\\212\\250\\350\\264\\255\\344\\271\\260\\346\\257\\217\\345\\244\\251&3\\345\\244\\251&\\346\\257\\217\\345\\221\\250\\345\\210\\267\\346\\226\\260\\345\\225\\206\\345\\223\\201/README.md\"\n@@ -45,20 +45,16 @@\n      - 周一刷新商品\r\n      - 周四刷新商品\r\n    - **每月1号刷新商品**：不受此设置影响，刷新即购买\r\n-4. **要禁用的商人**：不想购买的商人，用空格分隔\r\n+4. **禁用标签功能**：可以输入要禁用的标签（空格分隔），如：\r\n    ```\r\n-   示例：阿扎莱 皮托\r\n-   ```\r\n-5. **禁用标签功能**：可以输入要禁用的标签（空格分隔），如：\r\n-   ```\r\n-   示例：黑心商人 挪德卡莱\r\n+   示例：黑心商人 挪德卡莱 卡琵莉亚\r\n    ```\r\n    禁用后，脚本会跳过这些商人或带有指定标签的商人，不会前往购买。\r\n    \r\n    可以使用国家/地区（如\"蒙德\"、\"璃月\"）或其他标签(如商人信息总览中的标签)\r\n-6. **是否跳过调整时间动画**：开启后会啟用时瞬跳过调整时间动画\r\n-7. **无视购买记录强制购买**：开启后会忽略购买记录，重新购买所有商品\r\n-8. **调试模式**：开启后显示详细执行日志\r\n+5. **是否跳过调整时间动画**：开启后会啟用时瞬跳过调整时间动画\r\n+6. **无视购买记录强制购买**：开启后会忽略购买记录，重新购买所有商品\r\n+7. **调试模式**：开启后显示详细执行日志\r\n \r\n ### 购买记录系统说明\r\n 脚本会自动记录购买时间，避免重复购买：\r\n@@ -106,7 +102,7 @@\n | 璃月-石门 | 老周叔 | 大碗茶 | - | - | 稀少商品 |\r\n | 璃月-轻策庄 | 小白 | - | 豆腐、杏仁、霓裳花 | - | 琉璃百合(每月刷新) |\r\n | 璃月-轻策庄 | 凯叔 | 大碗茶 | - | - | 稀少商品 |\r\n-| 璃月-遗珑埠 | 丰泰 | - | 沉玉仙茗、琉璃袋、绝云椒椒 | 蟹黄 |  |\r\n+| 璃月-遗珑埠 | 丰泰 | 稻米、豆腐 | 清水玉、石珀、夜泊石、琉璃袋、霓裳花、绝云椒椒、沉玉仙茗 | 蟹黄 |  |\r\n | 璃月-遗珑埠 | 连芳 | - | 沉玉仙茗 | - |  |\r\n | 稻妻-离岛 | 小畑 | 螃蟹、鱼肉、虾仁 | 海灵芝 | - |  |\r\n | 稻妻-离岛 | 秋月 | 铁块、白铁块、电气水晶 | - | - |  |\r\n@@ -151,10 +147,11 @@\n | 挪德卡莱-那夏镇 | 雷科 | - | - | 幸运儿之杯、幸运儿鹰羽、幸运儿银冠、幸运儿绿花、幸运儿沙漏 | 狗粮商人 |\r\n | 挪德卡莱-皮拉米达城 | 科菲策 | 牛奶、咖啡豆 | 微光角菌、琉鳞石 | - | 黑心商人 |\r\n \r\n-- **国家标签**：蒙德、璃月、稻妻、须弥、枫丹、纳塔、挪德卡莱\r\n-- **地区标签**：风起地、清泉镇、蒙德城、璃月港、离岛、稻妻城、海祇岛等\r\n-- **小地图标签**：天使的馈赠、兰巴德酒馆、德波大饭店、灰河、锈舵酒馆等\r\n-- **商人标签**：克罗丽丝、神奇的霍普金斯、杜拉夫等（所有商人名）\r\n+### **以下为有效标签**\r\n+- **国家**：蒙德、璃月、稻妻、须弥、枫丹、纳塔、挪德卡莱\r\n+- **地区**：风起地、清泉镇、蒙德城、璃月港、离岛、稻妻城、海祇岛等\r\n+- **小地图**：天使的馈赠、兰巴德酒馆、德波大饭店、灰河、锈舵酒馆等\r\n+- **商人**：克罗丽丝、神奇的霍普金斯、杜拉夫等（所有商人名）\r\n - **移动**：指商人会移动，有机会购买失败\r\n - **稀少商品**：指稀少商品\r\n - **独立地图**：指需要进入独立空间的特殊地图，这些地图部份路径无法使用地图追踪功能\r\ndiff --git \"a/repo/js/\\350\\207\\252\\345\\212\\250\\350\\264\\255\\344\\271\\260\\346\\257\\217\\345\\244\\251&3\\345\\244\\251&\\346\\257\\217\\345\\221\\250\\345\\210\\267\\346\\226\\260\\345\\225\\206\\345\\223\\201/assets/images/\\346\\270\\205\\346\\260\\264\\347\\216\\211.png\" \"b/repo/js/\\350\\207\\252\\345\\212\\250\\350\\264\\255\\344\\271\\260\\346\\257\\217\\345\\244\\251&3\\345\\244\\251&\\346\\257\\217\\345\\221\\250\\345\\210\\267\\346\\226\\260\\345\\225\\206\\345\\223\\201/assets/images/\\346\\270\\205\\346\\260\\264\\347\\216\\211.png\"\nnew file mode 100644\nindex 000000000..c2a65f6b3\nBinary files /dev/null and \"b/repo/js/\\350\\207\\252\\345\\212\\250\\350\\264\\255\\344\\271\\260\\346\\257\\217\\345\\244\\251&3\\345\\244\\251&\\346\\257\\217\\345\\221\\250\\345\\210\\267\\346\\226\\260\\345\\225\\206\\345\\223\\201/assets/images/\\346\\270\\205\\346\\260\\264\\347\\216\\211.png\" differ\ndiff --git \"a/repo/js/\\350\\207\\252\\345\\212\\250\\350\\264\\255\\344\\271\\260\\346\\257\\217\\345\\244\\251&3\\345\\244\\251&\\346\\257\\217\\345\\221\\250\\345\\210\\267\\346\\226\\260\\345\\225\\206\\345\\223\\201/assets/npcs.json\" \"b/repo/js/\\350\\207\\252\\345\\212\\250\\350\\264\\255\\344\\271\\260\\346\\257\\217\\345\\244\\251&3\\345\\244\\251&\\346\\257\\217\\345\\221\\250\\345\\210\\267\\346\\226\\260\\345\\225\\206\\345\\223\\201/assets/npcs.json\"\nindex ca3899e3e..2a9a64dc6 100644\n--- \"a/repo/js/\\350\\207\\252\\345\\212\\250\\350\\264\\255\\344\\271\\260\\346\\257\\217\\345\\244\\251&3\\345\\244\\251&\\346\\257\\217\\345\\221\\250\\345\\210\\267\\346\\226\\260\\345\\225\\206\\345\\223\\201/assets/npcs.json\"\n+++ \"b/repo/js/\\350\\207\\252\\345\\212\\250\\350\\264\\255\\344\\271\\260\\346\\257\\217\\345\\244\\251&3\\345\\244\\251&\\346\\257\\217\\345\\221\\250\\345\\210\\267\\346\\226\\260\\345\\225\\206\\345\\223\\201/assets/npcs.json\"\n@@ -227,7 +227,8 @@\n \t\t\"page\": 2,\n \t\t\"time\": \"any\",\n \t\t\"path\": \"assets/path/璃月-遗珑埠-丰泰.json\",\n-\t\t\"_3d_foods\": [\"沉玉仙茗\", \"琉璃袋\", \"绝云椒椒\"],\n+\t\t\"_1d_foods\": [\"稻米\",\"豆腐\"],\n+\t\t\"_3d_foods\": [ \"清水玉\",\"石珀\",\"夜泊石\",\"琉璃袋\", \"霓裳花\", \"绝云椒椒\",\"沉玉仙茗\"],\n \t\t\"_7d_foods\": [\"蟹黄\"],\n \t\t\"tags\": [\"璃月\", \"遗珑埠\", \"丰泰\"]\n \t},\ndiff --git \"a/repo/js/\\350\\207\\252\\345\\212\\250\\350\\264\\255\\344\\271\\260\\346\\257\\217\\345\\244\\251&3\\345\\244\\251&\\346\\257\\217\\345\\221\\250\\345\\210\\267\\346\\226\\260\\345\\225\\206\\345\\223\\201/assets/path/\\350\\222\\231\\345\\276\\267-\\350\\222\\231\\345\\276\\267\\345\\237\\216-\\345\\244\\251\\344\\275\\277\\347\\232\\204\\351\\246\\210\\350\\265\\240-\\346\\237\\245\\345\\260\\224\\346\\226\\257.json\" \"b/repo/js/\\350\\207\\252\\345\\212\\250\\350\\264\\255\\344\\271\\260\\346\\257\\217\\345\\244\\251&3\\345\\244\\251&\\346\\257\\217\\345\\221\\250\\345\\210\\267\\346\\226\\260\\345\\225\\206\\345\\223\\201/assets/path/\\350\\222\\231\\345\\276\\267-\\350\\222\\231\\345\\276\\267\\345\\237\\216-\\345\\244\\251\\344\\275\\277\\347\\232\\204\\351\\246\\210\\350\\265\\240-\\346\\237\\245\\345\\260\\224\\346\\226\\257.json\"\nindex 31cfb3f40..d0846c479 100644\n--- \"a/repo/js/\\350\\207\\252\\345\\212\\250\\350\\264\\255\\344\\271\\260\\346\\257\\217\\345\\244\\251&3\\345\\244\\251&\\346\\257\\217\\345\\221\\250\\345\\210\\267\\346\\226\\260\\345\\225\\206\\345\\223\\201/assets/path/\\350\\222\\231\\345\\276\\267-\\350\\222\\231\\345\\276\\267\\345\\237\\216-\\345\\244\\251\\344\\275\\277\\347\\232\\204\\351\\246\\210\\350\\265\\240-\\346\\237\\245\\345\\260\\224\\346\\226\\257.json\"\n+++ \"b/repo/js/\\350\\207\\252\\345\\212\\250\\350\\264\\255\\344\\271\\260\\346\\257\\217\\345\\244\\251&3\\345\\244\\251&\\346\\257\\217\\345\\221\\250\\345\\210\\267\\346\\226\\260\\345\\225\\206\\345\\223\\201/assets/path/\\350\\222\\231\\345\\276\\267-\\350\\222\\231\\345\\276\\267\\345\\237\\216-\\345\\244\\251\\344\\275\\277\\347\\232\\204\\351\\246\\210\\350\\265\\240-\\346\\237\\245\\345\\260\\224\\346\\226\\257.json\"\n@@ -9,7 +9,7 @@\n     \"bgi_version\": \"0.45.0\",\n     \"description\": \"\",\n     \"enable_monster_loot_split\": false,\n-    \"last_modified_time\": 1771248205039,\n+    \"last_modified_time\": 1771299801495,\n     \"map_match_method\": \"\",\n     \"map_name\": \"Teyvat\",\n     \"name\": \"蒙德-蒙德城-天使的馈赠-查尔斯\",\n@@ -49,6 +49,15 @@\n       \"action\": \"\",\n       \"action_params\": \"\",\n       \"id\": 4,\n+      \"move_mode\": \"walk\",\n+      \"type\": \"path\",\n+      \"x\": -894.005859375,\n+      \"y\": 2319.78125\n+    },\n+    {\n+      \"action\": \"\",\n+      \"action_params\": \"\",\n+      \"id\": 5,\n       \"move_mode\": \"run\",\n       \"type\": \"path\",\n       \"x\": -908.830078125,\n@@ -57,7 +66,7 @@\n     {\n       \"action\": \"\",\n       \"action_params\": \"\",\n-      \"id\": 5,\n+      \"id\": 6,\n       \"move_mode\": \"dash\",\n       \"type\": \"path\",\n       \"x\": -921.044921875,\n@@ -66,7 +75,7 @@\n     {\n       \"action\": \"\",\n       \"action_params\": \"\",\n-      \"id\": 6,\n+      \"id\": 7,\n       \"move_mode\": \"walk\",\n       \"type\": \"path\",\n       \"x\": -923.63671875,\n@@ -75,7 +84,7 @@\n     {\n       \"action\": \"\",\n       \"action_params\": \"\",\n-      \"id\": 7,\n+      \"id\": 8,\n       \"move_mode\": \"dash\",\n       \"type\": \"path\",\n       \"x\": -930.8125,\n@@ -84,7 +93,7 @@\n     {\n       \"action\": \"\",\n       \"action_params\": \"\",\n-      \"id\": 8,\n+      \"id\": 9,\n       \"move_mode\": \"walk\",\n       \"type\": \"path\",\n       \"x\": -934.296875,\n@@ -93,7 +102,7 @@\n     {\n       \"action\": \"\",\n       \"action_params\": \"\",\n-      \"id\": 9,\n+      \"id\": 10,\n       \"move_mode\": \"walk\",\n       \"type\": \"path\",\n       \"x\": -933.291015625,\n@@ -102,7 +111,7 @@\n     {\n       \"action\": \"combat_script\",\n       \"action_params\": \"wait(0.5),keypress(F),wait(0.2),keypress(F),wait(0.2),keypress(F),wait(7.5),keydown(a),keypress(SPACE),wait(0.5),keypress(SPACE),wait(0.5),keypress(SPACE),wait(0.5),keypress(SPACE),wait(0.5),keyup(a),wait(0.5),s(0.5),wait(0.5),d(2),wait(0.5),w(0.8),wait(0.5),a(0.5),wait(1.5)\",\n-      \"id\": 10,\n+      \"id\": 11,\n       \"move_mode\": \"walk\",\n       \"type\": \"target\",\n       \"x\": -929.392578125,\ndiff --git \"a/repo/js/\\350\\207\\252\\345\\212\\250\\350\\264\\255\\344\\271\\260\\346\\257\\217\\345\\244\\251&3\\345\\244\\251&\\346\\257\\217\\345\\221\\250\\345\\210\\267\\346\\226\\260\\345\\225\\206\\345\\223\\201/main.js\" \"b/repo/js/\\350\\207\\252\\345\\212\\250\\350\\264\\255\\344\\271\\260\\346\\257\\217\\345\\244\\251&3\\345\\244\\251&\\346\\257\\217\\345\\221\\250\\345\\210\\267\\346\\226\\260\\345\\225\\206\\345\\223\\201/main.js\"\nindex ec9e185ad..c17a947dd 100644\n--- \"a/repo/js/\\350\\207\\252\\345\\212\\250\\350\\264\\255\\344\\271\\260\\346\\257\\217\\345\\244\\251&3\\345\\244\\251&\\346\\257\\217\\345\\221\\250\\345\\210\\267\\346\\226\\260\\345\\225\\206\\345\\223\\201/main.js\"\n+++ \"b/repo/js/\\350\\207\\252\\345\\212\\250\\350\\264\\255\\344\\271\\260\\346\\257\\217\\345\\244\\251&3\\345\\244\\251&\\346\\257\\217\\345\\221\\250\\345\\210\\267\\346\\226\\260\\345\\225\\206\\345\\223\\201/main.js\"\n@@ -111,6 +111,9 @@ let npcData = {};\n \r\n // 存储用户要购买的商品名称集合（中文名）\r\n let userFoodsToBuy = new Set();\r\n+let userTagsToBuy = new Set();    // 标签名\r\n+let allTags = new Set();          // 所有可用标签（从 npcs.json 收集）\r\n+let requiredFoods = new Set();  // 所有需要加载图片的商品\r\n \r\n async function loadExternalData() {\r\n     try {\r\n@@ -119,25 +122,61 @@ async function loadExternalData() {\n         npcData = JSON.parse(npcsContent);\r\n         logConditional(`已加载商人数据: ${Object.keys(npcData).length} 个商人`);\r\n \r\n-        // 解析用户要购买的商品列表（中文商品名，空格分隔）\r\n+        // ========== 收集所有标签 ==========\r\n+        for (let key in npcData) {\r\n+            let npc = npcData[key];\r\n+            if (npc.tags && Array.isArray(npc.tags)) {\r\n+                npc.tags.forEach(tag => allTags.add(tag));\r\n+            }\r\n+        }\r\n+        logConditional(`共收集到 ${allTags.size} 个标签`);\r\n+\r\n+        // ========== 解析用户输入 ==========\r\n         const foodsInput = (settings.foodsToBuy || \"\").trim();\r\n         if (foodsInput) {\r\n-            const foodNames = foodsInput.split(/[,\\s、]+/).filter(name => name.trim() !== \"\");\r\n+            const items = foodsInput.split(/[,\\s、]+/).filter(item => item.trim() !== \"\");\r\n             const enabledFoodsList = [];\r\n-            for (const foodName of foodNames) {\r\n-                // 直接使用用户输入的商品名，不需要验证是否存在（由用户自行确保）\r\n-                userFoodsToBuy.add(foodName);\r\n-                enabledFoodsList.push(foodName);\r\n+            const enabledTagsList = [];\r\n+\r\n+            for (const item of items) {\r\n+                if (allTags.has(item)) {\r\n+                    // 是标签\r\n+                    userTagsToBuy.add(item);\r\n+                    enabledTagsList.push(item);\r\n+                } else {\r\n+                    // 视为商品名\r\n+                    userFoodsToBuy.add(item);\r\n+                    enabledFoodsList.push(item);\r\n+                }\r\n+            }\r\n+\r\n+            // 输出用户启用的标签和商品\r\n+            if (enabledTagsList.length > 0) {\r\n+                log.info(`用户启用了以下标签: ${enabledTagsList.join(\", \")}`);\r\n             }\r\n-            // 输出用户启用的商品列表\r\n             if (enabledFoodsList.length > 0) {\r\n-                log.info(`用户启用了下列商品: ${enabledFoodsList.join(\", \")}`);\r\n-            } else {\r\n-                log.warn(\"用户未启用任何商品\");\r\n+                log.info(`用户启用了以下商品: ${enabledFoodsList.join(\", \")}`);\r\n+            }\r\n+            if (enabledTagsList.length === 0 && enabledFoodsList.length === 0) {\r\n+                log.warn(\"用户未启用任何标签或商品\");\r\n             }\r\n         } else {\r\n-            log.warn(\"用户未指定要购买的商品\");\r\n+            log.warn(\"用户未指定要购买的商品或标签\");\r\n+        }\r\n+\r\n+        // 计算所有需要加载图片的商品\r\n+        requiredFoods = new Set(userFoodsToBuy);\r\n+        for (let key in npcData) {\r\n+            let npc = npcData[key];\r\n+            if (npc.tags && Array.isArray(npc.tags) && npc.tags.some(tag => userTagsToBuy.has(tag))) {\r\n+                if (npc._1d_foods) npc._1d_foods.forEach(food => requiredFoods.add(food));\r\n+                if (npc._3d_foods) npc._3d_foods.forEach(food => requiredFoods.add(food));\r\n+                if (npc._7d_foods) npc._7d_foods.forEach(food => requiredFoods.add(food));\r\n+                if (npc._thu_foods) npc._thu_foods.forEach(food => requiredFoods.add(food));\r\n+                if (npc._month_foods) npc._month_foods.forEach(food => requiredFoods.add(food));\r\n+            }\r\n         }\r\n+        logConditional(`需要加载图片的商品总数: ${requiredFoods.size}`);\r\n \r\n         return true;\r\n     } catch (error) {\r\n@@ -146,6 +185,17 @@ async function loadExternalData() {\n     }\r\n }\r\n \r\n+// ==================== 辅助函数：获取商人的所有商品 ====================\r\n+function getAllNpcFoods(npc) {\r\n+    const all = [];\r\n+    if (npc._1d_foods) all.push(...npc._1d_foods);\r\n+    if (npc._3d_foods) all.push(...npc._3d_foods);\r\n+    if (npc._7d_foods) all.push(...npc._7d_foods);\r\n+    if (npc._thu_foods) all.push(...npc._thu_foods);\r\n+    if (npc._month_foods) all.push(...npc._month_foods);\r\n+    return all;\r\n+}\r\n+\r\n // ==================== 辅助函数：过滤用户要购买的商品 ====================\r\n function filterUserFoods(foodList) {\r\n     if (!foodList || !Array.isArray(foodList)) {\r\n@@ -231,12 +281,6 @@ let userName = settings.userName || \"默认账户\";\n const ignoreRecords = settings.ignoreRecords || false;\r\n const recordDebug = settings.recordDebug || false;\r\n \r\n-// 解析禁用的商人列表\r\n-const disabledNpcs = (settings.disabledNpcs || \"\").split(/[,\\s、]+/).filter(npc => npc.trim() !== \"\");\r\n-if (disabledNpcs.length > 0) {\r\n-    log.info(`已禁用商人: ${disabledNpcs.join(\", \")}`);\r\n-}\r\n-\r\n // 解析禁用的标签列表\r\n const disabledTags = (settings.disabledTags || \"\").split(/[,\\s、]+/).filter(tag => tag.trim() !== \"\");\r\n if (disabledTags.length > 0) {\r\n@@ -457,54 +501,71 @@ function shouldBuyFoods(npc, npcRecord, currentPeriod, forceRefresh = false) {\n         \"month\": []\r\n     };\r\n \r\n+    // 首先检查禁用（此处假设之前已检查过，但为防止遗漏，可再加一道保险）\r\n+    // 实际上禁用检查在更外层（initNpcData 和主循环）已经处理，这里可以省略\r\n+\r\n     if (forceRefresh) {\r\n-        // 强制刷新：所有启用商品都尝试\r\n-        if (npc._1d_foods) foodsToBuy[\"1d\"] = filterUserFoods(npc._1d_foods);\r\n-        if (npc._3d_foods) foodsToBuy[\"3d\"] = filterUserFoods(npc._3d_foods);\r\n-        if (npc._7d_foods) foodsToBuy[\"7d\"] = filterUserFoods(npc._7d_foods);\r\n-        if (npc._thu_foods) foodsToBuy[\"thu\"] = filterUserFoods(npc._thu_foods);\r\n-        if (npc._month_foods) foodsToBuy[\"month\"] = filterUserFoods(npc._month_foods);\r\n+        // 强制刷新：决定使用完整列表还是具体商品列表\r\n+        // 先判断是否命中标签\r\n+        let useAll = false;\r\n+        if (npc.tags && Array.isArray(npc.tags)) {\r\n+            useAll = npc.tags.some(tag => userTagsToBuy.has(tag));\r\n+        }\r\n+        if (useAll) {\r\n+            // 标签商人：购买所有商品\r\n+            if (npc._1d_foods) foodsToBuy[\"1d\"] = npc._1d_foods;\r\n+            if (npc._3d_foods) foodsToBuy[\"3d\"] = npc._3d_foods;\r\n+            if (npc._7d_foods) foodsToBuy[\"7d\"] = npc._7d_foods;\r\n+            if (npc._thu_foods) foodsToBuy[\"thu\"] = npc._thu_foods;\r\n+            if (npc._month_foods) foodsToBuy[\"month\"] = npc._month_foods;\r\n+        } else {\r\n+            // 非标签商人：只购买用户明确指定的商品\r\n+            if (npc._1d_foods) foodsToBuy[\"1d\"] = filterUserFoods(npc._1d_foods);\r\n+            if (npc._3d_foods) foodsToBuy[\"3d\"] = filterUserFoods(npc._3d_foods);\r\n+            if (npc._7d_foods) foodsToBuy[\"7d\"] = filterUserFoods(npc._7d_foods);\r\n+            if (npc._thu_foods) foodsToBuy[\"thu\"] = filterUserFoods(npc._thu_foods);\r\n+            if (npc._month_foods) foodsToBuy[\"month\"] = filterUserFoods(npc._month_foods);\r\n+        }\r\n         return foodsToBuy;\r\n     }\r\n \r\n-    // 辅助函数：处理单个刷新类型\r\n-    function processType(type, enabledFoods, refreshLogic) {\r\n-        if (!enabledFoods || enabledFoods.length === 0) return [];\r\n+    // 辅助函数：处理单个类型，根据是否命中标签决定使用完整列表还是过滤列表\r\n+    function processType(type, fullList) {\r\n+        if (!fullList || fullList.length === 0) return [];\r\n+\r\n+        // 判断该商人是否命中用户标签（只需判断一次，可在外层缓存结果）\r\n+        // 此处简单处理：每次调用都判断，但实际可优化\r\n+        let useAll = false;\r\n+        if (npc.tags && Array.isArray(npc.tags)) {\r\n+            useAll = npc.tags.some(tag => userTagsToBuy.has(tag));\r\n+        }\r\n \r\n-        // 获取已购买列表（如果记录存在）\r\n+        // 确定要购买的候选商品列表\r\n+        let candidateList = useAll ? fullList : filterUserFoods(fullList);\r\n+        if (candidateList.length === 0) return [];\r\n+\r\n+        // 获取已购买列表\r\n         const purchasedList = npcRecord && npcRecord[type] ? npcRecord[type] : [];\r\n         // 找出未购买的商品\r\n-        const notPurchased = enabledFoods.filter(food => !purchasedList.includes(food));\r\n+        const notPurchased = candidateList.filter(food => !purchasedList.includes(food));\r\n \r\n-        // 如果没有记录或没有刷新时间，说明从未买过，全部尝试\r\n         if (!npcRecord || !npcRecord[`${type}_time`]) {\r\n-            return enabledFoods;\r\n+            return candidateList; // 从未买过，全部尝试\r\n         }\r\n \r\n         const nextRefreshTime = new Date(npcRecord[`${type}_time`]);\r\n         if (now >= nextRefreshTime) {\r\n-            // 已到刷新时间：所有商品都应重新尝试（已购买和未购买的都可能再次出现）\r\n-            return enabledFoods;\r\n+            return candidateList; // 已刷新，全部尝试\r\n         } else {\r\n-            // 未到刷新时间：只尝试从未购买过的商品\r\n-            return notPurchased;\r\n+            return notPurchased;   // 未刷新，只尝试未购买过的\r\n         }\r\n     }\r\n \r\n-    // 处理每天刷新商品\r\n-    foodsToBuy[\"1d\"] = processType(\"1d\", filterUserFoods(npc._1d_foods));\r\n-\r\n-    // 处理3天刷新商品\r\n-    foodsToBuy[\"3d\"] = processType(\"3d\", filterUserFoods(npc._3d_foods));\r\n-\r\n-    // 处理7天刷新商品（周一刷新）\r\n-    foodsToBuy[\"7d\"] = processType(\"7d\", filterUserFoods(npc._7d_foods));\r\n-\r\n-    // 处理周四刷新商品\r\n-    foodsToBuy[\"thu\"] = processType(\"thu\", filterUserFoods(npc._thu_foods));\r\n-\r\n-    // 处理每月刷新商品\r\n-    foodsToBuy[\"month\"] = processType(\"month\", filterUserFoods(npc._month_foods));\r\n+    foodsToBuy[\"1d\"] = processType(\"1d\", npc._1d_foods);\r\n+    foodsToBuy[\"3d\"] = processType(\"3d\", npc._3d_foods);\r\n+    foodsToBuy[\"7d\"] = processType(\"7d\", npc._7d_foods);\r\n+    foodsToBuy[\"thu\"] = processType(\"thu\", npc._thu_foods);\r\n+    foodsToBuy[\"month\"] = processType(\"month\", npc._month_foods);\r\n \r\n     return foodsToBuy;\r\n }\r\n@@ -719,8 +780,7 @@ let foodROMap = {}; // 键为商品名（中文），值为 RecognitionObject\n // 加载识别对象（只加载用户选择的商品）\r\n async function initRo() {\r\n     try {\r\n-        for (let foodName of userFoodsToBuy) {\r\n-            // 图片文件路径：assets/images/商品名.png\r\n+        for (let foodName of requiredFoods) {\r\n             const imagePath = `assets/images/${foodName}.png`;\r\n             try {\r\n                 const ro = RecognitionObject.TemplateMatch(file.ReadImageMatSync(imagePath));\r\n@@ -732,13 +792,11 @@ async function initRo() {\n                 log.error(`加载商品图片失败: ${imagePath}，请确保图片存在`);\r\n             }\r\n         }\r\n-        // 加载其他识别对象（购买按钮等）\r\n         for (let [key, item] of Object.entries(othrtRo)) {\r\n             item.ro = RecognitionObject.TemplateMatch(file.ReadImageMatSync(item.file));\r\n             item.ro.Threshold = 0.85;\r\n         }\r\n-\r\n-        logConditional(`总共启用了 ${userFoodsToBuy.size} 种商品`);\r\n+        logConditional(`总共启用了 ${requiredFoods.size} 种商品`);\r\n         return true;\r\n     }\r\n     catch (error) {\r\n@@ -915,14 +973,6 @@ async function buyFoods(npcName, npcRecords, currentPeriod) {\n // 初始化商人商品\r\n async function initNpcData(records) {\r\n     for (let [key, npc] of Object.entries(npcData)) {\r\n-        // 检查是否在禁用列表中\r\n-        if (disabledNpcs.includes(npc.name)) {\r\n-            npc.enable = false;\r\n-            const displayName = getDisplayNameFromPath(npc.path);\r\n-            logConditional(`已禁用: ${displayName}`);\r\n-            continue;\r\n-        }\r\n-\r\n         // 检查是否通过标签禁用\r\n         if (npc.tags && Array.isArray(npc.tags)) {\r\n             const hasDisabledTag = npc.tags.some(tag => disabledTags.includes(tag));\r\ndiff --git \"a/repo/js/\\350\\207\\252\\345\\212\\250\\350\\264\\255\\344\\271\\260\\346\\257\\217\\345\\244\\251&3\\345\\244\\251&\\346\\257\\217\\345\\221\\250\\345\\210\\267\\346\\226\\260\\345\\225\\206\\345\\223\\201/manifest.json\" \"b/repo/js/\\350\\207\\252\\345\\212\\250\\350\\264\\255\\344\\271\\260\\346\\257\\217\\345\\244\\251&3\\345\\244\\251&\\346\\257\\217\\345\\221\\250\\345\\210\\267\\346\\226\\260\\345\\225\\206\\345\\223\\201/manifest.json\"\nindex b16fa4ffc..e6ef9131a 100644\n--- \"a/repo/js/\\350\\207\\252\\345\\212\\250\\350\\264\\255\\344\\271\\260\\346\\257\\217\\345\\244\\251&3\\345\\244\\251&\\346\\257\\217\\345\\221\\250\\345\\210\\267\\346\\226\\260\\345\\225\\206\\345\\223\\201/manifest.json\"\n+++ \"b/repo/js/\\350\\207\\252\\345\\212\\250\\350\\264\\255\\344\\271\\260\\346\\257\\217\\345\\244\\251&3\\345\\244\\251&\\346\\257\\217\\345\\221\\250\\345\\210\\267\\346\\226\\260\\345\\225\\206\\345\\223\\201/manifest.json\"\n@@ -1,7 +1,7 @@\n {\r\n   \"manifest_version\": 1,\r\n   \"name\": \"自动购买每天&3天&每周刷新商品\",\r\n-  \"version\": \"3.2.2\",\r\n+  \"version\": \"3.2.3\",\r\n   \"description\": \"自动购买每天&3天&每周刷新商品\\n每天刷新商品：自动购买商品\\n3天刷新商品：未到刷新日不购买该商品\\n每周刷新商品：可指定每周购买商品\",\r\n   \"authors\": [\r\n     {\r\ndiff --git \"a/repo/js/\\350\\207\\252\\345\\212\\250\\350\\264\\255\\344\\271\\260\\346\\257\\217\\345\\244\\251&3\\345\\244\\251&\\346\\257\\217\\345\\221\\250\\345\\210\\267\\346\\226\\260\\345\\225\\206\\345\\223\\201/settings.json\" \"b/repo/js/\\350\\207\\252\\345\\212\\250\\350\\264\\255\\344\\271\\260\\346\\257\\217\\345\\244\\251&3\\345\\244\\251&\\346\\257\\217\\345\\221\\250\\345\\210\\267\\346\\226\\260\\345\\225\\206\\345\\223\\201/settings.json\"\nindex 64c7ac100..9d68d2473 100644\n--- \"a/repo/js/\\350\\207\\252\\345\\212\\250\\350\\264\\255\\344\\271\\260\\346\\257\\217\\345\\244\\251&3\\345\\244\\251&\\346\\257\\217\\345\\221\\250\\345\\210\\267\\346\\226\\260\\345\\225\\206\\345\\223\\201/settings.json\"\n+++ \"b/repo/js/\\350\\207\\252\\345\\212\\250\\350\\264\\255\\344\\271\\260\\346\\257\\217\\345\\244\\251&3\\345\\244\\251&\\346\\257\\217\\345\\221\\250\\345\\210\\267\\346\\226\\260\\345\\225\\206\\345\\223\\201/settings.json\"\n@@ -27,17 +27,11 @@\n         ],\r\n         \"default\": \"0\"\r\n     },\r\n-    {\r\n-        \"name\": \"disabledNpcs\",\r\n-        \"type\": \"input-text\",\r\n-        \"label\": \"要禁用的商人\\n（多个商人用空格分隔）\\n示例：阿扎莱 皮托\",\r\n-        \"default\": \"阿扎莱 皮托\"\r\n-    },\r\n     {\r\n         \"name\": \"disabledTags\",\r\n         \"type\": \"input-text\",\r\n-        \"label\": \"禁用标签\\n（多个标签以空格分隔，如：黑心商人 挪德卡莱）\",\r\n-        \"default\": \"\"\r\n+        \"label\": \"禁用标签\\n（多个标签以空格分隔，如： 挪德卡莱 黑心商人 卡琵莉亚）\",\r\n+        \"default\": \"卡琵莉亚\"\r\n     },\r\n     {\r\n         \"name\": \"skip\",\r\ndiff --git \"a/repo/js/\\350\\207\\252\\345\\212\\250\\350\\264\\255\\344\\271\\260\\346\\257\\217\\345\\244\\251&3\\345\\244\\251&\\346\\257\\217\\345\\221\\250\\345\\210\\267\\346\\226\\260\\345\\225\\206\\345\\223\\201/\\345\\225\\206\\344\\272\\272\\344\\270\\216\\345\\225\\206\\345\\223\\201\\346\\224\\257\\346\\214\\201\\350\\241\\250.md\" \"b/repo/js/\\350\\207\\252\\345\\212\\250\\350\\264\\255\\344\\271\\260\\346\\257\\217\\345\\244\\251&3\\345\\244\\251&\\346\\257\\217\\345\\221\\250\\345\\210\\267\\346\\226\\260\\345\\225\\206\\345\\223\\201/\\345\\225\\206\\344\\272\\272\\344\\270\\216\\345\\225\\206\\345\\223\\201\\346\\224\\257\\346\\214\\201\\350\\241\\250.md\"\nindex 95b42762d..08bdd294f 100644\n--- \"a/repo/js/\\350\\207\\252\\345\\212\\250\\350\\264\\255\\344\\271\\260\\346\\257\\217\\345\\244\\251&3\\345\\244\\251&\\346\\257\\217\\345\\221\\250\\345\\210\\267\\346\\226\\260\\345\\225\\206\\345\\223\\201/\\345\\225\\206\\344\\272\\272\\344\\270\\216\\345\\225\\206\\345\\223\\201\\346\\224\\257\\346\\214\\201\\350\\241\\250.md\"\n+++ \"b/repo/js/\\350\\207\\252\\345\\212\\250\\350\\264\\255\\344\\271\\260\\346\\257\\217\\345\\244\\251&3\\345\\244\\251&\\346\\257\\217\\345\\221\\250\\345\\210\\267\\346\\226\\260\\345\\225\\206\\345\\223\\201/\\345\\225\\206\\344\\272\\272\\344\\270\\216\\345\\225\\206\\345\\223\\201\\346\\224\\257\\346\\214\\201\\350\\241\\250.md\"\n@@ -29,7 +29,7 @@\n | 璃月-石门 | 老周叔 | 大碗茶 | - | - | 稀少商品 |\n | 璃月-轻策庄 | 小白 | - | 豆腐、杏仁、霓裳花 | - | 琉璃百合(每月刷新) |\n | 璃月-轻策庄 | 凯叔 | 大碗茶 | - | - | 稀少商品 |\n-| 璃月-遗珑埠 | 丰泰 | - | 沉玉仙茗、琉璃袋、绝云椒椒 | 蟹黄 |  |\n+| 璃月-遗珑埠 | 丰泰 | 稻米、豆腐 | 清水玉、石珀、夜泊石、琉璃袋、霓裳花、绝云椒椒、沉玉仙茗 | 蟹黄 |  |\n | 璃月-遗珑埠 | 连芳 | - | 沉玉仙茗 | - |  |\n | 稻妻-离岛 | 小畑 | 螃蟹、鱼肉、虾仁 | 海灵芝 | - |  |\n | 稻妻-离岛 | 秋月 | 铁块、白铁块、电气水晶 | - | - |  |\n@@ -74,10 +74,11 @@\n | 挪德卡莱-那夏镇 | 雷科 | - | - | 幸运儿之杯、幸运儿鹰羽、幸运儿银冠、幸运儿绿花、幸运儿沙漏 | 狗粮商人 |\n | 挪德卡莱-皮拉米达城 | 科菲策 | 牛奶、咖啡豆 | 微光角菌、琉鳞石 | - | 黑心商人 |\n \n-- **国家标签**：蒙德、璃月、稻妻、须弥、枫丹、纳塔、挪德卡莱\n-- **地区标签**：风起地、清泉镇、蒙德城、璃月港、离岛、稻妻城、海祇岛等\n-- **小地图标签**：天使的馈赠、兰巴德酒馆、德波大饭店、灰河、锈舵酒馆等\n-- **商人标签**：克罗丽丝、神奇的霍普金斯、杜拉夫等（所有商人名）\n+### **以下为有效标签**\n+- **国家**：蒙德、璃月、稻妻、须弥、枫丹、纳塔、挪德卡莱\n+- **地区**：风起地、清泉镇、蒙德城、璃月港、离岛、稻妻城、海祇岛等\n+- **小地图**：天使的馈赠、兰巴德酒馆、德波大饭店、灰河、锈舵酒馆等\n+- **商人**：克罗丽丝、神奇的霍普金斯、杜拉夫等（所有商人名）\n - **移动**：指商人会移动，有机会购买失败\n - **稀少商品**：指稀少商品\n - **独立地图**：指需要进入独立空间的特殊地图，这些地图部份路径无法使用地图追踪功能\n"
test_patch: ''
fail_to_pass:
- node tests/disabled_tags.test.js
pass_to_pass:
- node build/build.js --help
install_config:
  install: npm install
  node: '20'
  test_cmd: npm test
meta:
  added_lines: '149'
  difficulty: medium
  files_changed: '8'
  pr_title: 自动购买每天&3天&每周刷新商品3.2.3
  removed_lines: '97'
  source: gh-archive-pr
  test_files: '[{"path":"tests/disabled_tags.test.js","content":"const assert = require(''assert'');\nconst fs = require(''fs'');\nconst vm = require(''vm'');\nconst path = require(''path'');\n\nconst baseDir = path.resolve(process.cwd(), ''repo'', ''js'', ''自动购买每天&3天&每周刷新商品'');\nconst mainCode = fs.readFileSync(path.join(baseDir, ''main.js''), ''utf8'');\nconst preIIFE = mainCode.split(''(async function ()'')[0];\n\nfunction createContext(settings) {\n  const context = {\n    settings,\n    log: { info: () => {}, warn: () => {}, error: () => {}, debug: () => {} },\n    file: {\n      readText: async (filePath) => fs.promises.readFile(path.join(baseDir, filePath), ''utf8''),\n      ReadImageMatSync: () => { throw new Error(''not needed''); }\n    },\n    RecognitionObject: { TemplateMatch: () => ({}) },\n    sleep: async () => {},\n    pathingScript: { runFile: async () => {} },\n    setGameMetrics: () => {},\n    click: () => {},\n    captureGameRegion: () => ({ FindMulti: () => [], dispose: () => {} })\n  };\n  vm.createContext(context);\n  vm.runInContext(preIIFE, context);\n  return context;\n}\n\nasync function initAndGet(context, expr) {\n  await context.loadExternalData();\n  await context.initNpcData([]);\n  return vm.runInContext(expr, context);\n}\n\n(async () => {\n  // Disable by region tag (蒙德城) should disable 石榴 but not 阿山婆.\n  const ctxRegion = createContext({\n    foodsToBuy: ''冒险家金杯 霄灯'',\n    disabledTags: ''蒙德城''\n  });\n  const regionResult = await initAndGet(\n    ctxRegion,\n    ''({stone: npcData[\"石榴\"].enable, ashan: npcData[\"阿山婆\"].enable})''\n  );\n  assert.strictEqual(regionResult.stone, false, ''Stone should be disabled by region tag'');\n  assert.strictEqual(regionResult.ashan, true, ''Ashanpo should remain enabled'');\n\n  // Disable by merchant tag (黑心商人) should disable 皮托 but not 克罗丽丝.\n  const ctxMerchant = createContext({\n    foodsToBuy: ''牛奶 金鱼草'',\n    disabledTags: ''黑心商人''\n  });\n  const merchantResult = await initAndGet(\n    ctxMerchant,\n    ''({pito: npcData[\"皮托\"].enable, clor: npcData[\"克罗丽丝\"].enable})''\n  );\n  assert.strictEqual(merchantResult.pito, false, ''Pito should be disabled by merchant tag'');\n  assert.strictEqual(merchantResult.clor, true, ''Clorisse should remain enabled'');\n\n  // Disable by country tag (蒙德) should disable 石榴 but not 阿山婆.\n  const ctxCountry = createContext({\n    foodsToBuy: ''冒险家金杯 霄灯'',\n    disabledTags: ''蒙德''\n  });\n  const countryResult = await initAndGet(\n    ctxCountry,\n    ''({stone: npcData[\"石榴\"].enable, ashan: npcData[\"阿山婆\"].enable})''\n  );\n  assert.strictEqual(countryResult.stone, false, ''Stone should be disabled by country tag'');\n  assert.strictEqual(countryResult.ashan, true, ''Ashanpo should remain enabled'');\n\n  // Disable by dog-food merchant tag should disable 石榴 but not 阿山婆.\n  const ctxDogFood = createContext({\n    foodsToBuy: ''冒险家金杯 霄灯'',\n    disabledTags: ''狗粮商人''\n  });\n  const dogFoodResult = await initAndGet(\n    ctxDogFood,\n    ''({stone: npcData[\"石榴\"].enable, ashan: npcData[\"阿山婆\"].enable})''\n  );\n  assert.strictEqual(dogFoodResult.stone, false, ''Stone should be disabled by dog-food tag'');\n  assert.strictEqual(dogFoodResult.ashan, true, ''Ashanpo should remain enabled'');\n\n  console.log(''disabled_tags tests passed'');\n})();\n"}]'
  test_generation: agentic-docker
prompt: |-
  babalae/bettergi-scripts-list (#2892): 自动购买每天&3天&每周刷新商品3.2.3

  Add support for purchase-disable tags when automatically buying daily, every-3-days, and weekly refresh goods. Allow disabling by country, region, minimap area, and merchant tags, including the new merchant tag types (black-hearted merchant and dog-food merchant). Update the merchant goods list and refresh cycle data to the latest 3.2.3 information.
original_pr_body: |-
  babalae/bettergi-scripts-list (#2892): 自动购买每天&3天&每周刷新商品3.2.3

  -标签支持

  <!-- This is an auto-generated comment: release notes by coderabbit.ai -->

  ## Summary by CodeRabbit

  ## 版本 3.2.3 发布说明

  * **新功能**
    * 引入基于标签的购买禁用功能，支持按国家、地区、小地图及商人标签进行控制
    * 新增标签类型：黑心商人、狗粮商人

  * **数据更新**
    * 更新商人商品清单及刷新周期信息

  <!-- end of auto-generated comment: release notes by coderabbit.ai -->
quality_score: 0.55
quality_passed: true
docker_passed: false
workspace_path: null
status: ready
