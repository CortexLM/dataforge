id: opendatahub-io/notebooks-2977
repo: opendatahub-io/notebooks
base_commit: 495287e2a0cb4a04e86432c198a1a6d68f24a34e
merge_commit: 17324ee6f498427167c8963fb0fc83625ab9ec12
language: python
difficulty_score: 2
created_at: 2026-02-17T09:23:27.230035704Z
patch: "diff --git a/base-images/utils/aipcc.sh b/base-images/utils/aipcc.sh\nindex c111e79a62..19e970f786 100755\n--- a/base-images/utils/aipcc.sh\n+++ b/base-images/utils/aipcc.sh\n@@ -7,9 +7,13 @@ _=${VIRTUAL_ENV}\n \n DNF_OPTS=(-y --nodocs --setopt=install_weak_deps=False --setopt=keepcache=True --setopt=max_parallel_downloads=10)\n \n+function get_os_vendor() {\n+    cut -d: -f3 /etc/system-release-cpe\n+}\n+\n function install_packages() {\n     local os_vendor\n-    os_vendor=$(cut -d: -f3 /etc/system-release-cpe)\n+    os_vendor=$(get_os_vendor)\n \n     PKGS=()\n \n@@ -130,7 +134,7 @@ function install_packages() {\n # The list is obtained as explained in c9s-python-3.12/README.md\n function install_scl_packages() {\n     local os_vendor\n-    os_vendor=$(cut -d: -f3 /etc/system-release-cpe)\n+    os_vendor=$(get_os_vendor)\n \n     SCL_PACKAGES=(\n         \"annobin\"\n@@ -365,6 +369,21 @@ function uninstall_epel() {\n     dnf remove \"${DNF_OPTS[@]}\" epel-release\n }\n \n+# COPR repo with newer rebuilds of EPEL packages (e.g. hdf5 with libhdf5.so.310)\n+# https://copr.fedorainfracloud.org/coprs/aaiet-notebooks/rhelai-el9/\n+function install_copr() {\n+    if [[ \"$(get_os_vendor)\" == \"centos\" ]]; then\n+        dnf install \"${DNF_OPTS[@]}\" 'dnf-command(copr)'\n+        dnf copr enable -y aaiet-notebooks/rhelai-el9\n+    fi\n+}\n+\n+function uninstall_copr() {\n+    if [[ \"$(get_os_vendor)\" == \"centos\" ]]; then\n+        dnf copr disable -y aaiet-notebooks/rhelai-el9\n+    fi\n+}\n+\n # AIPCC bases enable codeready-builder, so we need to do the CentOS equivalent\n # In RHEL this is codeready-builder-for-rhel-${RELEASEVER_MAJOR}-${ARCH}-eus-rpms\n # or codeready-builder-for-rhel-${RELEASEVER_MAJOR}-${ARCH}-rpms\n@@ -372,7 +391,7 @@ function install_csb() {\n     dnf install \"${DNF_OPTS[@]}\" dnf-plugins-core\n \n     local os_vendor\n-    os_vendor=$(cut -d: -f3 /etc/system-release-cpe)\n+    os_vendor=$(get_os_vendor)\n \n     if [[ \"${os_vendor}\" == \"centos\" ]]; then\n       dnf config-manager --set-enabled crb\n@@ -393,15 +412,24 @@ function main() {\n     install_csb\n \n     install_epel\n+    install_copr\n \n     # install security updates\n     dnf update \"${DNF_OPTS[@]}\" --security\n \n     install_packages\n+    # https://github.com/opendatahub-io/notebooks/pull/2609\n     if ! test -f /usr/lib64/libzmq.so.5; then\n         echo \"Error: libzmq.so.5 was not found after installation\"\n         exit 1\n     fi\n+    # https://github.com/opendatahub-io/notebooks/issues/2944\n+    if [[ \"$(get_os_vendor)\" == \"centos\" ]]; then\n+        if ! test -f /usr/lib64/libhdf5.so.310; then\n+            echo \"Error: libhdf5.so.310 was not found after installation (see https://github.com/opendatahub-io/notebooks/issues/2944)\"\n+            exit 1\n+        fi\n+    fi\n \n     dnf install \"${DNF_OPTS[@]}\" ${PYTHON}-devel ${PYTHON}-pip\n     install_python_venv\n@@ -411,6 +439,7 @@ function main() {\n     # Makefile: REQUIRED_RUNTIME_IMAGE_COMMANDS=\"curl python3\"\n     dnf install \"${DNF_OPTS[@]}\" which\n \n+    uninstall_copr\n     uninstall_epel\n }\n \n"
test_patch: ''
fail_to_pass:
- python -m unittest -v tests.test_aipcc_copr_unittest
pass_to_pass:
- python -m unittest -v tests.pytest_tutorial.test_01_intro.LegacyThing.test_something
install_config:
  install: pip install -e .
  python: '3.11'
  test_cmd: pytest
meta:
  added_lines: '32'
  difficulty: medium
  files_changed: '1'
  pr_title: 'ISSUE #2944: chore: (base-images/aipcc.sh): enable aaiet-notebooks/rhelai-el9 COPR repo'
  removed_lines: '3'
  source: gh-archive-pr
  test_files: '[{"path":"tests/test_aipcc_copr.py","content":"import os\nimport pathlib\nimport subprocess\n\nimport pytest\n\n\nSCRIPT_PATH = pathlib.Path(\"base-images/utils/aipcc.sh\")\n\n\ndef _run_bash(script: str, env: dict[str, str]) -> subprocess.CompletedProcess:\n    return subprocess.run(\n        [\"bash\", \"-c\", script],\n        env=env,\n        text=True,\n        capture_output=True,\n    )\n\n\ndef _base_env(tmp_path: pathlib.Path) -> dict[str, str]:\n    env = os.environ.copy()\n    env.update(\n        {\n            \"TARGETARCH\": \"amd64\",\n            \"PYTHON\": \"python3\",\n            \"VIRTUAL_ENV\": str(tmp_path / \"venv\"),\n        }\n    )\n    return env\n\n\n@pytest.mark.parametrize(\"vendor,expected_calls\", [(\"centos\", True), (\"rhel\", False)])\ndef test_install_uninstall_copr_calls_dnf(tmp_path, vendor, expected_calls):\n    dnf_log = tmp_path / \"dnf.log\"\n    mock_bin = tmp_path / \"bin\"\n    mock_bin.mkdir()\n    dnf_script = mock_bin / \"dnf\"\n    dnf_script.write_text(\n        \"#!/usr/bin/env bash\\n\"\n        \"echo \\\"$@\\\" >> \\\"$DNF_LOG\\\"\\n\"\n    )\n    dnf_script.chmod(0o755)\n\n    env = _base_env(tmp_path)\n    env[\"PATH\"] = f\"{mock_bin}:{env[''PATH'']}\"\n    env[\"DNF_LOG\"] = str(dnf_log)\n\n    script = f\"\"\"\n        set -e\n        source {SCRIPT_PATH}\n        get_os_vendor() {{ echo {vendor}; }}\n        install_copr\n        uninstall_copr\n    \"\"\"\n    result = _run_bash(script, env)\n\n    assert result.returncode == 0, result.stderr + result.stdout\n\n    log_content = dnf_log.read_text() if dnf_log.exists() else \"\"\n    if expected_calls:\n        assert \"dnf-command(copr)\" in log_content\n        assert \"copr enable -y aaiet-notebooks/rhelai-el9\" in log_content\n        assert \"copr disable -y aaiet-notebooks/rhelai-el9\" in log_content\n    else:\n        assert log_content.strip() == \"\"\n\n\ndef test_main_fails_when_hdf5_missing_on_centos(tmp_path):\n    lib64 = pathlib.Path(\"/usr/lib64\")\n    lib64.mkdir(exist_ok=True)\n    libzmq = lib64 / \"libzmq.so.5\"\n    libzmq.touch()\n\n    mock_bin = tmp_path / \"bin\"\n    mock_bin.mkdir()\n    dnf_script = mock_bin / \"dnf\"\n    dnf_script.write_text(\"#!/usr/bin/env bash\\nexit 0\\n\")\n    dnf_script.chmod(0o755)\n\n    env = _base_env(tmp_path)\n    env[\"PATH\"] = f\"{mock_bin}:{env[''PATH'']}\"\n\n    script = f\"\"\"\n        set -e\n        source {SCRIPT_PATH}\n        get_os_vendor() {{ echo centos; }}\n        install_csb() {{ :; }}\n        install_epel() {{ :; }}\n        uninstall_epel() {{ :; }}\n        install_packages() {{ :; }}\n        install_scl_packages() {{ :; }}\n        install_python_venv() {{ :; }}\n        main\n    \"\"\"\n    result = _run_bash(script, env)\n    libzmq.unlink(missing_ok=True)\n\n    assert result.returncode == 1\n    assert \"libhdf5.so.310\" in result.stdout + result.stderr\n"},{"path":"tests/test_aipcc_copr_unittest.py","content":"import os\nimport pathlib\nimport subprocess\nimport tempfile\nimport unittest\n\n\nSCRIPT_PATH = pathlib.Path(\"base-images/utils/aipcc.sh\")\n\n\ndef _run_bash(script: str, env: dict[str, str]) -> subprocess.CompletedProcess:\n    return subprocess.run(\n        [\"bash\", \"-c\", script],\n        env=env,\n        text=True,\n        capture_output=True,\n    )\n\n\ndef _base_env(tmp_path: pathlib.Path) -> dict[str, str]:\n    env = os.environ.copy()\n    env.update(\n        {\n            \"TARGETARCH\": \"amd64\",\n            \"PYTHON\": \"python3\",\n            \"VIRTUAL_ENV\": str(tmp_path / \"venv\"),\n        }\n    )\n    return env\n\n\nclass TestAipccCopr(unittest.TestCase):\n    def test_install_uninstall_copr_calls_dnf_for_centos(self):\n        with tempfile.TemporaryDirectory() as tmpdir:\n            tmp_path = pathlib.Path(tmpdir)\n            dnf_log = tmp_path / \"dnf.log\"\n            mock_bin = tmp_path / \"bin\"\n            mock_bin.mkdir()\n            dnf_script = mock_bin / \"dnf\"\n            dnf_script.write_text(\n                \"#!/usr/bin/env bash\\n\"\n                \"echo \\\"$@\\\" >> \\\"$DNF_LOG\\\"\\n\"\n            )\n            dnf_script.chmod(0o755)\n\n            env = _base_env(tmp_path)\n            env[\"PATH\"] = f\"{mock_bin}:{env[''PATH'']}\"\n            env[\"DNF_LOG\"] = str(dnf_log)\n\n            script = f\"\"\"\n                set -e\n                source {SCRIPT_PATH}\n                get_os_vendor() {{ echo centos; }}\n                install_copr\n                uninstall_copr\n            \"\"\"\n            result = _run_bash(script, env)\n\n            self.assertEqual(result.returncode, 0, result.stderr + result.stdout)\n\n            log_content = dnf_log.read_text() if dnf_log.exists() else \"\"\n            self.assertIn(\"dnf-command(copr)\", log_content)\n            self.assertIn(\"copr enable -y aaiet-notebooks/rhelai-el9\", log_content)\n            self.assertIn(\"copr disable -y aaiet-notebooks/rhelai-el9\", log_content)\n\n    def test_install_uninstall_copr_skips_non_centos(self):\n        with tempfile.TemporaryDirectory() as tmpdir:\n            tmp_path = pathlib.Path(tmpdir)\n            dnf_log = tmp_path / \"dnf.log\"\n            mock_bin = tmp_path / \"bin\"\n            mock_bin.mkdir()\n            dnf_script = mock_bin / \"dnf\"\n            dnf_script.write_text(\n                \"#!/usr/bin/env bash\\n\"\n                \"echo \\\"$@\\\" >> \\\"$DNF_LOG\\\"\\n\"\n            )\n            dnf_script.chmod(0o755)\n\n            env = _base_env(tmp_path)\n            env[\"PATH\"] = f\"{mock_bin}:{env[''PATH'']}\"\n            env[\"DNF_LOG\"] = str(dnf_log)\n\n            script = f\"\"\"\n                set -e\n                source {SCRIPT_PATH}\n                get_os_vendor() {{ echo rhel; }}\n                install_copr\n                uninstall_copr\n            \"\"\"\n            result = _run_bash(script, env)\n\n            self.assertEqual(result.returncode, 0, result.stderr + result.stdout)\n\n            log_content = dnf_log.read_text() if dnf_log.exists() else \"\"\n            self.assertEqual(log_content.strip(), \"\")\n\n    def test_main_fails_when_hdf5_missing_on_centos(self):\n        lib64 = pathlib.Path(\"/usr/lib64\")\n        lib64.mkdir(exist_ok=True)\n        libzmq = lib64 / \"libzmq.so.5\"\n        libzmq.touch()\n\n        with tempfile.TemporaryDirectory() as tmpdir:\n            tmp_path = pathlib.Path(tmpdir)\n            mock_bin = tmp_path / \"bin\"\n            mock_bin.mkdir()\n            dnf_script = mock_bin / \"dnf\"\n            dnf_script.write_text(\"#!/usr/bin/env bash\\nexit 0\\n\")\n            dnf_script.chmod(0o755)\n\n            env = _base_env(tmp_path)\n            env[\"PATH\"] = f\"{mock_bin}:{env[''PATH'']}\"\n\n            script = f\"\"\"\n                set -e\n                source {SCRIPT_PATH}\n                get_os_vendor() {{ echo centos; }}\n                install_csb() {{ :; }}\n                install_epel() {{ :; }}\n                uninstall_epel() {{ :; }}\n                install_packages() {{ :; }}\n                install_scl_packages() {{ :; }}\n                install_python_venv() {{ :; }}\n                main\n            \"\"\"\n            result = _run_bash(script, env)\n\n        libzmq.unlink(missing_ok=True)\n\n        self.assertEqual(result.returncode, 1)\n        self.assertIn(\"libhdf5.so.310\", result.stdout + result.stderr)\n"}]'
  test_generation: agentic-docker
prompt: |-
  opendatahub-io/notebooks (#2977): ISSUE #2944: chore: (base-images/aipcc.sh): enable aaiet-notebooks/rhelai-el9 COPR repo

  Enable a temporary COPR repository that provides newer rebuilds of packages during base image package installation so that dependencies like HDF5 meet required versions. Ensure this repo is enabled during package installation and then disabled/removed before image completion, similar to how EPEL is handled. Add a validation step after package installation to fail with a clear error if the expected newer HDF5 shared library (libhdf5.so.310) is not present, preventing runtime import errors.
original_pr_body: "opendatahub-io/notebooks (#2977): ISSUE #2944: chore: (base-images/aipcc.sh): enable aaiet-notebooks/rhelai-el9 COPR repo\n\n* https://github.com/opendatahub-io/notebooks/pull/2958\r\n\r\n## Context\r\n\r\nThe file [base-images/utils/aipcc.sh](base-images/utils/aipcc.sh) currently installs EPEL temporarily (lines 360-361, 395) and uninstalls it at the end (lines 364-365, 414). The problem is that some EPEL packages are too old -- e.g., `hdf5` wants version 3.10 but CentOS/EPEL has an older version, causing SO version mismatches with Python wheels from the RH index.\r\n\r\nThe COPR repository at `https://copr.fedorainfracloud.org/coprs/aaiet-notebooks/rhelai-el9/` contains newer rebuilds of these packages. Enabling it alongside EPEL allows `dnf` to pick up the newer versions during `install_packages`.\r\n\r\n## Current flow in `main()` (lines 392-415)\r\n\r\n```\r\ninstall_csb        # enable CRB/crb repo\r\ninstall_epel       # install EPEL release RPM\r\ndnf update --security\r\ninstall_packages   # install all RPMs (uses EPEL)\r\n...\r\nuninstall_epel     # remove EPEL at end\r\n```\r\n\r\n## Plan\r\n\r\n### 1. Add `install_copr` and `uninstall_copr` functions\r\n\r\nAdd two new functions in [base-images/utils/aipcc.sh](base-images/utils/aipcc.sh), next to the existing `install_epel`/`uninstall_epel` pair (around line 366):\r\n\r\n```bash\r\nfunction install_copr() {\r\n    dnf install \"${DNF_OPTS[@]}\" 'dnf-command(copr)'\r\n    dnf copr enable -y aaiet-notebooks/rhelai-el9\r\n}\r\n\r\nfunction uninstall_copr() {\r\n    dnf copr disable -y aaiet-notebooks/rhelai-el9\r\n}\r\n```\r\n\r\nThe `dnf copr enable` command adds a `.repo` file under `/etc/yum.repos.d/` that points to the COPR repo. This makes the newer package versions available for resolution. The `priority` in COPR repos is typically set so that COPR packages override base/EPEL packages of the same name.\r\n\r\n### 2. Call `install_copr` after `install_epel` in `main()`\r\n\r\nIn the `main()` function (line 392), add the COPR enable call right after EPEL is installed, and disable it right before EPEL is uninstalled:\r\n\r\n```bash\r\nfunction main() {\r\n    install_csb\r\n\r\n    install_epel\r\n    install_copr\r\n\r\n    # install security updates\r\n    dnf update \"${DNF_OPTS[@]}\" --security\r\n\r\n    install_packages\r\n    ...\r\n\r\n    uninstall_copr\r\n    uninstall_epel\r\n}\r\n```\r\n\r\n### 3. Add `libhdf5.so.310` existence check\r\n\r\nAdd a check in `main()` right after the existing `libzmq.so.5` check (line 401-404), to verify the COPR repo is actually delivering the newer hdf5 package. This directly validates the fix for [issue #2944](https://github.com/opendatahub-io/notebooks/issues/2944) (`ImportError: libhdf5.so.310: cannot open shared object file`):\r\n\r\n```bash\r\n    if ! test -f /usr/lib64/libhdf5.so.310; then\r\n        echo \"Error: libhdf5.so.310 was not found after installation (see https://github.com/opendatahub-io/notebooks/issues/2944)\"\r\n        exit 1\r\n    fi\r\n```\r\n\r\nThis mirrors the existing pattern for `libzmq.so.5` on line 401-404 of [base-images/utils/aipcc.sh](base-images/utils/aipcc.sh).\r\n\r\n### 4. No c9s/ubi conditional gating\r\n\r\nBoth c9s and ubi9 variants run the same `aipcc.sh` script. The COPR repo targets `epel-9-*` chroots, which work on both CentOS Stream 9 and UBI 9 (both are RHEL 9 derivatives). EPEL packages are EPEL packages regardless of the base -- both variants already install EPEL, so the COPR overlay applies equally.\r\n\r\nThe existing `os_vendor` checks in `aipcc.sh` gate specific *packages* that are unavailable on ubi9 (like `snappy`, `openmpi`, `geos`), but the *repo enablement* itself works on both.\r\n\r\n## Notes\r\n\r\n- The COPR repo is cleaned up at the end (just like EPEL) to avoid leaving third-party repos in the final image.\r\n- The `dnf-command(copr)` virtual provide installs the `dnf-plugins-core` package (or it may already be present since `install_csb` also installs it). This is needed for the `dnf copr` subcommand.\r\n- The `priority` of the COPR repo should cause its packages to override older EPEL versions by default. If not, we may need to add `--setopt=priority=50` or use `cost` settings, but this is unlikely to be necessary.\r\n\r\n## How Has This Been Tested?\r\n\r\n* https://github.com/opendatahub-io/notebooks/actions/runs/22078006866?pr=2943\r\n\r\nThis PR used to fail on inability to load Keras, so hopefully I can get past that now.\r\n\r\nSelf checklist (all need to be checked):\r\n- [ ] Ensure that you have run `make test` (`gmake` on macOS) before asking for review\r\n- [ ] Changes to everything except `Dockerfile.konflux` files should be done in `odh/notebooks` and automatically synced to `rhds/notebooks`. For Konflux-specific changes, modify `Dockerfile.konflux` files directly in `rhds/notebooks` as these require special attention in the downstream repository and flow to the upcoming RHOAI release.\r\n\r\n## Merge criteria:\r\n<!--- This PR will be merged by any repository approver when it meets all the points in the checklist -->\r\n<!--- Go over all the following points, and put an `x` in all the boxes that apply. -->\r\n\r\n- [ ] The commits are squashed in a cohesive manner and have meaningful messages.\r\n- [ ] Testing instructions have been added in the PR body (for PRs involving changes that are not immediately obvious).\r\n- [ ] The developer has manually tested the changes and verified that the changes work\r\n\r\n\r\n<!-- This is an auto-generated comment: release notes by coderabbit.ai -->\n## Summary by CodeRabbit\n\n* **Chores**\n  * Enabled use of additional COPR repositories during builds to access newer package versions; the temporary repo is enabled when needed and removed afterward.\n  * Added runtime validation to verify critical libraries (e.g., libzmq, HDF5 on CentOS) after installation and fail early with clear errors if missing.\n<!-- end of auto-generated comment: release notes by coderabbit.ai -->"
quality_score: 0.5
quality_passed: true
docker_passed: false
workspace_path: null
status: ready
