id: TrooHQ/troo-core-30
repo: TrooHQ/troo-core
base_commit: eb56f04f1e26ffeea80eec9bcd44f39c873ca934
merge_commit: d12141691c4baef4fb1af77c270b5fee6d36471f
language: python
difficulty_score: 3
created_at: 2026-02-17T13:22:50.065371218Z
patch: "diff --git a/app/apps/common/scope_map.py b/app/apps/common/scope_map.py\nindex 8fdb747..82ea7c0 100644\n--- a/app/apps/common/scope_map.py\n+++ b/app/apps/common/scope_map.py\n@@ -94,4 +94,19 @@\n     \"authn.password.change\": \"auth.password.change\",\n     \"authn.password.reset.request\": \"auth.password.reset.request\",\n     \"authn.password.reset.confirm\": \"auth.password.reset.confirm\",\n+    # Merchant Stations\n+    \"merchants.station.read\": \"merchants.station.read\",\n+    \"merchants.station.create\": \"merchants.station.create\",\n+    \"merchants.station.update\": \"merchants.station.update\",\n+    \"merchants.station.delete\": \"merchants.station.delete\",\n+    # Merchants Locations\n+    \"merchants.location.read\": \"merchants.location.read\",\n+    \"merchants.location.create\": \"merchants.location.create\",\n+    \"merchants.location.update\": \"merchants.location.update\",\n+    \"merchants.location.delete\": \"merchants.location.delete\",\n+    # Merchant Location Working Hours\n+    \"merchants.location.working_hours.read\": \"merchants.location.working_hours.read\",\n+    \"merchants.location.working_hours.create\": \"merchants.location.working_hours.create\",\n+    \"merchants.location.working_hours.update\": \"merchants.location.working_hours.update\",\n+    \"merchants.location.working_hours.delete\": \"merchants.location.working_hours.delete\",\n }\ndiff --git a/app/apps/merchants/api/serializers.py b/app/apps/merchants/api/serializers.py\nindex 4db15a4..2a9206b 100644\n--- a/app/apps/merchants/api/serializers.py\n+++ b/app/apps/merchants/api/serializers.py\n@@ -97,14 +97,33 @@ class AliasSuggestionsResponseSerializer(serializers.Serializer):\n     suggestions = serializers.ListField(child=serializers.CharField())\n \n \n-class StationSerializer(BaseModelSerializer):\n+class StationDetailSerializer(BaseModelSerializer):\n+    location = serializers.SerializerMethodField()\n+\n     class Meta:\n         model = Station\n         fields = [\"id\", \"name\", \"location\", \"is_active\", \"created_at\", \"updated_at\"]\n-        read_only_fields = [\"merchant\"]\n \n+    def get_location(self, obj):\n+        return {\"id\": str(obj.location_id), \"name\": obj.location.location_name}\n+\n+\n+class StationCreateUpdateSerializer(BaseModelSerializer):\n+    location_id = serializers.UUIDField(write_only=True, required=True)\n+\n+    class Meta:\n+        model = Station\n+        fields = [\n+            \"id\",\n+            \"name\",\n+            \"location_id\",\n+            \"is_active\",\n+        ]\n+\n+\n+class LocationWorkingHoursDetailSerializer(BaseModelSerializer):\n+    location = serializers.SerializerMethodField()\n \n-class LocationWorkingHoursSerializer(BaseModelSerializer):\n     class Meta:\n         model = LocationWorkingHours\n         fields = [\n@@ -114,10 +133,18 @@ class Meta:\n             \"open_time\",\n             \"close_time\",\n             \"is_closed\",\n-            \"created_at\",\n-            \"updated_at\",\n         ]\n-        read_only_fields = [\"location\"]\n+\n+    def get_location(self, obj):\n+        return {\"id\": str(obj.location_id), \"name\": obj.location.location_name}\n+\n+\n+class LocationWorkingHoursCreateUpdateSerializer(BaseModelSerializer):\n+    location_id = serializers.UUIDField(write_only=True, required=True)\n+\n+    class Meta:\n+        model = LocationWorkingHours\n+        fields = [\"id\", \"location_id\", \"day_of_week\", \"open_time\", \"close_time\", \"is_closed\"]\n \n \n class WorkingHoursNestedInputSerializer(serializers.Serializer):\n@@ -128,14 +155,19 @@ class WorkingHoursNestedInputSerializer(serializers.Serializer):\n     is_active = serializers.BooleanField(required=False, default=True)\n \n \n+class StationNestedInputSerializer(serializers.Serializer):\n+    name = serializers.CharField(max_length=128)\n+    is_active = serializers.BooleanField(required=False, default=True)\n+\n+\n class LocationCreateUpdateSerializer(BaseModelSerializer):\n-    working_hours = WorkingHoursNestedInputSerializer(many=True, required=False)\n+    working_hours = WorkingHoursNestedInputSerializer(many=True, required=False, default=list)\n+    stations = StationNestedInputSerializer(many=True, required=False, default=list)\n \n     class Meta:\n         model = Location\n         fields = [\n             \"id\",\n-            \"merchant\",\n             \"location_name\",\n             \"address_line1\",\n             \"address_line2\",\n@@ -148,7 +180,58 @@ class Meta:\n             \"is_default\",\n             \"location_type\",\n             \"working_hours\",\n+            \"stations\",\n             \"created_at\",\n             \"updated_at\",\n         ]\n-        read_only_fields = [\"merchant\"]\n+\n+\n+class LocationDetailSerializer(BaseModelSerializer):\n+    working_hours = serializers.SerializerMethodField()\n+    stations = serializers.SerializerMethodField()\n+\n+    class Meta:\n+        model = Location\n+        fields = [\n+            \"id\",\n+            \"location_name\",\n+            \"address_line1\",\n+            \"address_line2\",\n+            \"city\",\n+            \"state\",\n+            \"postal_code\",\n+            \"country\",\n+            \"timezone\",\n+            \"is_closed\",\n+            \"is_default\",\n+            \"location_type\",\n+            \"working_hours\",\n+            \"stations\",\n+            \"created_at\",\n+            \"updated_at\",\n+        ]\n+\n+    def get_working_hours(self, obj):\n+        qs = obj.working_hours.order_by(\"day_of_week\")\n+        return [\n+            {\n+                \"id\": str(wh.id),\n+                \"day_of_week\": wh.day_of_week,\n+                \"open_time\": wh.open_time,\n+                \"close_time\": wh.close_time,\n+                \"is_closed\": wh.is_closed,\n+                \"is_active\": wh.is_active,\n+            }\n+            for wh in qs\n+        ]\n+\n+    def get_stations(self, obj):\n+        qs = obj.stations.filter(is_active=True)\n+        return [\n+            {\n+                \"id\": str(station.id),\n+                \"name\": station.name,\n+                \"is_active\": station.is_active,\n+            }\n+            for station in qs\n+        ]\ndiff --git a/app/apps/merchants/api/urls.py b/app/apps/merchants/api/urls.py\nindex 4e242e9..70fcc86 100644\n--- a/app/apps/merchants/api/urls.py\n+++ b/app/apps/merchants/api/urls.py\n@@ -4,10 +4,11 @@\n from .views import LocationViewSet, LocationWorkingHoursViewSet, MerchantViewSet, StationViewSet\n \n router = DefaultRouter()\n-router.register(r\"\", MerchantViewSet, basename=\"merchants\")\n+\n router.register(r\"locations\", LocationViewSet, basename=\"locations\")\n router.register(r\"stations\", StationViewSet, basename=\"stations\")\n router.register(r\"working-hours\", LocationWorkingHoursViewSet, basename=\"working-hours\")\n+router.register(r\"\", MerchantViewSet, basename=\"merchants\")\n \n members_view = MerchantViewSet.as_view({\"get\": \"members\"})\n \ndiff --git a/app/apps/merchants/api/views.py b/app/apps/merchants/api/views.py\nindex 675b3dd..e8bc18c 100644\n--- a/app/apps/merchants/api/views.py\n+++ b/app/apps/merchants/api/views.py\n@@ -1,10 +1,14 @@\n # apps/merchants/api/views.py\n-\n from django.contrib.auth import get_user_model\n from django.core.exceptions import ValidationError\n from django.db import IntegrityError, transaction\n from django.utils import timezone\n-from drf_spectacular.utils import OpenApiParameter, OpenApiResponse, extend_schema\n+from drf_spectacular.utils import (\n+    OpenApiParameter,\n+    OpenApiResponse,\n+    extend_schema,\n+    extend_schema_view,\n+)\n from rest_framework import mixins, status, viewsets\n from rest_framework.decorators import action\n from rest_framework.permissions import AllowAny\n@@ -32,13 +36,16 @@\n     AliasSetSerializer,\n     AliasSuggestionsResponseSerializer,\n     LocationCreateUpdateSerializer,\n+    LocationDetailSerializer,\n     LocationSerializer,\n-    LocationWorkingHoursSerializer,\n+    LocationWorkingHoursCreateUpdateSerializer,\n+    LocationWorkingHoursDetailSerializer,\n     MerchantMemberSerializer,\n     MerchantSerializer,\n     OnboardingCreateResponseSerializer,\n     OnboardingCreateSerializer,\n-    StationSerializer,\n+    StationCreateUpdateSerializer,\n+    StationDetailSerializer,\n )\n from apps.merchants.models import (\n     Location,\n@@ -575,57 +582,250 @@ def accept_invite(self, request):\n         return resp\n \n \n+@extend_schema_view(\n+    list=extend_schema(\n+        summary=\"List all stations\",\n+        responses={200: StationDetailSerializer(many=True)},\n+    ),\n+    retrieve=extend_schema(\n+        summary=\"Retrieve a station\",\n+        responses={200: StationDetailSerializer},\n+    ),\n+    create=extend_schema(\n+        summary=\"Create a station\",\n+        request=StationCreateUpdateSerializer,\n+        responses={201: StationDetailSerializer},\n+    ),\n+    update=extend_schema(\n+        summary=\"Update a station\",\n+        request=StationCreateUpdateSerializer,\n+        responses={200: StationDetailSerializer},\n+    ),\n+    partial_update=extend_schema(\n+        summary=\"Partially update a station\",\n+        request=StationCreateUpdateSerializer,\n+        responses={200: StationDetailSerializer},\n+    ),\n+    destroy=extend_schema(\n+        summary=\"Delete a station\",\n+        responses={204: None},\n+    ),\n+)\n class StationViewSet(viewsets.ModelViewSet):\n-    serializer_class = StationSerializer\n+    def get_permissions(self):\n+        action_scopes = {\n+            \"list\": SCOPE_MAP[\"merchants.station.read\"],\n+            \"retrieve\": SCOPE_MAP[\"merchants.station.read\"],\n+            \"create\": SCOPE_MAP[\"merchants.station.create\"],\n+            \"update\": SCOPE_MAP[\"merchants.station.update\"],\n+            \"partial_update\": SCOPE_MAP[\"merchants.station.update\"],\n+            \"destroy\": SCOPE_MAP[\"merchants.station.delete\"],\n+        }\n+        scope = action_scopes.get(self.action)\n+        return [require_scopes(scope)] if scope else []\n+\n+    def get_serializer_class(self):\n+        if self.action in (\"list\", \"retrieve\"):\n+            return StationDetailSerializer\n+        return StationCreateUpdateSerializer\n \n     def get_queryset(self):\n         merchant = get_current_merchant(self.request)\n         return Station.objects.filter(merchant=merchant)\n \n+    @transaction.atomic\n     def perform_create(self, serializer):\n         merchant = get_current_merchant(self.request)\n-        serializer.save(merchant=merchant)\n+        location_id = serializer.validated_data[\"location_id\"]\n+\n+        # ✅ ensure location belongs to same merchant\n+        if not Location.objects.filter(id=location_id, merchant=merchant).exists():\n+            raise ValidationError({\"location_id\": [\"Invalid location for this merchant.\"]})\n \n+        serializer.save(merchant=merchant, location_id=location_id)\n \n+    @transaction.atomic\n+    def perform_update(self, serializer):\n+        merchant = get_current_merchant(self.request)\n+\n+        # if location_id is being changed, validate it\n+        if \"location_id\" in serializer.validated_data:\n+            new_location_id = serializer.validated_data[\"location_id\"]\n+            if not Location.objects.filter(id=new_location_id, merchant=merchant).exists():\n+                raise ValidationError({\"location_id\": [\"Invalid location for this merchant.\"]})\n+            serializer.save(location_id=new_location_id, merchant=merchant)\n+            return\n+\n+        serializer.save()\n+\n+\n+@extend_schema_view(\n+    list=extend_schema(\n+        summary=\"List all location working hours\",\n+        responses={200: LocationWorkingHoursDetailSerializer(many=True)},\n+    ),\n+    retrieve=extend_schema(\n+        summary=\"Retrieve location working hours\",\n+        responses={200: LocationWorkingHoursDetailSerializer},\n+    ),\n+    create=extend_schema(\n+        summary=\"Create location working hours\",\n+        request=LocationWorkingHoursCreateUpdateSerializer,\n+        responses={201: LocationWorkingHoursDetailSerializer},\n+    ),\n+    update=extend_schema(\n+        summary=\"Update location working hours\",\n+        request=LocationWorkingHoursCreateUpdateSerializer,\n+        responses={200: LocationWorkingHoursDetailSerializer},\n+    ),\n+    partial_update=extend_schema(\n+        summary=\"Partially update location working hours\",\n+        request=LocationWorkingHoursCreateUpdateSerializer,\n+        responses={200: LocationWorkingHoursDetailSerializer},\n+    ),\n+    destroy=extend_schema(\n+        summary=\"Delete location working hours\",\n+        responses={204: None},\n+    ),\n+)\n class LocationWorkingHoursViewSet(viewsets.ModelViewSet):\n-    serializer_class = LocationWorkingHoursSerializer\n+    def get_permissions(self):\n+        action_scopes = {\n+            \"list\": SCOPE_MAP[\"merchants.location.working_hours.read\"],\n+            \"retrieve\": SCOPE_MAP[\"merchants.location.working_hours.read\"],\n+            \"create\": SCOPE_MAP[\"merchants.location.working_hours.create\"],\n+            \"update\": SCOPE_MAP[\"merchants.location.working_hours.update\"],\n+            \"partial_update\": SCOPE_MAP[\"merchants.location.working_hours.update\"],\n+            \"destroy\": SCOPE_MAP[\"merchants.location.working_hours.delete\"],\n+        }\n+        scope = action_scopes.get(self.action)\n+        return [require_scopes(scope)] if scope else []\n+\n+    def get_serializer_class(self):\n+        if self.action in (\"list\", \"retrieve\"):\n+            return LocationWorkingHoursDetailSerializer\n+        return LocationWorkingHoursCreateUpdateSerializer\n \n     def get_queryset(self):\n         merchant = get_current_merchant(self.request)\n         location_ids = Location.objects.filter(merchant=merchant).values_list(\"id\", flat=True)\n-        return LocationWorkingHours.objects.filter(location_id__in=location_ids)\n+        qs = (\n+            LocationWorkingHours.objects.filter(location_id__in=location_ids)\n+            .select_related(\"location\")\n+            .order_by(\"day_of_week\", \"id\")\n+        )\n+        location_id = self.request.query_params.get(\"location_id\")\n+        if location_id:\n+            qs = qs.filter(location_id=location_id)\n+        return qs\n \n+    @transaction.atomic\n     def perform_create(self, serializer):\n         merchant = get_current_merchant(self.request)\n-        location = Location.objects.filter(\n-            merchant=merchant, id=self.request.data.get(\"location\")\n-        ).first()\n-        if not location:\n-            from rest_framework.exceptions import ValidationError\n+        location_id = serializer.validated_data[\"location_id\"]\n \n-            raise ValidationError(\"Invalid location\")\n-        serializer.save(location=location)\n+        # ✅ ensure location belongs to same merchant\n+        if not Location.objects.filter(id=location_id, merchant=merchant).exists():\n+            raise ValidationError({\"location_id\": [\"Invalid location for this merchant.\"]})\n \n+        serializer.save(location_id=location_id)\n+\n+    @transaction.atomic\n+    def perform_update(self, serializer):\n+        merchant = get_current_merchant(self.request)\n \n+        # if location_id is being changed, validate it\n+        if \"location_id\" in serializer.validated_data:\n+            new_location_id = serializer.validated_data[\"location_id\"]\n+            if not Location.objects.filter(id=new_location_id, merchant=merchant).exists():\n+                raise ValidationError({\"location_id\": [\"Invalid location for this merchant.\"]})\n+            serializer.save(location_id=new_location_id)\n+            return\n+\n+        serializer.save()\n+\n+\n+@extend_schema_view(\n+    list=extend_schema(\n+        summary=\"List all locations\",\n+        responses={200: LocationDetailSerializer(many=True)},\n+    ),\n+    retrieve=extend_schema(\n+        summary=\"Retrieve a location\",\n+        responses={200: LocationDetailSerializer},\n+    ),\n+    create=extend_schema(\n+        summary=\"Create a location\",\n+        request=LocationCreateUpdateSerializer,\n+        responses={201: LocationDetailSerializer},\n+    ),\n+    update=extend_schema(\n+        summary=\"Update a location\",\n+        request=LocationCreateUpdateSerializer,\n+        responses={200: LocationDetailSerializer},\n+    ),\n+    partial_update=extend_schema(\n+        summary=\"Partially update a location\",\n+        request=LocationCreateUpdateSerializer,\n+        responses={200: LocationDetailSerializer},\n+    ),\n+    destroy=extend_schema(\n+        summary=\"Delete a location\",\n+        responses={204: None},\n+    ),\n+)\n class LocationViewSet(viewsets.ModelViewSet):\n-    serializer_class = LocationCreateUpdateSerializer\n+    def get_permissions(self):\n+        action_scopes = {\n+            \"list\": SCOPE_MAP[\"merchants.location.read\"],\n+            \"retrieve\": SCOPE_MAP[\"merchants.location.read\"],\n+            \"create\": SCOPE_MAP[\"merchants.location.create\"],\n+            \"update\": SCOPE_MAP[\"merchants.location.update\"],\n+            \"partial_update\": SCOPE_MAP[\"merchants.location.update\"],\n+            \"destroy\": SCOPE_MAP[\"merchants.location.delete\"],\n+        }\n+        scope = action_scopes.get(self.action)\n+        return [require_scopes(scope)] if scope else []\n \n     def get_queryset(self):\n         merchant = get_current_merchant(self.request)\n-        return Location.objects.filter(merchant=merchant)\n+        # prefetch working_hours and stations\n+        return (\n+            Location.objects.filter(merchant=merchant)\n+            .prefetch_related(\"working_hours\", \"stations\")\n+            .order_by(\"location_name\", \"id\")\n+        )\n+\n+    def get_serializer_class(self):\n+        if self.action in (\"list\", \"retrieve\"):\n+            return LocationDetailSerializer\n+        return LocationCreateUpdateSerializer\n \n     @transaction.atomic\n     def perform_create(self, serializer):\n         merchant = get_current_merchant(self.request)\n         working_hours = serializer.validated_data.pop(\"working_hours\", [])\n+        stations = serializer.validated_data.pop(\"stations\", [])\n         location = serializer.save(merchant=merchant)\n \n         for wh in working_hours:\n             LocationWorkingHours.objects.create(\n                 location=location,\n-                day_of_week=wh.get[\"day_of_week\"],\n+                day_of_week=wh.get(\"day_of_week\"),\n                 open_time=wh.get(\"open_time\"),\n                 close_time=wh.get(\"close_time\"),\n                 is_closed=wh.get(\"is_closed\", True),\n-                is_active=wh.get(\"is_active\", True),\n             )\n+        for st in stations:\n+            Station.objects.create(\n+                merchant=merchant,\n+                location=location,\n+                name=st.get(\"name\"),\n+                is_active=st.get(\"is_active\", True),\n+            )\n+\n+    @transaction.atomic\n+    def perform_update(self, serializer):\n+        serializer.validated_data.pop(\"working_hours\", None)\n+        serializer.validated_data.pop(\"stations\", None)\n+        super().perform_update(serializer)\ndiff --git a/app/apps/merchants/tests/test_api_views.py b/app/apps/merchants/tests/test_api_views.py\nindex f715bc4..e82b48d 100644\n--- a/app/apps/merchants/tests/test_api_views.py\n+++ b/app/apps/merchants/tests/test_api_views.py\n@@ -1,5 +1,10 @@\n+from datetime import time\n+\n+from django.urls import reverse\n+\n from apps.common.scope_map import SCOPE_MAP\n from apps.common.tests.base_api_test import BaseAPITestCase\n+from apps.merchants.models import DayOfWeek, Location, LocationWorkingHours, Station\n \n \n class MerchantsAPITestCase(BaseAPITestCase):\n@@ -202,3 +207,295 @@ def test_invite_acceptance_and_password_setup(self):\n         resp = self.client.get(me_url)\n         self.assertEqual(resp.status_code, 200)\n         self.assertFalse(resp.json()[\"needs_password_setup\"])\n+\n+\n+class LocationWorkingHoursAPITestCase(BaseAPITestCase):\n+    def setUp(self):\n+        super().setUp()\n+        self.merchant = self.create_merchant()\n+        self.user = self.create_user()\n+        self.role = self.create_role(self.merchant, \"Manager\")\n+        self.link_user_to_merchant(self.user, self.merchant, self.role, is_owner=True)\n+        self.location = Location.objects.create(\n+            merchant=self.merchant,\n+            location_name=\"Test Location\",\n+            address_line1=\"123 Test St\",\n+            city=\"Test City\",\n+            state=\"Test State\",\n+            country=\"NG\",\n+            timezone=\"Africa/Lagos\",\n+            is_default=True,\n+        )\n+\n+    def test_create_location_working_hours(self):\n+        url = \"/api/v1/merchants/working-hours/\"\n+        data = {\n+            \"location\": str(self.location.id),\n+            \"day_of_week\": DayOfWeek.MONDAY,\n+            \"open_time\": \"09:00:00\",\n+            \"close_time\": \"17:00:00\",\n+            \"is_closed\": False,\n+        }\n+        resp = self.post(\n+            url,\n+            data,\n+            scopes=[\"merchants.location.working_hours.create\"],\n+            user=self.user,\n+        )\n+        self.assertIn(resp.status_code, [201, 400], resp.json())\n+        if resp.status_code == 201:\n+            self.assertEqual(resp.json()[\"day_of_week\"], DayOfWeek.MONDAY)\n+\n+    def test_retrieve_location_working_hours(self):\n+        lwh = LocationWorkingHours.objects.create(\n+            location=self.location,\n+            day_of_week=DayOfWeek.TUESDAY,\n+            open_time=time(8, 0),\n+            close_time=time(18, 0),\n+            is_closed=False,\n+        )\n+        url = reverse(\"working-hours-detail\", args=[lwh.id])\n+        resp = self.get(url, scopes=[\"merchants.location.working_hours.read\"], user=self.user)\n+        self.assertEqual(resp.status_code, 200)\n+        self.assertEqual(resp.json()[\"day_of_week\"], DayOfWeek.TUESDAY)\n+\n+    def test_update_location_working_hours(self):\n+        lwh = LocationWorkingHours.objects.create(\n+            location=self.location,\n+            day_of_week=DayOfWeek.WEDNESDAY,\n+            open_time=time(10, 0),\n+            close_time=time(16, 0),\n+            is_closed=False,\n+        )\n+        url = reverse(\"working-hours-detail\", args=[lwh.id])\n+        data = {\"is_closed\": True}\n+        resp = self.patch(\n+            url, data, scopes=[\"merchants.location.working_hours.update\"], user=self.user\n+        )\n+        self.assertEqual(resp.status_code, 200)\n+        self.assertTrue(resp.json()[\"is_closed\"])\n+\n+    def test_delete_location_working_hours(self):\n+        lwh = LocationWorkingHours.objects.create(\n+            location=self.location,\n+            day_of_week=DayOfWeek.THURSDAY,\n+            open_time=time(7, 0),\n+            close_time=time(15, 0),\n+            is_closed=False,\n+        )\n+        url = reverse(\"working-hours-detail\", args=[lwh.id])\n+        resp = self.delete(url, scopes=[\"merchants.location.working_hours.delete\"], user=self.user)\n+        self.assertEqual(resp.status_code, 204)\n+        self.assertFalse(LocationWorkingHours.objects.filter(id=lwh.id).exists())\n+\n+    def test_unique_constraint_on_location_and_day(self):\n+        from django.db.utils import IntegrityError\n+\n+        LocationWorkingHours.objects.create(\n+            location=self.location,\n+            day_of_week=DayOfWeek.FRIDAY,\n+            open_time=time(9, 0),\n+            close_time=time(17, 0),\n+            is_closed=False,\n+        )\n+        with self.assertRaises(IntegrityError):\n+            LocationWorkingHours.objects.create(\n+                location=self.location,\n+                day_of_week=DayOfWeek.FRIDAY,\n+                open_time=time(10, 0),\n+                close_time=time(18, 0),\n+                is_closed=True,\n+            )\n+\n+\n+# ------------------------\n+# StationViewSet Tests\n+# ------------------------\n+\n+\n+class StationAPITestCase(BaseAPITestCase):\n+    def setUp(self):\n+        super().setUp()\n+        self.merchant = self.create_merchant()\n+        self.user = self.create_user()\n+        self.role = self.create_role(self.merchant, \"Manager\")\n+        self.link_user_to_merchant(self.user, self.merchant, self.role, is_owner=True)\n+        self.location = Location.objects.create(\n+            merchant=self.merchant,\n+            location_name=\"Station Location\",\n+            address_line1=\"1 Main St\",\n+            city=\"City\",\n+            state=\"State\",\n+            country=\"NG\",\n+            timezone=\"Africa/Lagos\",\n+            is_default=True,\n+        )\n+\n+    def test_create_station(self):\n+        url = \"/api/v1/merchants/stations/\"\n+        data = {\n+            \"name\": \"Test Station\",\n+            \"location_id\": str(self.location.id),\n+            \"is_active\": True,\n+        }\n+        resp = self.post(\n+            url,\n+            data,\n+            scopes=[\"merchants.station.create\"],\n+            user=self.user,\n+        )\n+        self.assertEqual(resp.status_code, 201, resp.json())\n+        self.assertEqual(resp.json()[\"name\"], \"Test Station\")\n+\n+    def test_list_stations(self):\n+        Station.objects.create(merchant=self.merchant, location=self.location, name=\"S1\")\n+        url = \"/api/v1/merchants/stations/\"\n+        resp = self.get(url, scopes=[\"merchants.station.read\"], user=self.user)\n+        self.assertEqual(resp.status_code, 200)\n+        self.assertIsInstance(resp.json(), list)\n+        self.assertGreaterEqual(len(resp.json()), 1)\n+\n+    def test_retrieve_station(self):\n+        station = Station.objects.create(merchant=self.merchant, location=self.location, name=\"S2\")\n+        url = f\"/api/v1/merchants/stations/{station.id}/\"\n+        resp = self.get(url, scopes=[\"merchants.station.read\"], user=self.user)\n+        self.assertEqual(resp.status_code, 200)\n+        self.assertEqual(resp.json()[\"name\"], \"S2\")\n+\n+    def test_update_station(self):\n+        station = Station.objects.create(merchant=self.merchant, location=self.location, name=\"S3\")\n+        url = f\"/api/v1/merchants/stations/{station.id}/\"\n+        data = {\"name\": \"Updated Station\"}\n+        resp = self.patch(url, data, scopes=[\"merchants.station.update\"], user=self.user)\n+        self.assertEqual(resp.status_code, 200)\n+        self.assertEqual(resp.json()[\"name\"], \"Updated Station\")\n+\n+    def test_delete_station(self):\n+        station = Station.objects.create(merchant=self.merchant, location=self.location, name=\"S4\")\n+        url = f\"/api/v1/merchants/stations/{station.id}/\"\n+        resp = self.delete(url, scopes=[\"merchants.station.delete\"], user=self.user)\n+        self.assertEqual(resp.status_code, 204)\n+        self.assertFalse(Station.objects.filter(id=station.id).exists())\n+\n+    def test_create_station_invalid_location(self):\n+        url = \"/api/v1/merchants/stations/\"\n+        data = {\n+            \"name\": \"Invalid Station\",\n+            \"location_id\": \"00000000-0000-0000-0000-000000000000\",\n+            \"is_active\": True,\n+        }\n+        # Expect ValidationError to be raised and handled as a 400 by DRF\n+        try:\n+            resp = self.post(\n+                url,\n+                data,\n+                scopes=[\"merchants.station.create\"],\n+                user=self.user,\n+            )\n+            self.assertEqual(resp.status_code, 400)\n+            self.assertIn(\"location_id\", resp.json())\n+        except Exception as e:\n+            from django.core.exceptions import ValidationError\n+\n+            self.assertIsInstance(e, ValidationError)\n+\n+\n+# ------------------------\n+# LocationViewSet Tests\n+# ------------------------\n+class LocationAPITestCase(BaseAPITestCase):\n+    def setUp(self):\n+        super().setUp()\n+        self.merchant = self.create_merchant()\n+        self.user = self.create_user()\n+        self.role = self.create_role(self.merchant, \"Manager\")\n+        self.link_user_to_merchant(self.user, self.merchant, self.role, is_owner=True)\n+\n+    def test_create_location(self):\n+        url = \"/api/v1/merchants/locations/\"\n+        data = {\n+            \"location_name\": \"New Location\",\n+            \"address_line1\": \"10 Test Ave\",\n+            \"city\": \"Test City\",\n+            \"state\": \"Test State\",\n+            \"postal_code\": \"12345\",\n+            \"country\": \"NG\",\n+            \"timezone\": \"Africa/Lagos\",\n+            \"is_closed\": False,\n+            \"is_default\": False,\n+            \"location_type\": \"BRANCH\",\n+        }\n+        resp = self.post(\n+            url,\n+            data,\n+            scopes=[\"merchants.location.create\"],\n+            user=self.user,\n+        )\n+        self.assertEqual(resp.status_code, 201, resp.json())\n+        self.assertEqual(resp.json()[\"location_name\"], \"New Location\")\n+\n+    def test_list_locations(self):\n+        Location.objects.create(\n+            merchant=self.merchant,\n+            location_name=\"Loc1\",\n+            address_line1=\"A\",\n+            city=\"C\",\n+            state=\"S\",\n+            postal_code=\"P\",\n+            country=\"NG\",\n+            timezone=\"Africa/Lagos\",\n+        )\n+        url = \"/api/v1/merchants/locations/\"\n+        resp = self.get(url, scopes=[\"merchants.location.read\"], user=self.user)\n+        self.assertEqual(resp.status_code, 200)\n+        self.assertIsInstance(resp.json(), list)\n+        self.assertGreaterEqual(len(resp.json()), 1)\n+\n+    def test_retrieve_location(self):\n+        location = Location.objects.create(\n+            merchant=self.merchant,\n+            location_name=\"Loc2\",\n+            address_line1=\"B\",\n+            city=\"C\",\n+            state=\"S\",\n+            postal_code=\"P\",\n+            country=\"NG\",\n+            timezone=\"Africa/Lagos\",\n+        )\n+        url = f\"/api/v1/merchants/locations/{location.id}/\"\n+        resp = self.get(url, scopes=[\"merchants.location.read\"], user=self.user)\n+        self.assertEqual(resp.status_code, 200)\n+        self.assertEqual(resp.json()[\"location_name\"], \"Loc2\")\n+\n+    def test_update_location(self):\n+        location = Location.objects.create(\n+            merchant=self.merchant,\n+            location_name=\"Loc3\",\n+            address_line1=\"C\",\n+            city=\"C\",\n+            state=\"S\",\n+            postal_code=\"P\",\n+            country=\"NG\",\n+            timezone=\"Africa/Lagos\",\n+        )\n+        url = f\"/api/v1/merchants/locations/{location.id}/\"\n+        data = {\"location_name\": \"Updated Loc3\"}\n+        resp = self.patch(url, data, scopes=[\"merchants.location.update\"], user=self.user)\n+        self.assertEqual(resp.status_code, 200)\n+        self.assertEqual(resp.json()[\"location_name\"], \"Updated Loc3\")\n+\n+    def test_delete_location(self):\n+        location = Location.objects.create(\n+            merchant=self.merchant,\n+            location_name=\"Loc4\",\n+            address_line1=\"D\",\n+            city=\"C\",\n+            state=\"S\",\n+            postal_code=\"P\",\n+            country=\"NG\",\n+            timezone=\"Africa/Lagos\",\n+        )\n+        url = f\"/api/v1/merchants/locations/{location.id}/\"\n+        resp = self.delete(url, scopes=[\"merchants.location.delete\"], user=self.user)\n+        self.assertEqual(resp.status_code, 204)\n+        self.assertFalse(Location.objects.filter(id=location.id).exists())\ndiff --git a/app/apps/rbac/registry.py b/app/apps/rbac/registry.py\nindex 4d6967e..70addd6 100644\n--- a/app/apps/rbac/registry.py\n+++ b/app/apps/rbac/registry.py\n@@ -208,6 +208,41 @@\n         \"Update a member's role\",\n         \"merchants\",\n     ),\n+    # Merchant Stations\n+    (\"merchants.station.read\", \"Read Stations\", \"View merchant stations\", \"merchants\"),\n+    (\"merchants.station.create\", \"Create Station\", \"Create merchant stations\", \"merchants\"),\n+    (\"merchants.station.update\", \"Update Station\", \"Update merchant stations\", \"merchants\"),\n+    (\"merchants.station.delete\", \"Delete Station\", \"Delete merchant stations\", \"merchants\"),\n+    # Merchants Locations\n+    (\"merchants.location.read\", \"Read Locations\", \"View merchant locations\", \"merchants\"),\n+    (\"merchants.location.create\", \"Create Location\", \"Create merchant locations\", \"merchants\"),\n+    (\"merchants.location.update\", \"Update Location\", \"Update merchant locations\", \"merchants\"),\n+    (\"merchants.location.delete\", \"Delete Location\", \"Delete merchant locations\", \"merchants\"),\n+    # Merchant Location Working Hours\n+    (\n+        \"merchants.location.working_hours.read\",\n+        \"Read Location Working Hours\",\n+        \"View location working hours\",\n+        \"merchants\",\n+    ),\n+    (\n+        \"merchants.location.working_hours.create\",\n+        \"Create Location Working Hours\",\n+        \"Create location working hours\",\n+        \"merchants\",\n+    ),\n+    (\n+        \"merchants.location.working_hours.update\",\n+        \"Update Location Working Hours\",\n+        \"Update location working hours\",\n+        \"merchants\",\n+    ),\n+    (\n+        \"merchants.location.working_hours.delete\",\n+        \"Delete Location Working Hours\",\n+        \"Delete location working hours\",\n+        \"merchants\",\n+    ),\n     (\"users.user.read\", \"Read User\", \"View user details\", \"users\"),\n     (\"users.user.create\", \"Create User\", \"Create a new user\", \"users\"),\n     (\"users.user.update\", \"Update User\", \"Update user details\", \"users\"),\n"
test_patch: ''
fail_to_pass:
- DJANGO_SETTINGS_MODULE=test_settings PYTHONPATH=app:/tmp pytest -q app/apps/merchants/tests/test_stations_locations_views.py -q
pass_to_pass:
- DJANGO_SETTINGS_MODULE=test_settings PYTHONPATH=app:/tmp pytest -q app/apps/merchants/tests/test_api_views.py::MerchantsAPITestCase::test_merchant_list_requires_scope -q
install_config:
  install: pip install -e .
  python: '3.11'
  test_cmd: pytest
meta:
  added_lines: '660'
  difficulty: hard
  files_changed: '6'
  pr_title: fix stations and locations viewswt
  removed_lines: '29'
  source: gh-archive-pr
  test_files: '[{"path":"app/apps/merchants/tests/test_stations_locations_views.py","content":"import os\nimport uuid\nfrom datetime import time\n\nfrom django.test import override_settings\nfrom django.urls import reverse\n\nfrom apps.common.scope_map import SCOPE_MAP\nfrom apps.common.tests.base_api_test import BaseAPITestCase\nfrom apps.merchants.models import Location, LocationWorkingHours, Station\n\n\noverride_settings(\n    DATABASES={\n        \"default\": {\n            \"ENGINE\": \"django.db.backends.sqlite3\",\n            \"NAME\": \":memory:\",\n        }\n    },\n    CACHES={\n        \"default\": {\n            \"BACKEND\": \"django.core.cache.backends.locmem.LocMemCache\",\n        }\n    },\n    CELERY_TASK_ALWAYS_EAGER=True,\n    CELERY_TASK_EAGER_PROPAGATES=True,\n    CELERY_BROKER_URL=\"memory://\",\n    CELERY_RESULT_BACKEND=\"cache+memory://\",\n)\nclass StationsLocationsViewsTestCase(BaseAPITestCase):\n    def setUp(self):\n        super().setUp()\n        self.merchant = self.create_merchant()\n        self.user = self.create_user()\n        self.role = self.create_role(self.merchant, \"Manager\")\n        self.link_user_to_merchant(self.user, self.merchant, self.role, is_owner=True)\n        self.location = Location.objects.create(\n            merchant=self.merchant,\n            location_name=\"Main Hub\",\n            address_line1=\"123 Example St\",\n            address_line2=\"\",\n            city=\"Lagos\",\n            state=\"Lagos\",\n            postal_code=\"100001\",\n            country=\"NG\",\n            timezone=\"Africa/Lagos\",\n            is_closed=False,\n            is_default=False,\n            location_type=\"BRANCH\",\n        )\n\n    def _scopes(self, *scope_keys):\n        return [SCOPE_MAP[key] for key in scope_keys]\n\n    def test_station_list_returns_location_object_and_create_requires_location_id(self):\n        station = Station.objects.create(\n            merchant=self.merchant,\n            name=\"Desk 12\",\n            location=self.location,\n            is_active=True,\n        )\n        url = reverse(\"stations-list\")\n        resp = self.get(\n            url,\n            scopes=self._scopes(\"merchants.station.read\"),\n            user=self.user,\n        )\n        self.assertEqual(resp.status_code, 200)\n        data = resp.json()\n        self.assertEqual(len(data), 1)\n        self.assertEqual(data[0][\"id\"], str(station.id))\n        self.assertIsInstance(data[0][\"location\"], dict)\n        self.assertEqual(data[0][\"location\"][\"id\"], str(self.location.id))\n        self.assertEqual(data[0][\"location\"][\"name\"], self.location.location_name)\n\n        create_payload = {\n            \"name\": \"Desk 23\",\n            \"location_id\": str(self.location.id),\n            \"is_active\": False,\n        }\n        create_resp = self.post(\n            url,\n            create_payload,\n            scopes=self._scopes(\"merchants.station.create\"),\n            user=self.user,\n        )\n        self.assertEqual(create_resp.status_code, 201, create_resp.json())\n        created = Station.objects.get(name=\"Desk 23\")\n        self.assertEqual(created.location_id, self.location.id)\n        self.assertFalse(created.is_active)\n\n    def test_station_create_rejects_missing_location_id(self):\n        url = reverse(\"stations-list\")\n        resp = self.post(\n            url,\n            {\"name\": \"Desk 99\"},\n            scopes=self._scopes(\"merchants.station.create\"),\n            user=self.user,\n        )\n        self.assertEqual(resp.status_code, 400)\n        self.assertIn(\"location_id\", resp.json())\n\n    def test_working_hours_list_returns_location_object_and_create_uses_location_id(self):\n        working = LocationWorkingHours.objects.create(\n            location=self.location,\n            day_of_week=\"MONDAY\",\n            open_time=time(8, 0),\n            close_time=time(18, 0),\n            is_closed=False,\n        )\n        url = reverse(\"working-hours-list\")\n        resp = self.get(\n            url,\n            scopes=self._scopes(\"merchants.location.working_hours.read\"),\n            user=self.user,\n        )\n        self.assertEqual(resp.status_code, 200)\n        data = resp.json()\n        self.assertEqual(len(data), 1)\n        self.assertEqual(data[0][\"id\"], str(working.id))\n        self.assertIsInstance(data[0][\"location\"], dict)\n        self.assertEqual(data[0][\"location\"][\"id\"], str(self.location.id))\n        self.assertEqual(data[0][\"location\"][\"name\"], self.location.location_name)\n\n        create_payload = {\n            \"location_id\": str(self.location.id),\n            \"day_of_week\": \"TUESDAY\",\n            \"open_time\": \"09:00:00\",\n            \"close_time\": \"17:00:00\",\n            \"is_closed\": False,\n        }\n        create_resp = self.post(\n            url,\n            create_payload,\n            scopes=self._scopes(\"merchants.location.working_hours.create\"),\n            user=self.user,\n        )\n        self.assertEqual(create_resp.status_code, 201, create_resp.json())\n        created = LocationWorkingHours.objects.get(day_of_week=\"TUESDAY\")\n        self.assertEqual(created.location_id, self.location.id)\n\n    def test_working_hours_create_rejects_missing_location_id(self):\n        url = reverse(\"working-hours-list\")\n        resp = self.post(\n            url,\n            {\n                \"day_of_week\": \"WEDNESDAY\",\n                \"open_time\": \"10:00:00\",\n                \"close_time\": \"16:00:00\",\n                \"is_closed\": False,\n            },\n            scopes=self._scopes(\"merchants.location.working_hours.create\"),\n            user=self.user,\n        )\n        self.assertEqual(resp.status_code, 400)\n        self.assertIn(\"location_id\", resp.json())\n"}]'
  test_generation: agentic-docker
prompt: |-
  TrooHQ/troo-core (#30): fix stations and locations viewswt

  Fix the stations and locations views so they display and behave correctly. Ensure these views load and present data properly and any user-facing issues in these sections are resolved.
original_pr_body: "TrooHQ/troo-core (#30): fix stations and locations viewswt\n\n# Description\r\n\r\n[Describe the change that was made in this PR]\r\n\r\n## TODOs\r\n\r\n- [ ] Tested and working locally\r\n- [ ] Unit tests added (if appropriate)\r\n- [ ] Code changes documented\r\n- [ ] Requested review from >=1 dev(s) on the team\r\n\r\n## How to test\r\n\r\n[Add detailed steps to test the changes that have been made]\r\n\r\n## Screenshots and/or GIFs\r\n\r\n[Insert screenshots and/or GIFs showing the graphic representation of the change]\r\n\r\n## Associated Asana Tasks\r\n\r\n- [Asana Task Description](http://asana_task_link.com)\r\n\r\n## Known Issues\r\n\r\n[Describe any known issue with this change]\r\n"
quality_score: 0.7
quality_passed: true
docker_passed: false
workspace_path: null
status: ready
