id: Botopia-Tecnology/imagiq-dashboard-145
repo: Botopia-Tecnology/imagiq-dashboard
base_commit: d2b1af20da55858d780bd37238a0705acd55fd7a
merge_commit: 425d89193fb087683eaca991cde8ca857fdcbf5f
language: typescript
difficulty_score: 3
created_at: 2026-02-17T09:47:28.811654291Z
patch: "diff --git a/src/app/(dashboard)/marketing/campaigns/crear/sms/page.tsx b/src/app/(dashboard)/marketing/campaigns/crear/sms/page.tsx\nindex a0056ad..0874fca 100644\n--- a/src/app/(dashboard)/marketing/campaigns/crear/sms/page.tsx\n+++ b/src/app/(dashboard)/marketing/campaigns/crear/sms/page.tsx\n@@ -199,6 +199,25 @@ export default function CrearSmsTemplatePage() {\n   const [sendToAllCount, setSendToAllCount] = useState<\"all\" | number>(\"all\");\n   const [customSendCount, setCustomSendCount] = useState(\"\");\n   const [productFilter, setProductFilter] = useState<ProductFilter>({});\n+  const [showAddPhonesDialog, setShowAddPhonesDialog] = useState(false);\n+  const [extraPhonesText, setExtraPhonesText] = useState(() => {\n+    if (typeof window !== \"undefined\") {\n+      return localStorage.getItem(\"campaign-extra-phones\") || \"\";\n+    }\n+    return \"\";\n+  });\n+  const [extraPhones, setExtraPhones] = useState<string[]>(() => {\n+    if (typeof window !== \"undefined\") {\n+      const saved = localStorage.getItem(\"campaign-extra-phones\");\n+      if (saved) {\n+        return saved\n+          .split(/[\\n,;]+/)\n+          .map((p) => p.trim().replace(/\\D/g, \"\"))\n+          .filter((p) => p.length >= 7);\n+      }\n+    }\n+    return [];\n+  });\n   // Track saved state for unsaved changes detection\n   const [savedState, setSavedState] = useState<{ name: string; message: string; category: string } | null>(null);\n   const hasUnsavedChanges = isEditing && savedState !== null && (\n@@ -631,17 +650,22 @@ export default function CrearSmsTemplatePage() {\n \n       const maxRecipients = sendToAllCount === \"all\" ? undefined : sendToAllCount;\n       const activeFilter = productFilter?.categoria ? productFilter : undefined;\n-      const response = await smsTemplateEndpoints.sendToAll(templateId, maxRecipients, activeFilter);\n+      const response = await smsTemplateEndpoints.sendToAll(templateId, maxRecipients, activeFilter, extraPhones.length > 0 ? extraPhones : undefined);\n \n       if (response.success && response.data) {\n         const { estimatedTotal } = response.data;\n-        const secs = Math.ceil((estimatedTotal || 0) / 20);\n+        const extraCount = extraPhones.length;\n+        const totalWithExtra = (estimatedTotal || 0) + extraCount;\n+        const secs = Math.ceil(totalWithExtra / 20);\n         const timeStr = secs < 60 ? `${secs}s` : secs < 3600 ? `${Math.ceil(secs / 60)} min` : `${Math.floor(secs / 3600)}h ${Math.ceil((secs % 3600) / 60)}min`;\n         toast.success(\n-          `Envío iniciado para ${estimatedTotal?.toLocaleString()} destinatarios. Tiempo estimado: ~${timeStr}. El servidor procesará el envío en segundo plano.`\n+          `Envío iniciado para ${totalWithExtra.toLocaleString()} destinatarios${extraCount > 0 ? ` (incluye ${extraCount} teléfonos adicionales)` : \"\"}. Tiempo estimado: ~${timeStr}.`\n         );\n         setShowSendToAllConfirm(false);\n         setShowSendDialog(false);\n+        setExtraPhones([]);\n+        setExtraPhonesText(\"\");\n+        localStorage.removeItem(\"campaign-extra-phones\");\n         loadTemplates();\n       } else {\n         toast.error(response.message || \"Error al enviar SMS\");\n@@ -1244,15 +1268,31 @@ export default function CrearSmsTemplatePage() {\n               </Badge>\n             </div>\n \n-            {/* Total de destinatarios + Enviar a todos */}\n+            {/* Total de destinatarios + Agregar teléfonos + Enviar a todos */}\n             {recipientsTotal > 0 && (\n               <div className=\"flex items-center gap-3 p-3 bg-green-50 dark:bg-green-950/30 rounded-lg border border-green-200 dark:border-green-900\">\n                 <div className=\"h-10 w-10 rounded bg-green-100 dark:bg-green-900 flex items-center justify-center flex-shrink-0\">\n                   <Users className=\"h-5 w-5 text-green-600\" />\n                 </div>\n                 <div className=\"flex-1\">\n-                  <p className=\"font-bold text-lg text-green-600\">{recipientsTotal.toLocaleString()} destinatarios</p>\n+                  <p className=\"font-bold text-lg text-green-600\">\n+                    {(recipientsTotal + extraPhones.length).toLocaleString()} destinatarios\n+                    {extraPhones.length > 0 && (\n+                      <span className=\"text-sm font-normal ml-1\">\n+                        ({recipientsTotal.toLocaleString()} + {extraPhones.length} extra)\n+                      </span>\n+                    )}\n+                  </p>\n                 </div>\n+                <Button\n+                  variant=\"outline\"\n+                  size=\"sm\"\n+                  onClick={() => setShowAddPhonesDialog(true)}\n+                  className=\"gap-1 border-green-300 text-green-700 hover:bg-green-100 dark:hover:bg-green-900\"\n+                >\n+                  <Plus className=\"h-4 w-4\" />\n+                  {extraPhones.length > 0 ? `${extraPhones.length} extra` : \"Agregar\"}\n+                </Button>\n                 <Button\n                   onClick={() => setShowSendToAllConfirm(true)}\n                   disabled={isSendingToAll || !message.trim()}\n@@ -1570,6 +1610,80 @@ export default function CrearSmsTemplatePage() {\n           </DialogFooter>\n         </DialogContent>\n       </Dialog>\n+\n+      {/* Dialog para agregar teléfonos extra */}\n+      <Dialog open={showAddPhonesDialog} onOpenChange={setShowAddPhonesDialog}>\n+        <DialogContent className=\"max-w-md\">\n+          <DialogHeader>\n+            <DialogTitle className=\"flex items-center gap-2 text-green-600\">\n+              <Phone className=\"h-5 w-5\" />\n+              Agregar teléfonos adicionales\n+            </DialogTitle>\n+            <DialogDescription>\n+              Escribe los números de teléfono a los que también quieres enviar, uno por línea o separados por comas.\n+            </DialogDescription>\n+          </DialogHeader>\n+          <div className=\"space-y-3 py-2\">\n+            <Textarea\n+              placeholder={\"3151234567\\n3209876543\\n3001112233\"}\n+              value={extraPhonesText}\n+              onChange={(e) => setExtraPhonesText(e.target.value)}\n+              rows={6}\n+              className=\"font-mono text-sm\"\n+            />\n+            <p className=\"text-xs text-muted-foreground\">\n+              {(() => {\n+                const parsed = extraPhonesText\n+                  .split(/[\\n,;]+/)\n+                  .map((p) => p.trim().replace(/\\D/g, \"\"))\n+                  .filter((p) => p.length >= 7);\n+                const unique = [...new Set(parsed)];\n+                return `${unique.length} teléfono${unique.length !== 1 ? \"s\" : \"\"} válido${unique.length !== 1 ? \"s\" : \"\"} detectado${unique.length !== 1 ? \"s\" : \"\"}`;\n+              })()}\n+            </p>\n+          </div>\n+          <DialogFooter>\n+            <Button\n+              variant=\"outline\"\n+              onClick={() => {\n+                setExtraPhonesText(extraPhones.join(\"\\n\"));\n+                setShowAddPhonesDialog(false);\n+              }}\n+            >\n+              Cancelar\n+            </Button>\n+            <Button\n+              className=\"bg-green-600 hover:bg-green-700\"\n+              onClick={() => {\n+                const parsed = extraPhonesText\n+                  .split(/[\\n,;]+/)\n+                  .map((p) => p.trim().replace(/\\D/g, \"\"))\n+                  .filter((p) => p.length >= 7);\n+                const unique = [...new Set(parsed)];\n+                setExtraPhones(unique);\n+                if (unique.length > 0) {\n+                  localStorage.setItem(\"campaign-extra-phones\", unique.join(\"\\n\"));\n+                } else {\n+                  localStorage.removeItem(\"campaign-extra-phones\");\n+                }\n+                setShowAddPhonesDialog(false);\n+                if (unique.length > 0) {\n+                  toast.success(`${unique.length} teléfono${unique.length !== 1 ? \"s\" : \"\"} adicional${unique.length !== 1 ? \"es\" : \"\"} agregado${unique.length !== 1 ? \"s\" : \"\"}`);\n+                }\n+              }}\n+            >\n+              <Plus className=\"mr-2 h-4 w-4\" />\n+              Guardar ({(() => {\n+                const parsed = extraPhonesText\n+                  .split(/[\\n,;]+/)\n+                  .map((p) => p.trim().replace(/\\D/g, \"\"))\n+                  .filter((p) => p.length >= 7);\n+                return [...new Set(parsed)].length;\n+              })()} teléfonos)\n+            </Button>\n+          </DialogFooter>\n+        </DialogContent>\n+      </Dialog>\n     </div>\n   );\n }\ndiff --git a/src/app/(dashboard)/marketing/campaigns/crear/whatsapp/template/page.tsx b/src/app/(dashboard)/marketing/campaigns/crear/whatsapp/template/page.tsx\nindex 76ec529..b88024e 100644\n--- a/src/app/(dashboard)/marketing/campaigns/crear/whatsapp/template/page.tsx\n+++ b/src/app/(dashboard)/marketing/campaigns/crear/whatsapp/template/page.tsx\n@@ -230,7 +230,7 @@ export default function CrearPlantillaWhatsAppPage() {\n     }>;\n   }>({\n     name: \"\",\n-    category: \"MARKETING\",\n+    category: \"UTILITY\",\n     language: \"es\",\n     header: {\n       type: \"NONE\",\n@@ -408,6 +408,10 @@ export default function CrearPlantillaWhatsAppPage() {\n         toast.error(\"El nombre debe tener entre 3 y 512 caracteres\");\n         return false;\n       }\n+      if (templateData.header?.type === \"TEXT\" && (!templateData.header?.content || templateData.header.content.trim().length === 0)) {\n+        toast.error(\"El texto del encabezado es requerido cuando el tipo es Texto\");\n+        return false;\n+      }\n       if (!templateData.body || templateData.body.trim().length === 0) {\n         toast.error(\"El cuerpo del mensaje es requerido\");\n         return false;\n@@ -587,26 +591,26 @@ export default function CrearPlantillaWhatsAppPage() {\n \n   const createExampleTemplate = () => {\n     setTemplateData({\n-      name: \"promo_descuento_exclusivo\",\n-      category: \"MARKETING\",\n+      name: \"actualizacion_disponibilidad\",\n+      category: \"UTILITY\",\n       language: \"es\",\n       header: {\n         type: \"TEXT\",\n-        content: \"Oferta Exclusiva Samsung\",\n+        content: \"Actualización de disponibilidad\",\n       },\n-      body: \"Hola {{1}}, en imagiq tenemos una promoción especial solo para ti. Obtén hasta 25% de descuento en toda la línea Galaxy S25 de Samsung. Esta oferta es válida por tiempo limitado. No dejes pasar esta oportunidad única de renovar tu tecnología con los mejores precios del mercado.\",\n+      body: \"Hola {{1}}, te informamos que la línea Samsung Galaxy S25 ya se encuentra disponible en nuestra tienda imagiq. Puedes consultar especificaciones, colores y precios actualizados directamente en nuestro sitio web. Si tienes alguna consulta, estamos para ayudarte.\",\n       footer: \"imagiq - Samsung Store Oficial\",\n       buttons: [\n         {\n           id: 1,\n           type: \"URL\",\n-          text: \"Ver Ofertas\",\n-          url: \"https://www.imagiq.com/ofertas\"\n+          text: \"Ver detalles\",\n+          url: \"https://www.imagiq.com/productos\"\n         },\n         {\n           id: 2,\n           type: \"QUICK_REPLY\",\n-          text: \"Me interesa\"\n+          text: \"Tengo una consulta\"\n         }\n       ],\n     });\n@@ -616,20 +620,20 @@ export default function CrearPlantillaWhatsAppPage() {\n \n   const createImageExample = () => {\n     setTemplateData({\n-      name: \"lanzamiento_producto_samsung\",\n-      category: \"MARKETING\",\n+      name: \"nuevo_producto_disponible\",\n+      category: \"UTILITY\",\n       language: \"es\",\n       header: {\n         type: \"IMAGE\",\n         content: \"https://res.cloudinary.com/dbqgbemui/image/upload/v1761873777/Samsung_Store_deken7.png\",\n       },\n-      body: \"Hola {{1}}, te presentamos el nuevo Samsung Galaxy Z Fold 6 ya disponible en imagiq. Precio de lanzamiento desde $5.999.000 COP con envío gratis a toda Colombia. Además, por ser cliente preferido tienes un 10% de descuento adicional. Cantidad limitada, aprovecha antes de que se agoten.\",\n-      footer: \"Aplican términos y condiciones - imagiq\",\n+      body: \"Hola {{1}}, te informamos que el Samsung Galaxy Z Fold 6 ya está disponible en imagiq. Precio desde $5.999.000 COP con envío a toda Colombia. Consulta colores, capacidades y detalles técnicos en nuestra tienda. Para cualquier duda sobre este producto, estamos disponibles.\",\n+      footer: \"imagiq - Samsung Store Oficial\",\n       buttons: [\n         {\n           id: 1,\n           type: \"URL\",\n-          text: \"Comprar Ahora\",\n+          text: \"Ver producto\",\n           url: \"https://www.imagiq.com/productos\"\n         }\n       ],\n@@ -640,25 +644,25 @@ export default function CrearPlantillaWhatsAppPage() {\n \n   const createLocationExample = () => {\n     setTemplateData({\n-      name: \"evento_tienda_imagiq\",\n-      category: \"MARKETING\",\n+      name: \"informacion_tienda_fisica\",\n+      category: \"UTILITY\",\n       language: \"es\",\n       header: {\n         type: \"LOCATION\",\n         content: \"\",\n       },\n-      body: \"Hola {{1}}, te invitamos al evento exclusivo de Samsung en nuestra tienda imagiq. Tendremos demostraciones en vivo de los últimos Galaxy, regalos sorpresa y descuentos de hasta el 40% en productos seleccionados. Cupos limitados, confirma tu asistencia ahora y no te lo pierdas.\",\n-      footer: \"imagiq - Experiencia Samsung\",\n+      body: \"Hola {{1}}, te compartimos la ubicación de nuestra tienda imagiq Samsung Store. Nuestro horario de atención es de lunes a sábado de 9:00 AM a 7:00 PM. Puedes visitarnos para conocer los productos disponibles o agendar una cita personalizada con uno de nuestros asesores.\",\n+      footer: \"imagiq - Samsung Store Oficial\",\n       buttons: [\n         {\n           id: 1,\n           type: \"QUICK_REPLY\",\n-          text: \"Confirmar asistencia\"\n+          text: \"Agendar cita\"\n         },\n         {\n           id: 2,\n           type: \"PHONE_NUMBER\",\n-          text: \"Más información\",\n+          text: \"Llamar a la tienda\",\n           phoneNumber: \"+57 601 234 5678\"\n         }\n       ],\n@@ -669,26 +673,26 @@ export default function CrearPlantillaWhatsAppPage() {\n \n   const createDocumentExample = () => {\n     setTemplateData({\n-      name: \"catalogo_samsung_temporada\",\n-      category: \"MARKETING\",\n+      name: \"catalogo_productos_samsung\",\n+      category: \"UTILITY\",\n       language: \"es\",\n       header: {\n         type: \"DOCUMENT\",\n         content: \"https://www.imagiq.com/catalogos/samsung-2025.pdf\",\n       },\n-      body: \"Hola {{1}}, te compartimos nuestro catálogo de temporada con los mejores productos Samsung disponibles en imagiq. Encuentra ofertas de hasta 30% de descuento en televisores, celulares y electrodomésticos. Descarga el catálogo adjunto y descubre todas las promociones que tenemos para ti.\",\n-      footer: \"imagiq - Tu tienda Samsung autorizada\",\n+      body: \"Hola {{1}}, te compartimos el catálogo actualizado de productos Samsung disponibles en imagiq. Incluye especificaciones técnicas, precios y disponibilidad de celulares, televisores y accesorios. Si necesitas asesoría para elegir el producto adecuado, responde este mensaje.\",\n+      footer: \"imagiq - Samsung Store Oficial\",\n       buttons: [\n         {\n           id: 1,\n           type: \"URL\",\n-          text: \"Ver Tienda Online\",\n+          text: \"Ver catálogo web\",\n           url: \"https://www.imagiq.com/catalogo\"\n         },\n         {\n           id: 2,\n           type: \"QUICK_REPLY\",\n-          text: \"Quiero más info\"\n+          text: \"Necesito asesoría\"\n         }\n       ],\n     });\n@@ -698,26 +702,26 @@ export default function CrearPlantillaWhatsAppPage() {\n \n   const createVideoExample = () => {\n     setTemplateData({\n-      name: \"review_galaxy_s25_ultra\",\n-      category: \"MARKETING\",\n+      name: \"resena_galaxy_s25_ultra\",\n+      category: \"UTILITY\",\n       language: \"es\",\n       header: {\n         type: \"VIDEO\",\n         content: \"https://www.imagiq.com/videos/galaxy-s25-review.mp4\",\n       },\n-      body: \"Hola {{1}}, mira este video exclusivo del nuevo Samsung Galaxy S25 Ultra disponible en imagiq. Cámara de 200MP, IA Galaxy integrada y batería de 5000mAh. Precio de lanzamiento con 15% de descuento solo por esta semana. Stock limitado, no te quedes sin el tuyo.\",\n+      body: \"Hola {{1}}, te compartimos la reseña del Samsung Galaxy S25 Ultra disponible en imagiq. En el video encontrarás detalles sobre su cámara de 200MP, Galaxy AI y batería de 5000mAh. Si deseas conocer precios o disponibilidad, puedes consultarnos directamente por este medio.\",\n       footer: \"imagiq - Samsung Store Oficial\",\n       buttons: [\n         {\n           id: 1,\n           type: \"URL\",\n-          text: \"Comprar Ahora\",\n+          text: \"Ver especificaciones\",\n           url: \"https://www.imagiq.com/productos/galaxy-s25-ultra\"\n         },\n         {\n           id: 2,\n           type: \"QUICK_REPLY\",\n-          text: \"Me interesa\"\n+          text: \"Consultar precio\"\n         }\n       ],\n     });\n@@ -725,99 +729,86 @@ export default function CrearPlantillaWhatsAppPage() {\n     toast.success(\"Ejemplo de video cargado\");\n   };\n \n+  const [isSaving, setIsSaving] = useState(false);\n+\n   const handleSaveTemplate = async () => {\n-    const saved = await saveTemplateToMeta();\n-    if (saved) {\n-      router.push(\"/marketing/campaigns/templates/whatsapp\");\n+    setIsSaving(true);\n+    try {\n+      const saved = await saveTemplateToMeta();\n+      if (saved) {\n+        router.push(\"/marketing/campaigns/templates/whatsapp\");\n+      }\n+    } finally {\n+      setIsSaving(false);\n     }\n   };\n \n   return (\n     <div className=\"flex flex-col h-screen overflow-hidden\">\n       {/* Header - Fixed */}\n-      <div className=\"flex-shrink-0 flex items-center justify-between px-6 py-3 border-b\">\n-        <div className=\"flex items-center gap-4\">\n-          <Link href=\"/marketing/campaigns/crear\">\n-            <Button variant=\"ghost\" size=\"sm\">\n-              <ArrowLeft className=\"h-4 w-4 mr-2\" />\n-              Volver\n-            </Button>\n-          </Link>\n-          <div>\n-            <h1 className=\"text-2xl font-bold tracking-tight\">Crear Plantilla de WhatsApp</h1>\n-            <p className=\"text-sm text-muted-foreground\">\n-              Diseña una plantilla de mensaje que podrás usar en tus campañas\n-            </p>\n+      <div className=\"flex-shrink-0 border-b\">\n+        <div className=\"flex items-center justify-between px-6 py-2\">\n+          <div className=\"flex items-center gap-3 min-w-0\">\n+            <Link href=\"/marketing/campaigns/crear\">\n+              <Button variant=\"ghost\" size=\"sm\" className=\"flex-shrink-0\">\n+                <ArrowLeft className=\"h-4 w-4 mr-1\" />\n+                Volver\n+              </Button>\n+            </Link>\n+            <div className=\"min-w-0\">\n+              <h1 className=\"text-lg font-bold tracking-tight whitespace-nowrap\">Crear Plantilla de WhatsApp</h1>\n+              <p className=\"text-xs text-muted-foreground\">\n+                Diseña una plantilla de mensaje que podrás usar en tus campañas\n+              </p>\n+            </div>\n           </div>\n-        </div>\n-        <div className=\"flex gap-2\">\n-          <div className=\"flex gap-1\">\n-            <Button\n-              variant=\"outline\"\n-              size=\"sm\"\n-              onClick={createExampleTemplate}\n-              className=\"text-xs\"\n-            >\n-              Ejemplo Texto\n-            </Button>\n-            <Button\n-              variant=\"outline\"\n-              size=\"sm\"\n-              onClick={createImageExample}\n-              className=\"text-xs\"\n-            >\n-              Ejemplo Imagen\n-            </Button>\n-            <Button\n-              variant=\"outline\"\n-              size=\"sm\"\n-              onClick={createLocationExample}\n-              className=\"text-xs\"\n-            >\n-              Ejemplo Ubicación\n-            </Button>\n-            <Button\n-              variant=\"outline\"\n-              size=\"sm\"\n-              onClick={createDocumentExample}\n-              className=\"text-xs\"\n-            >\n-              Ejemplo Documento\n+          <div className=\"flex items-center gap-2 flex-shrink-0\">\n+            <div className=\"flex gap-1 border rounded-lg p-0.5\">\n+              <Button\n+                variant={selectedOS === 'ios' ? 'default' : 'ghost'}\n+                size=\"sm\"\n+                onClick={() => setSelectedOS('ios')}\n+                className=\"text-xs h-7 px-2\"\n+              >\n+                <Apple className=\"h-3 w-3 mr-1\" />\n+                iOS\n+              </Button>\n+              <Button\n+                variant={selectedOS === 'android' ? 'default' : 'ghost'}\n+                size=\"sm\"\n+                onClick={() => setSelectedOS('android')}\n+                className=\"text-xs h-7 px-2\"\n+              >\n+                <Smartphone className=\"h-3 w-3 mr-1\" />\n+                Android\n+              </Button>\n+            </div>\n+            <Button size=\"sm\" onClick={handleSaveTemplate} disabled={isSaving}>\n+              {isSaving ? <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" /> : <Save className=\"h-4 w-4 mr-2\" />}\n+              {isSaving ? \"Guardando...\" : \"Guardar Plantilla\"}\n             </Button>\n-            <Button\n-              variant=\"outline\"\n-              size=\"sm\"\n-              onClick={createVideoExample}\n-              className=\"text-xs\"\n-            >\n-              Ejemplo Video\n+            <Button size=\"sm\" onClick={handleOpenSendDialog} disabled={isSavingForSend} className=\"bg-green-600 hover:bg-green-700\">\n+              {isSavingForSend ? <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" /> : <Send className=\"h-4 w-4 mr-2\" />}\n+              Enviar\n             </Button>\n           </div>\n-          <Button\n-            variant={selectedOS === 'ios' ? 'default' : 'outline'}\n-            size=\"sm\"\n-            onClick={() => setSelectedOS('ios')}\n-            className=\"text-xs flex items-center gap-1\"\n-          >\n-            <Apple className=\"h-3 w-3\" />\n-            iOS\n+        </div>\n+        <div className=\"flex items-center gap-1 px-6 pb-2\">\n+          <span className=\"text-xs text-muted-foreground mr-1\">Ejemplos:</span>\n+          <Button variant=\"outline\" size=\"sm\" onClick={createExampleTemplate} className=\"text-xs h-7 px-2\">\n+            Texto\n+          </Button>\n+          <Button variant=\"outline\" size=\"sm\" onClick={createImageExample} className=\"text-xs h-7 px-2\">\n+            Imagen\n           </Button>\n-          <Button\n-            variant={selectedOS === 'android' ? 'default' : 'outline'}\n-            size=\"sm\"\n-            onClick={() => setSelectedOS('android')}\n-            className=\"text-xs flex items-center gap-1\"\n-          >\n-            <Smartphone className=\"h-3 w-3\" />\n-            Android\n+          <Button variant=\"outline\" size=\"sm\" onClick={createLocationExample} className=\"text-xs h-7 px-2\">\n+            Ubicación\n           </Button>\n-          <Button size=\"sm\" onClick={handleSaveTemplate}>\n-            <Save className=\"h-4 w-4 mr-2\" />\n-            Guardar Plantilla\n+          <Button variant=\"outline\" size=\"sm\" onClick={createDocumentExample} className=\"text-xs h-7 px-2\">\n+            Documento\n           </Button>\n-          <Button size=\"sm\" onClick={handleOpenSendDialog} disabled={isSavingForSend} className=\"bg-green-600 hover:bg-green-700\">\n-            {isSavingForSend ? <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" /> : <Send className=\"h-4 w-4 mr-2\" />}\n-            Enviar\n+          <Button variant=\"outline\" size=\"sm\" onClick={createVideoExample} className=\"text-xs h-7 px-2\">\n+            Video\n           </Button>\n         </div>\n       </div>\ndiff --git a/src/app/(dashboard)/marketing/campaigns/templates/whatsapp/page.tsx b/src/app/(dashboard)/marketing/campaigns/templates/whatsapp/page.tsx\nindex 53ef896..da631cd 100644\n--- a/src/app/(dashboard)/marketing/campaigns/templates/whatsapp/page.tsx\n+++ b/src/app/(dashboard)/marketing/campaigns/templates/whatsapp/page.tsx\n@@ -24,9 +24,21 @@ import {\n   AlertDialogTitle,\n   AlertDialogTrigger,\n } from \"@/components/ui/alert-dialog\";\n-import { Plus, MoreHorizontal, Edit, Trash2, MessageSquare, Eye, TrendingUp, Copy, ArrowUp, ArrowDown } from \"lucide-react\";\n+import {\n+  Dialog,\n+  DialogContent,\n+  DialogDescription,\n+  DialogFooter,\n+  DialogHeader,\n+  DialogTitle,\n+} from \"@/components/ui/dialog\";\n+import { Input } from \"@/components/ui/input\";\n+import { Label } from \"@/components/ui/label\";\n+import { Textarea } from \"@/components/ui/textarea\";\n+import { Checkbox } from \"@/components/ui/checkbox\";\n+import { Plus, MoreHorizontal, Edit, Trash2, MessageSquare, Eye, TrendingUp, Copy, ArrowUp, ArrowDown, Send, Users, Search, Phone, Loader2, Download, CheckCircle2 } from \"lucide-react\";\n import { WhatsAppTemplate } from \"@/types\";\n-import { useState, useEffect } from \"react\";\n+import { useState, useEffect, useCallback, useRef } from \"react\";\n import { useRouter } from \"next/navigation\";\n import Link from \"next/link\";\n import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from \"@/components/ui/tooltip\";\n@@ -35,6 +47,16 @@ import { whatsappTemplateEndpoints } from \"@/lib/api\";\n import { mapBackendArrayToFrontend } from \"@/lib/whatsappTemplateMapper\";\n import { toast } from \"sonner\";\n import { TemplatePreviewModal } from \"@/components/campaigns/whatsapp/template/template-preview-modal\";\n+import { ProductFilterDropdowns, type ProductFilter } from \"@/components/campaigns/product-filter-dropdowns\";\n+\n+interface Recipient {\n+  id: string;\n+  name: string;\n+  firstName: string;\n+  lastName: string;\n+  phone: string;\n+  email?: string;\n+}\n \n const getStatusBadge = (status: string) => {\n   switch (status) {\n@@ -120,6 +142,39 @@ export default function WhatsAppTemplatesPage() {\n   const [isPreviewOpen, setIsPreviewOpen] = useState(false);\n   const [deletingTemplateId, setDeletingTemplateId] = useState<string | null>(null);\n \n+  // Send dialog states\n+  const [showSendDialog, setShowSendDialog] = useState(false);\n+  const [selectedTemplate, setSelectedTemplate] = useState<WhatsAppTemplate | null>(null);\n+  const [recipients, setRecipients] = useState<Recipient[]>([]);\n+  const [selectedRecipientsMap, setSelectedRecipientsMap] = useState<Map<string, Recipient>>(new Map());\n+  const [recipientSearch, setRecipientSearch] = useState(\"\");\n+  const [recipientsTotal, setRecipientsTotal] = useState(0);\n+  const [isLoadingRecipients, setIsLoadingRecipients] = useState(false);\n+  const [isLoadingMore, setIsLoadingMore] = useState(false);\n+  const [hasMoreRecipients, setHasMoreRecipients] = useState(false);\n+  const [isSending, setIsSending] = useState(false);\n+  const [isSendingToAll, setIsSendingToAll] = useState(false);\n+  const [showSendToAllConfirm, setShowSendToAllConfirm] = useState(false);\n+  const [sendToAllCount, setSendToAllCount] = useState<\"all\" | number>(\"all\");\n+  const [customSendCount, setCustomSendCount] = useState(\"\");\n+  const [productFilter, setProductFilter] = useState<ProductFilter>({});\n+  const [extraPhones, setExtraPhones] = useState<string[]>(() => {\n+    if (typeof window !== \"undefined\") {\n+      const saved = localStorage.getItem(\"campaign-extra-phones\");\n+      if (saved) {\n+        return saved.split(/[\\n,;]+/).map((p) => p.trim().replace(/\\D/g, \"\")).filter((p) => p.length >= 7);\n+      }\n+    }\n+    return [];\n+  });\n+  const [extraPhonesText, setExtraPhonesText] = useState(() => {\n+    if (typeof window !== \"undefined\") {\n+      return localStorage.getItem(\"campaign-extra-phones\") || \"\";\n+    }\n+    return \"\";\n+  });\n+  const [showAddPhonesDialog, setShowAddPhonesDialog] = useState(false);\n+\n   useEffect(() => {\n     const fetchTemplates = async () => {\n       try {\n@@ -199,6 +254,198 @@ export default function WhatsAppTemplatesPage() {\n     }\n   };\n \n+  // ==================== SEND DIALOG LOGIC ====================\n+\n+  const RECIPIENTS_PAGE_SIZE = 500;\n+\n+  const mapUsers = (users: any[]): Recipient[] =>\n+    users.map((user: any) => ({\n+      id: user.id,\n+      name: user.name,\n+      firstName: user.firstName,\n+      lastName: user.lastName,\n+      phone: user.phone,\n+      email: user.email,\n+    }));\n+\n+  const loadRecipients = useCallback(async (search?: string, filter?: ProductFilter) => {\n+    setIsLoadingRecipients(true);\n+    setRecipients([]);\n+    try {\n+      let url = `${process.env.NEXT_PUBLIC_API_URL || \"http://localhost:3001\"}/api/users/campaigns/sms-recipients?limit=${RECIPIENTS_PAGE_SIZE}&offset=0${search ? `&search=${encodeURIComponent(search)}` : \"\"}`;\n+      if (filter?.categoria) url += `&categoria=${encodeURIComponent(filter.categoria)}`;\n+      if (filter?.subcategoria) url += `&subcategoria=${encodeURIComponent(filter.subcategoria)}`;\n+      if (filter?.modelo) url += `&modelo=${encodeURIComponent(filter.modelo)}`;\n+      const response = await fetch(url, {\n+        headers: { \"X-API-Key\": process.env.NEXT_PUBLIC_API_KEY || \"\" },\n+      });\n+      if (response.ok) {\n+        const data = await response.json();\n+        const recipientsList = mapUsers(data.users || []);\n+        setRecipients(recipientsList);\n+        setRecipientsTotal(data.total || recipientsList.length);\n+        setHasMoreRecipients(recipientsList.length < (data.total || 0));\n+      } else {\n+        toast.error(\"Error al cargar destinatarios\");\n+      }\n+    } catch (error) {\n+      console.error(\"Error loading recipients:\", error);\n+      toast.error(\"Error al cargar destinatarios\");\n+    } finally {\n+      setIsLoadingRecipients(false);\n+    }\n+  }, []);\n+\n+  const loadMoreRecipients = useCallback(async () => {\n+    setIsLoadingMore(true);\n+    try {\n+      let url = `${process.env.NEXT_PUBLIC_API_URL || \"http://localhost:3001\"}/api/users/campaigns/sms-recipients?limit=${RECIPIENTS_PAGE_SIZE}&offset=${recipients.length}${recipientSearch ? `&search=${encodeURIComponent(recipientSearch)}` : \"\"}`;\n+      if (productFilter?.categoria) url += `&categoria=${encodeURIComponent(productFilter.categoria)}`;\n+      if (productFilter?.subcategoria) url += `&subcategoria=${encodeURIComponent(productFilter.subcategoria)}`;\n+      if (productFilter?.modelo) url += `&modelo=${encodeURIComponent(productFilter.modelo)}`;\n+      const response = await fetch(url, {\n+        headers: { \"X-API-Key\": process.env.NEXT_PUBLIC_API_KEY || \"\" },\n+      });\n+      if (response.ok) {\n+        const data = await response.json();\n+        const newUsers = mapUsers(data.users || []);\n+        if (newUsers.length === 0) {\n+          setHasMoreRecipients(false);\n+        } else {\n+          setRecipients((prev) => [...prev, ...newUsers]);\n+          setRecipientsTotal(data.total || 0);\n+          setHasMoreRecipients(recipients.length + newUsers.length < (data.total || 0));\n+        }\n+      }\n+    } catch (error) {\n+      console.error(\"Error loading more recipients:\", error);\n+    } finally {\n+      setIsLoadingMore(false);\n+    }\n+  }, [recipients.length, recipientSearch, productFilter]);\n+\n+  // Infinite scroll\n+  const loadMoreSentinelRef = useRef<HTMLDivElement | null>(null);\n+  const scrollContainerRef = useRef<HTMLDivElement | null>(null);\n+\n+  useEffect(() => {\n+    const sentinel = loadMoreSentinelRef.current;\n+    const scrollContainer = scrollContainerRef.current;\n+    if (!sentinel || !scrollContainer) return;\n+    const observer = new IntersectionObserver(\n+      (entries) => {\n+        if (entries[0].isIntersecting && hasMoreRecipients && !isLoadingMore && !isLoadingRecipients) {\n+          loadMoreRecipients();\n+        }\n+      },\n+      { root: scrollContainer, threshold: 0.1 }\n+    );\n+    observer.observe(sentinel);\n+    return () => observer.disconnect();\n+  }, [hasMoreRecipients, isLoadingMore, isLoadingRecipients, loadMoreRecipients]);\n+\n+  const toggleRecipient = (recipient: Recipient) => {\n+    setSelectedRecipientsMap((prev) => {\n+      const newMap = new Map(prev);\n+      if (newMap.has(recipient.id)) {\n+        newMap.delete(recipient.id);\n+      } else {\n+        newMap.set(recipient.id, recipient);\n+      }\n+      return newMap;\n+    });\n+  };\n+\n+  const selectAllRecipients = () => {\n+    setSelectedRecipientsMap((prev) => {\n+      const newMap = new Map(prev);\n+      recipients.forEach((r) => newMap.set(r.id, r));\n+      return newMap;\n+    });\n+  };\n+\n+  const deselectAllRecipients = () => {\n+    setSelectedRecipientsMap(new Map());\n+  };\n+\n+  const handleOpenSendDialog = (template: WhatsAppTemplate) => {\n+    setSelectedTemplate(template);\n+    setSelectedRecipientsMap(new Map());\n+    setRecipientSearch(\"\");\n+    loadRecipients(undefined, productFilter);\n+    setShowSendDialog(true);\n+  };\n+\n+  const handleSendToSelected = async () => {\n+    if (!selectedTemplate || selectedRecipientsMap.size === 0) return;\n+    setIsSending(true);\n+    try {\n+      const selectedUsers = Array.from(selectedRecipientsMap.values());\n+      const recipientsData = selectedUsers.map((r) => {\n+        const whatsappPhone = r.phone.startsWith(\"57\") ? r.phone : `57${r.phone.replace(/\\D/g, \"\")}`;\n+        return {\n+          to: whatsappPhone,\n+          variables: r.firstName ? [r.firstName] : [],\n+        };\n+      });\n+      const response = await whatsappTemplateEndpoints.sendTemplateBulk({\n+        template_id: selectedTemplate.id,\n+        recipients: recipientsData,\n+      });\n+      if (response.success && response.data) {\n+        toast.success(`Envío iniciado para ${recipientsData.length} destinatarios`);\n+        setShowSendDialog(false);\n+        setSelectedRecipientsMap(new Map());\n+      } else {\n+        toast.error(response.message || \"Error al enviar WhatsApp\");\n+      }\n+    } catch (error) {\n+      console.error(\"Error sending WhatsApp:\", error);\n+      toast.error(\"Error al enviar los mensajes\");\n+    } finally {\n+      setIsSending(false);\n+    }\n+  };\n+\n+  const handleSendToAll = async () => {\n+    if (!selectedTemplate) return;\n+    setIsSendingToAll(true);\n+    try {\n+      const maxRecipients = sendToAllCount === \"all\" ? undefined : sendToAllCount;\n+      const activeFilter = productFilter?.categoria ? productFilter : undefined;\n+      const response = await whatsappTemplateEndpoints.sendToAll(\n+        selectedTemplate.id,\n+        maxRecipients,\n+        activeFilter,\n+        extraPhones.length > 0 ? extraPhones : undefined,\n+      );\n+      if (response.success && response.data) {\n+        const { estimatedTotal } = response.data;\n+        const extraCount = extraPhones.length;\n+        const totalWithExtra = (estimatedTotal || 0) + extraCount;\n+        const secs = Math.ceil(totalWithExtra / 10); // ~10 msg/s for WhatsApp (more conservative)\n+        const timeStr = secs < 60 ? `${secs}s` : secs < 3600 ? `${Math.ceil(secs / 60)} min` : `${Math.floor(secs / 3600)}h ${Math.ceil((secs % 3600) / 60)}min`;\n+        toast.success(\n+          `Envío iniciado para ${totalWithExtra.toLocaleString()} destinatarios${extraCount > 0 ? ` (incluye ${extraCount} teléfonos adicionales)` : \"\"}. Tiempo estimado: ~${timeStr}.`\n+        );\n+        setShowSendToAllConfirm(false);\n+        setShowSendDialog(false);\n+        setExtraPhones([]);\n+        setExtraPhonesText(\"\");\n+        localStorage.removeItem(\"campaign-extra-phones\");\n+      } else {\n+        toast.error(response.message || \"Error al enviar WhatsApp\");\n+      }\n+    } catch (error) {\n+      console.error(\"Error sending WhatsApp to all:\", error);\n+      toast.error(\"Error al enviar los mensajes\");\n+    } finally {\n+      setIsSendingToAll(false);\n+    }\n+  };\n+\n+  // ==================== TABLE COLUMNS ====================\n+\n   const columns: ColumnDef<WhatsAppTemplate>[] = [\n     {\n       accessorKey: \"name\",\n@@ -362,7 +609,6 @@ export default function WhatsAppTemplatesPage() {\n                       <MetricCard\n                         label=\"CTR\"\n                         value={`${template.metrics.ctr}%`}\n-                        change={template.status === 'active' ? Number.parseFloat((Math.random() * 8 - 4).toFixed(1)) : undefined}\n                         icon={TrendingUp}\n                         compact\n                       />\n@@ -379,7 +625,6 @@ export default function WhatsAppTemplatesPage() {\n                     <MetricCard\n                       label=\"Tasa apertura\"\n                       value={`${template.metrics.openRate}%`}\n-                      change={template.status === 'active' ? Number.parseFloat((Math.random() * 10 - 5).toFixed(1)) : undefined}\n                       icon={Eye}\n                       compact\n                     />\n@@ -429,6 +674,12 @@ export default function WhatsAppTemplatesPage() {\n                 <Eye className=\"mr-2 h-4 w-4\" />\n                 Vista previa\n               </DropdownMenuItem>\n+              {template.status === \"active\" && (\n+                <DropdownMenuItem onClick={() => handleOpenSendDialog(template)}>\n+                  <Send className=\"mr-2 h-4 w-4\" />\n+                  Enviar\n+                </DropdownMenuItem>\n+              )}\n               <DropdownMenuSeparator />\n               <AlertDialog>\n                 <AlertDialogTrigger asChild>\n@@ -546,7 +797,7 @@ export default function WhatsAppTemplatesPage() {\n                   {templates.reduce((acc, t) => acc + t.metrics.sent, 0).toLocaleString()}\n                 </div>\n                 <p className=\"text-xs text-muted-foreground\">\n-                  Este mes\n+                  Total enviados\n                 </p>\n               </>\n             )}\n@@ -572,8 +823,8 @@ export default function WhatsAppTemplatesPage() {\n                     : '0.0'\n                   }%\n                 </div>\n-                <p className=\"text-xs text-green-600\">\n-                  +2.1% vs mes anterior\n+                <p className=\"text-xs text-muted-foreground\">\n+                  Basado en mensajes leídos\n                 </p>\n               </>\n             )}\n@@ -599,8 +850,8 @@ export default function WhatsAppTemplatesPage() {\n                     : '0.0'\n                   }%\n                 </div>\n-                <p className=\"text-xs text-green-600\">\n-                  +1.8% vs mes anterior\n+                <p className=\"text-xs text-muted-foreground\">\n+                  Basado en clics sobre entregados\n                 </p>\n               </>\n             )}\n@@ -646,6 +897,387 @@ export default function WhatsAppTemplatesPage() {\n         isOpen={isPreviewOpen}\n         onClose={handleClosePreview}\n       />\n+\n+      {/* Send Dialog */}\n+      <Dialog open={showSendDialog} onOpenChange={setShowSendDialog}>\n+        <DialogContent className=\"!max-w-3xl h-[85vh]\">\n+          <DialogHeader>\n+            <DialogTitle className=\"flex items-center gap-2\">\n+              <Send className=\"h-5 w-5\" />\n+              Enviar WhatsApp\n+            </DialogTitle>\n+            <DialogDescription>\n+              Selecciona los destinatarios para enviar la plantilla &quot;{selectedTemplate?.name}&quot;\n+            </DialogDescription>\n+          </DialogHeader>\n+\n+          <div className=\"space-y-4 flex-1 overflow-hidden flex flex-col\">\n+            {/* Info del template */}\n+            <div className=\"flex items-center gap-3 p-3 bg-muted/50 rounded-lg border\">\n+              <div className=\"h-10 w-10 rounded bg-green-100 dark:bg-green-900 flex items-center justify-center flex-shrink-0\">\n+                <MessageSquare className=\"h-5 w-5 text-green-600\" />\n+              </div>\n+              <div className=\"flex-1 min-w-0\">\n+                <p className=\"text-xs text-muted-foreground uppercase font-medium\">Plantilla</p>\n+                <p className=\"font-medium truncate\">{selectedTemplate?.name}</p>\n+              </div>\n+              {selectedTemplate?.category && getCategoryBadge(selectedTemplate.category)}\n+            </div>\n+\n+            {/* Total de destinatarios + Agregar teléfonos + Enviar a todos */}\n+            {recipientsTotal > 0 && (\n+              <div className=\"flex items-center gap-3 p-3 bg-green-50 dark:bg-green-950/30 rounded-lg border border-green-200 dark:border-green-900\">\n+                <div className=\"h-10 w-10 rounded bg-green-100 dark:bg-green-900 flex items-center justify-center flex-shrink-0\">\n+                  <Users className=\"h-5 w-5 text-green-600\" />\n+                </div>\n+                <div className=\"flex-1\">\n+                  <p className=\"font-bold text-lg text-green-600\">\n+                    {(recipientsTotal + extraPhones.length).toLocaleString()} destinatarios\n+                    {extraPhones.length > 0 && (\n+                      <span className=\"text-sm font-normal ml-1\">\n+                        ({recipientsTotal.toLocaleString()} + {extraPhones.length} extra)\n+                      </span>\n+                    )}\n+                  </p>\n+                </div>\n+                <Button\n+                  variant=\"outline\"\n+                  size=\"sm\"\n+                  onClick={() => setShowAddPhonesDialog(true)}\n+                  className=\"gap-1 border-green-300 text-green-700 hover:bg-green-100 dark:hover:bg-green-900\"\n+                >\n+                  <Plus className=\"h-4 w-4\" />\n+                  {extraPhones.length > 0 ? `${extraPhones.length} extra` : \"Agregar\"}\n+                </Button>\n+                <Button\n+                  onClick={() => setShowSendToAllConfirm(true)}\n+                  disabled={isSendingToAll}\n+                  className=\"gap-2 bg-green-600 hover:bg-green-700\"\n+                >\n+                  <Send className=\"h-4 w-4\" />\n+                  Enviar a todos\n+                </Button>\n+              </div>\n+            )}\n+\n+            {/* Filtro de segmentación por producto */}\n+            <ProductFilterDropdowns\n+              value={productFilter}\n+              onChange={(filter) => {\n+                setProductFilter(filter);\n+                loadRecipients(recipientSearch, filter);\n+              }}\n+            />\n+\n+            {/* Buscador y controles */}\n+            <div className=\"flex items-center gap-2 flex-wrap\">\n+              <div className=\"relative flex-1 min-w-[200px]\">\n+                <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n+                <Input\n+                  placeholder=\"Buscar por nombre, email o teléfono...\"\n+                  value={recipientSearch}\n+                  onChange={(e) => setRecipientSearch(e.target.value)}\n+                  onKeyDown={(e) => {\n+                    if (e.key === \"Enter\") loadRecipients(recipientSearch, productFilter);\n+                  }}\n+                  className=\"pl-9\"\n+                />\n+              </div>\n+              <Button variant=\"outline\" size=\"sm\" onClick={() => loadRecipients(recipientSearch, productFilter)} disabled={isLoadingRecipients}>\n+                {isLoadingRecipients ? <Loader2 className=\"h-4 w-4 animate-spin\" /> : \"Buscar\"}\n+              </Button>\n+              <Button variant=\"outline\" size=\"sm\" onClick={selectAllRecipients}>Seleccionar cargados</Button>\n+              <Button variant=\"outline\" size=\"sm\" onClick={deselectAllRecipients}>Limpiar</Button>\n+              <Button\n+                variant=\"outline\"\n+                size=\"sm\"\n+                onClick={() => {\n+                  const csvContent = [\n+                    [\"Nombre\", \"Teléfono\", \"Email\"].join(\",\"),\n+                    ...recipients.map((r) => [`\"${r.name.replace(/\"/g, '\"\"')}\"`, `\"${r.phone}\"`, `\"${r.email || \"\"}\"`].join(\",\"))\n+                  ].join(\"\\n\");\n+                  const blob = new Blob([csvContent], { type: \"text/csv;charset=utf-8;\" });\n+                  const url = URL.createObjectURL(blob);\n+                  const a = document.createElement(\"a\");\n+                  a.href = url;\n+                  a.download = `destinatarios-whatsapp-${new Date().toISOString().split(\"T\")[0]}.csv`;\n+                  document.body.appendChild(a);\n+                  a.click();\n+                  document.body.removeChild(a);\n+                  URL.revokeObjectURL(url);\n+                  toast.success(`${recipients.length} contactos exportados a CSV`);\n+                }}\n+                disabled={recipients.length === 0}\n+                className=\"gap-1\"\n+              >\n+                <Download className=\"h-4 w-4\" />\n+                CSV\n+              </Button>\n+            </div>\n+\n+            {/* Contador de seleccionados */}\n+            <div className=\"flex items-center gap-2\">\n+              <Users className=\"h-4 w-4 text-muted-foreground\" />\n+              <span className=\"text-sm text-muted-foreground\">\n+                {selectedRecipientsMap.size} seleccionados · Mostrando {recipients.length} de {recipientsTotal.toLocaleString()} destinatarios\n+              </span>\n+              {selectedRecipientsMap.size > 0 && (\n+                <Badge variant=\"secondary\" className=\"ml-auto\">\n+                  <CheckCircle2 className=\"h-3 w-3 mr-1\" />\n+                  {selectedRecipientsMap.size} seleccionados\n+                </Badge>\n+              )}\n+            </div>\n+\n+            {/* Lista de destinatarios */}\n+            <div ref={scrollContainerRef} className=\"flex-1 border rounded-lg h-[350px] overflow-y-auto\">\n+              <div className=\"p-2 space-y-1\">\n+                {isLoadingRecipients ? (\n+                  <div className=\"flex items-center justify-center py-8\">\n+                    <Loader2 className=\"h-6 w-6 animate-spin text-muted-foreground\" />\n+                    <span className=\"ml-2 text-muted-foreground\">Cargando destinatarios...</span>\n+                  </div>\n+                ) : recipients.length === 0 ? (\n+                  <div className=\"text-center py-8 text-muted-foreground\">\n+                    <Phone className=\"h-12 w-12 mx-auto mb-4 opacity-50\" />\n+                    <p>Haz clic en Buscar para cargar destinatarios</p>\n+                    <p className=\"text-xs mt-1\">Solo se mostrarán usuarios con número de teléfono</p>\n+                  </div>\n+                ) : (\n+                  <>\n+                    {recipients.map((recipient) => (\n+                      <div\n+                        key={recipient.id}\n+                        className={`flex items-center gap-3 p-3 rounded-lg cursor-pointer transition-colors ${\n+                          selectedRecipientsMap.has(recipient.id)\n+                            ? \"bg-primary/10 border border-primary/20\"\n+                            : \"hover:bg-muted\"\n+                        }`}\n+                        onClick={() => toggleRecipient(recipient)}\n+                      >\n+                        <Checkbox\n+                          checked={selectedRecipientsMap.has(recipient.id)}\n+                          onClick={(e) => e.stopPropagation()}\n+                          onCheckedChange={() => toggleRecipient(recipient)}\n+                        />\n+                        <div className=\"flex-1 min-w-0\">\n+                          <div className=\"flex items-center gap-2\">\n+                            <span className=\"font-medium truncate\">{recipient.name}</span>\n+                          </div>\n+                          <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n+                            <Phone className=\"h-3 w-3\" />\n+                            <span className=\"truncate\">{recipient.phone}</span>\n+                          </div>\n+                        </div>\n+                      </div>\n+                    ))}\n+                    {/* Sentinel para infinite scroll */}\n+                    {hasMoreRecipients && (\n+                      <div ref={loadMoreSentinelRef} className=\"flex items-center justify-center py-4\">\n+                        {isLoadingMore ? (\n+                          <>\n+                            <Loader2 className=\"h-4 w-4 animate-spin text-muted-foreground\" />\n+                            <span className=\"ml-2 text-xs text-muted-foreground\">Cargando más...</span>\n+                          </>\n+                        ) : (\n+                          <span className=\"text-xs text-muted-foreground\">Scroll para cargar más</span>\n+                        )}\n+                      </div>\n+                    )}\n+                  </>\n+                )}\n+              </div>\n+            </div>\n+          </div>\n+\n+          <DialogFooter className=\"mt-4\">\n+            <Button variant=\"outline\" onClick={() => { setShowSendDialog(false); setSelectedRecipientsMap(new Map()); }}>\n+              Cancelar\n+            </Button>\n+            <Button\n+              onClick={handleSendToSelected}\n+              disabled={isSending || selectedRecipientsMap.size === 0}\n+              className=\"bg-green-600 hover:bg-green-700\"\n+            >\n+              {isSending ? (\n+                <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n+              ) : (\n+                <Send className=\"mr-2 h-4 w-4\" />\n+              )}\n+              Enviar a {selectedRecipientsMap.size} destinatario(s)\n+            </Button>\n+          </DialogFooter>\n+        </DialogContent>\n+      </Dialog>\n+\n+      {/* Dialog de confirmación para enviar a todos */}\n+      <Dialog open={showSendToAllConfirm} onOpenChange={(open) => {\n+        setShowSendToAllConfirm(open);\n+        if (!open) { setSendToAllCount(\"all\"); setCustomSendCount(\"\"); }\n+      }}>\n+        <DialogContent className=\"max-w-md\">\n+          <DialogHeader>\n+            <DialogTitle className=\"flex items-center gap-2 text-green-600\">\n+              <Users className=\"h-5 w-5\" />\n+              Enviar WhatsApp masivo\n+            </DialogTitle>\n+            <DialogDescription>\n+              Selecciona cuántos destinatarios quieres alcanzar.\n+              El envío se procesará en lotes en el servidor.\n+            </DialogDescription>\n+          </DialogHeader>\n+          <div className=\"space-y-3 py-2\">\n+            <div className=\"space-y-2\">\n+              <Label className=\"text-sm font-medium\">Cantidad de destinatarios</Label>\n+              <div className=\"grid grid-cols-2 gap-2\">\n+                {[\n+                  { value: \"all\" as const, label: `Todos (${recipientsTotal.toLocaleString()})` },\n+                  { value: 500, label: \"500\" },\n+                  { value: 1000, label: \"1.000\" },\n+                  { value: 5000, label: \"5.000\" },\n+                ].map((opt) => (\n+                  <button\n+                    key={String(opt.value)}\n+                    type=\"button\"\n+                    onClick={() => { setSendToAllCount(opt.value); setCustomSendCount(\"\"); }}\n+                    className={`px-3 py-2 text-sm rounded-lg border transition-colors ${\n+                      sendToAllCount === opt.value\n+                        ? \"border-green-500 bg-green-50 dark:bg-green-950/40 text-green-700 dark:text-green-300 font-medium\"\n+                        : \"border-border hover:border-green-300 hover:bg-muted/50\"\n+                    }`}\n+                  >\n+                    {opt.label}\n+                  </button>\n+                ))}\n+              </div>\n+              <div className=\"flex items-center gap-2\">\n+                <Input\n+                  type=\"number\"\n+                  placeholder=\"Cantidad personalizada...\"\n+                  min={1}\n+                  max={recipientsTotal}\n+                  value={customSendCount}\n+                  onChange={(e) => {\n+                    setCustomSendCount(e.target.value);\n+                    const num = parseInt(e.target.value, 10);\n+                    if (num > 0) setSendToAllCount(num);\n+                  }}\n+                  onFocus={() => {\n+                    if (typeof sendToAllCount !== \"number\" || [500, 1000, 5000].includes(sendToAllCount)) {\n+                      setSendToAllCount(0);\n+                    }\n+                  }}\n+                  className={`flex-1 ${customSendCount ? \"border-green-500\" : \"\"}`}\n+                />\n+              </div>\n+            </div>\n+\n+            <div className=\"flex justify-between text-sm p-3 bg-muted/50 rounded-lg\">\n+              <span className=\"text-muted-foreground\">Enviar a:</span>\n+              <span className=\"font-bold\">\n+                {sendToAllCount === \"all\"\n+                  ? `${recipientsTotal.toLocaleString()} destinatarios`\n+                  : `${sendToAllCount.toLocaleString()} destinatarios`}\n+              </span>\n+            </div>\n+            <div className=\"flex justify-between text-sm p-3 bg-muted/50 rounded-lg\">\n+              <span className=\"text-muted-foreground\">Tiempo estimado:</span>\n+              <span className=\"font-bold\">\n+                {(() => {\n+                  const count = sendToAllCount === \"all\" ? recipientsTotal : sendToAllCount;\n+                  const totalSeg = Math.ceil(count / 10); // ~10 msg/s for WhatsApp\n+                  if (totalSeg < 60) return `~${totalSeg} segundos`;\n+                  if (totalSeg < 3600) return `~${Math.ceil(totalSeg / 60)} minutos`;\n+                  const h = Math.floor(totalSeg / 3600);\n+                  const m = Math.ceil((totalSeg % 3600) / 60);\n+                  return `~${h}h ${m}min`;\n+                })()}\n+              </span>\n+            </div>\n+          </div>\n+          <DialogFooter className=\"flex flex-col sm:flex-row gap-2\">\n+            <Button variant=\"outline\" onClick={() => setShowSendToAllConfirm(false)} disabled={isSendingToAll}>\n+              Cancelar\n+            </Button>\n+            <Button\n+              onClick={handleSendToAll}\n+              disabled={isSendingToAll || (typeof sendToAllCount === \"number\" && sendToAllCount <= 0)}\n+              className=\"bg-green-600 hover:bg-green-700\"\n+            >\n+              {isSendingToAll ? (\n+                <>\n+                  <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n+                  Iniciando envío...\n+                </>\n+              ) : (\n+                <>\n+                  <Send className=\"mr-2 h-4 w-4\" />\n+                  Confirmar envío a {(sendToAllCount === \"all\" ? recipientsTotal : sendToAllCount).toLocaleString()}\n+                </>\n+              )}\n+            </Button>\n+          </DialogFooter>\n+        </DialogContent>\n+      </Dialog>\n+\n+      {/* Dialog para agregar teléfonos extra */}\n+      <Dialog open={showAddPhonesDialog} onOpenChange={setShowAddPhonesDialog}>\n+        <DialogContent className=\"max-w-md\">\n+          <DialogHeader>\n+            <DialogTitle className=\"flex items-center gap-2 text-green-600\">\n+              <Phone className=\"h-5 w-5\" />\n+              Agregar teléfonos adicionales\n+            </DialogTitle>\n+            <DialogDescription>\n+              Escribe los números de teléfono a los que también quieres enviar, uno por línea o separados por comas.\n+            </DialogDescription>\n+          </DialogHeader>\n+          <div className=\"space-y-3 py-2\">\n+            <Textarea\n+              placeholder={\"3151234567\\n3209876543\\n3001112233\"}\n+              value={extraPhonesText}\n+              onChange={(e) => setExtraPhonesText(e.target.value)}\n+              rows={6}\n+              className=\"font-mono text-sm\"\n+            />\n+            <p className=\"text-xs text-muted-foreground\">\n+              {(() => {\n+                const parsed = extraPhonesText.split(/[\\n,;]+/).map((p) => p.trim().replace(/\\D/g, \"\")).filter((p) => p.length >= 7);\n+                const unique = [...new Set(parsed)];\n+                return `${unique.length} teléfono${unique.length !== 1 ? \"s\" : \"\"} válido${unique.length !== 1 ? \"s\" : \"\"} detectado${unique.length !== 1 ? \"s\" : \"\"}`;\n+              })()}\n+            </p>\n+          </div>\n+          <DialogFooter>\n+            <Button variant=\"outline\" onClick={() => { setExtraPhonesText(extraPhones.join(\"\\n\")); setShowAddPhonesDialog(false); }}>\n+              Cancelar\n+            </Button>\n+            <Button\n+              className=\"bg-green-600 hover:bg-green-700\"\n+              onClick={() => {\n+                const parsed = extraPhonesText.split(/[\\n,;]+/).map((p) => p.trim().replace(/\\D/g, \"\")).filter((p) => p.length >= 7);\n+                const unique = [...new Set(parsed)];\n+                setExtraPhones(unique);\n+                if (unique.length > 0) {\n+                  localStorage.setItem(\"campaign-extra-phones\", unique.join(\"\\n\"));\n+                } else {\n+                  localStorage.removeItem(\"campaign-extra-phones\");\n+                }\n+                setShowAddPhonesDialog(false);\n+                if (unique.length > 0) {\n+                  toast.success(`${unique.length} teléfono${unique.length !== 1 ? \"s\" : \"\"} adicional${unique.length !== 1 ? \"es\" : \"\"} agregado${unique.length !== 1 ? \"s\" : \"\"}`);\n+                }\n+              }}\n+            >\n+              <Plus className=\"mr-2 h-4 w-4\" />\n+              Guardar ({(() => {\n+                const parsed = extraPhonesText.split(/[\\n,;]+/).map((p) => p.trim().replace(/\\D/g, \"\")).filter((p) => p.length >= 7);\n+                return [...new Set(parsed)].length;\n+              })()} teléfonos)\n+            </Button>\n+          </DialogFooter>\n+        </DialogContent>\n+      </Dialog>\n     </div>\n   );\n }\n\\ No newline at end of file\ndiff --git a/src/components/campaigns/email/unlayer-email-editor.tsx b/src/components/campaigns/email/unlayer-email-editor.tsx\nindex a79eb40..b3942e8 100644\n--- a/src/components/campaigns/email/unlayer-email-editor.tsx\n+++ b/src/components/campaigns/email/unlayer-email-editor.tsx\n@@ -402,6 +402,7 @@ export function UnlayerEmailEditor({\n         setEmailSubject(\"\");\n         setExtraEmails([]);\n         setExtraEmailsText(\"\");\n+        localStorage.removeItem(\"campaign-extra-emails\");\n       } else {\n         toast.error(response.message || \"Error al iniciar el envío de emails\");\n       }\ndiff --git a/src/components/campaigns/whatsapp/template/template-form.tsx b/src/components/campaigns/whatsapp/template/template-form.tsx\nindex 87e8f66..bbfe366 100644\n--- a/src/components/campaigns/whatsapp/template/template-form.tsx\n+++ b/src/components/campaigns/whatsapp/template/template-form.tsx\n@@ -178,10 +178,16 @@ export function WhatsAppTemplateForm({\n               </SelectTrigger>\n               <SelectContent>\n                 <SelectItem value=\"MARKETING\">Marketing</SelectItem>\n-                <SelectItem value=\"UTILITY\">Utilidad</SelectItem>\n+                <SelectItem value=\"UTILITY\">Utilidad (Recomendado)</SelectItem>\n                 <SelectItem value=\"AUTHENTICATION\">Autenticación</SelectItem>\n               </SelectContent>\n             </Select>\n+            {templateData.category === \"MARKETING\" && (\n+              <p className=\"text-xs text-amber-600 dark:text-amber-400 mt-1.5 flex items-start gap-1\">\n+                <span className=\"mt-0.5\">⚠️</span>\n+                <span>Los templates Marketing requieren opt-in del destinatario y pueden no entregarse. Se recomienda usar <strong>Utilidad</strong> para mejor entrega.</span>\n+              </p>\n+            )}\n           </div>\n \n           <div>\ndiff --git a/src/lib/api.ts b/src/lib/api.ts\nindex a3a5582..01bb8dc 100644\n--- a/src/lib/api.ts\n+++ b/src/lib/api.ts\n@@ -1547,6 +1547,17 @@ export const whatsappTemplateEndpoints = {\n       progress: number;\n       errors: Array<{ to: string; error: string }>;\n     }>(`/api/messaging/bulk-job/${jobId}`),\n+  sendToAll: (\n+    templateId: string,\n+    maxRecipients?: number,\n+    productFilter?: { categoria?: string; subcategoria?: string; modelo?: string },\n+    extraPhones?: string[],\n+  ) => {\n+    return apiClient.post<{ status: string; message: string; estimatedTotal: number }>(\n+      `/api/messaging/whatsapp-templates/${templateId}/send-to-all`,\n+      { maxRecipients, productFilter, extraPhones },\n+    );\n+  },\n };\n \n // Banner API endpoints\n@@ -2858,10 +2869,10 @@ export const smsTemplateEndpoints = {\n   },\n \n   // Enviar SMS a destinatarios usando un template (backend procesa en background)\n-  sendToAll: (templateId: string, maxRecipients?: number, productFilter?: { categoria?: string; subcategoria?: string; modelo?: string }) => {\n+  sendToAll: (templateId: string, maxRecipients?: number, productFilter?: { categoria?: string; subcategoria?: string; modelo?: string }, extraPhones?: string[]) => {\n     return apiClient.post<{ status: string; message: string; estimatedTotal: number }>(\n       `/api/messaging/sms-templates/${templateId}/send-to-all-sms`,\n-      { maxRecipients, productFilter },\n+      { maxRecipients, productFilter, extraPhones },\n     );\n   },\n \ndiff --git a/src/types/index.ts b/src/types/index.ts\nindex 137f54d..34345fe 100644\n--- a/src/types/index.ts\n+++ b/src/types/index.ts\n@@ -334,6 +334,7 @@ export interface BackendWhatsAppTemplate {\n   fecha_creacion?: string;\n   fecha_actualizacion?: string;\n   mensajes_enviados?: number;\n+  mensajes_fallidos?: number;\n   mensajes_entregados?: number;\n   mensajes_leidos?: number;\n   clics_enlaces?: number;\n"
test_patch: ''
fail_to_pass:
- npx tsx tests/sms-template-send-to-all-extra-phones.test.ts
pass_to_pass:
- npx tsx tests/sms-template-send-bulk-existing.test.ts
install_config:
  install: npm install
  node: '20'
  test_cmd: npm test
meta:
  added_lines: '882'
  difficulty: hard
  files_changed: '7'
  pr_title: 'feat: add support for including extra phone numbers in SMS campaigns.'
  removed_lines: '126'
  source: gh-archive-pr
  test_files: '[{"path":"tests/sms-template-send-to-all-extra-phones.test.ts","content":"import assert from \"node:assert/strict\";\nimport { smsTemplateEndpoints, apiClient } from \"../src/lib/api\";\n\nasync function run() {\n  const originalPost = apiClient.post.bind(apiClient);\n\n  try {\n    let capturedEndpoint: string | undefined;\n    let capturedData: any;\n    apiClient.post = async (endpoint: string, data?: unknown) => {\n      capturedEndpoint = endpoint;\n      capturedData = data;\n      return {\n        success: true,\n        data: { status: \"ok\", message: \"queued\", estimatedTotal: 25 },\n      } as any;\n    };\n\n    const extraPhones = [\"5551234567\", \"5559876543\"];\n    const maxRecipients = 42;\n    const productFilter = { categoria: \"smartphones\" };\n\n    await smsTemplateEndpoints.sendToAll(\n      \"template-abc\",\n      maxRecipients,\n      productFilter,\n      extraPhones\n    );\n\n    assert.equal(\n      capturedEndpoint,\n      \"/api/messaging/sms-templates/template-abc/send-to-all-sms\"\n    );\n    assert.deepEqual(capturedData, {\n      maxRecipients,\n      productFilter,\n      extraPhones,\n    });\n\n    apiClient.post = async (endpoint: string, data?: unknown) => {\n      capturedEndpoint = endpoint;\n      capturedData = data;\n      return {\n        success: true,\n        data: { status: \"ok\", message: \"queued\", estimatedTotal: 10 },\n      } as any;\n    };\n\n    await smsTemplateEndpoints.sendToAll(\n      \"template-def\",\n      undefined,\n      undefined,\n      undefined\n    );\n\n    assert.equal(\n      capturedEndpoint,\n      \"/api/messaging/sms-templates/template-def/send-to-all-sms\"\n    );\n    assert.deepEqual(capturedData, {\n      maxRecipients: undefined,\n      productFilter: undefined,\n      extraPhones: undefined,\n    });\n  } finally {\n    apiClient.post = originalPost;\n  }\n}\n\nrun().catch((error) => {\n  console.error(error);\n  process.exit(1);\n});\n"},{"path":"tests/sms-template-send-bulk-existing.test.ts","content":"import assert from \"node:assert/strict\";\nimport { smsTemplateEndpoints, apiClient } from \"../src/lib/api\";\n\nasync function run() {\n  const originalPost = apiClient.post.bind(apiClient);\n\n  try {\n    let capturedEndpoint: string | undefined;\n    let capturedData: any;\n\n    apiClient.post = async (endpoint: string, data?: unknown) => {\n      capturedEndpoint = endpoint;\n      capturedData = data;\n      return {\n        success: true,\n        data: { success: true, message: \"ok\" },\n      } as any;\n    };\n\n    const recipients = [\n      { phoneNumber: \"5550001111\", variables: { name: \"Ana\" } },\n      { phoneNumber: \"5550002222\", variables: { name: \"Luis\" } },\n    ];\n\n    await smsTemplateEndpoints.sendBulk(\"template-xyz\", recipients);\n\n    assert.equal(\n      capturedEndpoint,\n      \"/api/messaging/sms-templates/template-xyz/send-bulk\"\n    );\n    assert.deepEqual(capturedData, { recipients });\n  } finally {\n    apiClient.post = originalPost;\n  }\n}\n\nrun().catch((error) => {\n  console.error(error);\n  process.exit(1);\n});\n"}]'
  test_generation: agentic-docker
prompt: |-
  Botopia-Tecnology/imagiq-dashboard (#145): feat: add support for including extra phone numbers in SMS campaigns.

  Add support for including extra phone numbers in SMS campaigns so users can specify additional recipients beyond the existing list.
original_pr_body: |-
  Botopia-Tecnology/imagiq-dashboard (#145): feat: add support for including extra phone numbers in SMS campaigns.

  (no description)
quality_score: 0.74
quality_passed: true
docker_passed: false
workspace_path: null
status: ready
