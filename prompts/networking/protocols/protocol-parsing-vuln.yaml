id: "net-proto-parsing-vuln-001"
version: "2.0.0"
category: "networking"
subcategory: "protocols"

# ============================================================================
# PROTOCOL PARSING VULNERABILITY - COMPREHENSIVE FRAMEWORK
# ============================================================================
# This YAML enables generation of 10,000+ unique protocol parsing challenges
# covering HTTP/1.1, HTTP/2, HTTP/3/QUIC, TLS, WebSocket, gRPC, DNS, DNSSEC,
# SMTP, FTP, SSH, BGP, OSPF, MPLS, IPsec, SIP, RTP/RTCP, MQTT, CoAP, Modbus,
# and custom binary protocols.
# ============================================================================

# === LLM GENERATION FRAMEWORK ===
generation_framework:
  multi_conversation_workflow:
    phase_1_research: "Research obscure protocol behaviors and edge cases"
    phase_2_creation: "Create task with subtle networking bugs"
    phase_3_amplification: "Add protocol-specific complexity"
    phase_4_verification:
      description: "Validate task requires deep networking expertise"
      validation_criteria:
        - "Has at least 12+ deeply interacting traps across OSI layers"
        - "Has cascading protocol layer interactions (L2/L3/L4/L7)"
        - "Requires knowledge of kernel network stack internals"
        - "Would take 90-180 minutes for senior network engineers with kernel development experience"
  
  multi_agent_orchestration:
    description: "Complex multi-agent coordination for protocol parsing vulnerability analysis"
    required_agents:
      - agent: "packet_analyzer"
        role: "Deep protocol dissection and malformed packet detection"
        capabilities: ["Wireshark dissector analysis", "protocol state tracking", "byte-level parsing"]
      - agent: "kernel_debugger"
        role: "Kernel protocol stack analysis and crash investigation"
        capabilities: ["ftrace", "kprobe instrumentation", "netfilter hook analysis"]
      - agent: "protocol_fuzzer"
        role: "Automated protocol fuzzing and edge case generation"
        capabilities: ["AFL++", "libFuzzer", "grammar-based fuzzing", "coverage-guided mutation"]
      - agent: "memory_safety_analyzer"
        role: "Memory corruption and bounds checking analysis"
        capabilities: ["AddressSanitizer", "MemorySanitizer", "UBSan", "Valgrind"]
      - agent: "state_machine_verifier"
        role: "Protocol state machine formal verification"
        capabilities: ["model checking", "state explosion analysis", "transition coverage"]
      - agent: "crypto_analyzer"
        role: "Cryptographic protocol analysis"
        capabilities: ["TLS dissection", "key exchange verification", "cipher suite analysis"]
      - agent: "binary_analyzer"
        role: "Binary-level parsing vulnerability analysis"
        capabilities: ["IDA Pro", "Ghidra", "binary diffing", "ROP gadget analysis"]
      - agent: "network_simulator"
        role: "Complex network condition simulation"
        capabilities: ["packet loss injection", "reordering", "fragmentation", "MTU variation"]
    
    cross_layer_attack_chains:
      - chain: "L2->L3->L4->L7 protocol smuggling"
        description: "VLAN manipulation creates ambiguous frame boundaries enabling IP packet injection that desynchronizes TCP streams for HTTP request smuggling"
        stages:
          - "L2: 802.1Q double-tagging causes switch to forward to unintended VLAN"
          - "L3: IP options processing differences between hosts enable packet injection"
          - "L4: TCP segment boundary ambiguity with overlapping data"
          - "L7: HTTP CL.TE desync between load balancer and backend"
      
      - chain: "TLS->HTTP/2->gRPC downgrade"
        description: "TLS version confusion leads to HTTP/2 frame injection enabling gRPC message manipulation"
        stages:
          - "TLS: Renegotiation confusion with HTTP/2 ALPN"
          - "HTTP/2: HPACK compression bomb followed by priority manipulation"
          - "gRPC: Protobuf varint overflow causing field misinterpretation"
      
      - chain: "DNS->TLS->QUIC certificate confusion"
        description: "DNS rebinding enables certificate mismatch exploitation in QUIC 0-RTT"
        stages:
          - "DNS: TTL manipulation for rebinding attack"
          - "TLS: Certificate chain validation bypass with wildcard"
          - "QUIC: 0-RTT replay with stale session ticket"
    
    parallel_analysis_requirements:
      - "Simultaneous packet capture at multiple protocol layers with nanosecond correlation"
      - "Concurrent fuzzing of multiple protocol state machines"
      - "Real-time correlation of parser state with memory allocations"
      - "Cross-implementation differential testing (e.g., nginx vs Apache vs Envoy)"
    
    agent_handoff_protocols:
      - handoff: "protocol_fuzzer -> memory_safety_analyzer"
        trigger: "Crash or sanitizer alert during fuzzing"
        data_exchange: ["crash input", "stack trace", "memory state", "heap layout"]
      - handoff: "packet_analyzer -> state_machine_verifier"
        trigger: "Unexpected state transition detected"
        data_exchange: ["packet sequence", "state history", "transition log"]
      - handoff: "crypto_analyzer -> binary_analyzer"
        trigger: "Potential timing side-channel in crypto operation"
        data_exchange: ["timing measurements", "code paths", "branch conditions"]
      - handoff: "kernel_debugger -> network_simulator"
        trigger: "Kernel behavior depends on network conditions"
        data_exchange: ["kernel traces", "required network conditions", "timing requirements"]
  
  complexity_requirements:
    minimum_lines: 1000
    unique_combinations: 10000
    difficulty_floor: "advanced"
    requires_expertise:
      - "Protocol internals and RFCs"
      - "Binary parsing techniques"
      - "Security vulnerability patterns"
      - "Network programming edge cases"
      - "Cross-platform compatibility"

# ============================================================================
# PROBLEM STATEMENT SECTION
# ============================================================================
problem_statement: |
  A custom network protocol parser is vulnerable to several attacks. The parser
  handles binary messages with a header containing length fields, but the implementation
  has subtle bugs that lead to buffer overflows, integer overflows, and denial of service.
  
  The protocol format is:
  - 4 bytes: magic number (0xDEADBEEF)
  - 2 bytes: version (big-endian)
  - 4 bytes: payload length (big-endian)
  - N bytes: payload
  - 4 bytes: checksum (CRC32)
  
  Issues found in production:
  1. Malformed packets cause crashes
  2. Certain length values cause memory exhaustion
  3. Some packets bypass checksum validation
  
  Extended protocol complexity:
  - Supports fragmentation across multiple packets
  - Has optional extension headers
  - Version negotiation during handshake
  - Compression modes for payload
  - Encryption envelope support

requirements: |
  - Fix integer overflow in length field handling
  - Implement proper bounds checking
  - Add timeout handling for partial packets
  - Validate all header fields before processing
  - Handle endianness correctly on all platforms
  - Support protocol version negotiation
  - Implement secure fragmentation handling
  - Add defense against amplification attacks

interface: |
  Input: Raw binary network packet
  Output: Parsed message structure or error
  Functions: parse_packet(data: bytes) -> ParsedMessage
  Config: Protocol version, compression mode, encryption settings

# ============================================================================
# TOPIC UNIVERSE - 100+ UNIQUE TOPICS
# ============================================================================
topic_universe:
  # --------------------------------------------------------------------------
  # HTTP/1.1 PROTOCOL PARSING (15 topics)
  # --------------------------------------------------------------------------
  http_1_1_parsing:
    - topic: "http1_chunked_transfer_encoding"
      description: "Parse Transfer-Encoding: chunked with chunk extensions"
      complexity: "medium"
      rfc_reference: "RFC 7230 Section 4.1"
      attack_vectors:
        - "Chunk size overflow (0xFFFFFFFF + 1)"
        - "Negative chunk size via signed interpretation"
        - "Chunk extension injection"
        - "Trailer header smuggling"
      edge_cases:
        - "Zero-length chunk with extensions"
        - "Maximum chunk size handling"
        - "Mixed chunk sizes (tiny to huge)"
        - "Chunk boundaries at buffer limits"
    
    - topic: "http1_keep_alive_pipelining"
      description: "HTTP/1.1 persistent connections and request pipelining"
      complexity: "hard"
      rfc_reference: "RFC 7230 Section 6.3"
      attack_vectors:
        - "Request smuggling via CL.TE desync"
        - "Response queue poisoning"
        - "Connection reuse after error"
        - "Keep-alive timeout race conditions"
      edge_cases:
        - "Pipelined requests with different encodings"
        - "Connection close mid-pipeline"
        - "Interleaved partial responses"
        - "Head of line blocking exploitation"
    
    - topic: "http1_content_length_parsing"
      description: "Content-Length header parsing and validation"
      complexity: "medium"
      rfc_reference: "RFC 7230 Section 3.3.2"
      attack_vectors:
        - "Duplicate Content-Length headers"
        - "Negative Content-Length"
        - "Content-Length with leading zeros"
        - "Content-Length with whitespace"
      edge_cases:
        - "Content-Length: 0 with body"
        - "Missing Content-Length with body"
        - "Content-Length exceeds available memory"
        - "Content-Length with +/- prefix"
    
    - topic: "http1_header_field_parsing"
      description: "HTTP header field name and value parsing"
      complexity: "medium"
      rfc_reference: "RFC 7230 Section 3.2"
      attack_vectors:
        - "Header injection via CRLF"
        - "Null byte in header value"
        - "Header name with invalid characters"
        - "Obsolete line folding (obs-fold)"
      edge_cases:
        - "Maximum header line length"
        - "Empty header value"
        - "Header with only whitespace value"
        - "Case sensitivity in header names"
    
    - topic: "http1_request_line_parsing"
      description: "HTTP request line (method, URI, version)"
      complexity: "medium"
      rfc_reference: "RFC 7230 Section 3.1.1"
      attack_vectors:
        - "Method case sensitivity bypass"
        - "URI with embedded null bytes"
        - "HTTP version downgrade"
        - "Request line with extra spaces"
      edge_cases:
        - "Maximum URI length"
        - "Invalid HTTP version format"
        - "Unicode in URI"
        - "Request line without version"
    
    - topic: "http1_multipart_form_data"
      description: "Multipart form data boundary parsing"
      complexity: "hard"
      rfc_reference: "RFC 2046 Section 5.1"
      attack_vectors:
        - "Boundary injection in content"
        - "Nested multipart parts"
        - "Missing final boundary"
        - "Boundary with special characters"
      edge_cases:
        - "Empty parts"
        - "Binary data crossing boundary-like sequence"
        - "Maximum part count"
        - "Part with no Content-Disposition"
    
    - topic: "http1_transfer_encoding_chain"
      description: "Multiple transfer encodings (chunked, gzip, etc.)"
      complexity: "hard"
      rfc_reference: "RFC 7230 Section 3.3.1"
      attack_vectors:
        - "Invalid encoding order"
        - "Unknown encoding insertion"
        - "Encoding/Content-Length conflict"
        - "Recursive compression bomb"
      edge_cases:
        - "chunked, gzip vs gzip, chunked"
        - "Identity encoding handling"
        - "Case insensitive encoding names"
        - "Encoding with parameters"
    
    - topic: "http1_absolute_vs_relative_uri"
      description: "Request-target forms (origin, absolute, authority, asterisk)"
      complexity: "medium"
      rfc_reference: "RFC 7230 Section 5.3"
      attack_vectors:
        - "Host header mismatch with absolute URI"
        - "Authority form abuse"
        - "Asterisk form for non-OPTIONS"
        - "Path traversal in origin form"
      edge_cases:
        - "Port in absolute-form URI"
        - "Missing Host with origin-form"
        - "Scheme case sensitivity"
        - "Userinfo in absolute URI"
    
    - topic: "http1_trailer_headers"
      description: "Trailer headers in chunked transfer encoding"
      complexity: "medium"
      rfc_reference: "RFC 7230 Section 4.1.2"
      attack_vectors:
        - "Forbidden trailer header injection"
        - "Content-Length in trailer"
        - "Transfer-Encoding in trailer"
        - "Authentication headers in trailer"
      edge_cases:
        - "Trailer header size limits"
        - "Trailer without Trailer header"
        - "Multiple trailer sections"
        - "Empty trailer section"
    
    - topic: "http1_expect_continue"
      description: "100 Continue expectation handling"
      complexity: "medium"
      rfc_reference: "RFC 7231 Section 5.1.1"
      attack_vectors:
        - "Expect header without body"
        - "Multiple Expect values"
        - "Expect with invalid value"
        - "Race between 100 and final response"
      edge_cases:
        - "Timeout before 100 response"
        - "417 Expectation Failed handling"
        - "Continue with chunked encoding"
        - "Proxied 100 Continue"
    
    - topic: "http1_connection_header"
      description: "Connection header and hop-by-hop headers"
      complexity: "medium"
      rfc_reference: "RFC 7230 Section 6.1"
      attack_vectors:
        - "Hop-by-hop header confusion"
        - "Connection header injection"
        - "Proxy-Connection abuse"
        - "Keep-Alive/close conflict"
      edge_cases:
        - "Multiple Connection values"
        - "Connection header with unknown token"
        - "Upgrade in Connection header"
        - "Case sensitivity in tokens"
    
    - topic: "http1_upgrade_header"
      description: "HTTP Upgrade mechanism for protocol switching"
      complexity: "hard"
      rfc_reference: "RFC 7230 Section 6.7"
      attack_vectors:
        - "Upgrade to malicious protocol"
        - "Partial upgrade completion"
        - "Upgrade header smuggling"
        - "Multiple Upgrade tokens"
      edge_cases:
        - "Upgrade without Connection header"
        - "Failed upgrade response handling"
        - "101 without completing upgrade"
        - "Upgrade across proxy"
    
    - topic: "http1_host_header_validation"
      description: "Host header parsing and validation"
      complexity: "medium"
      rfc_reference: "RFC 7230 Section 5.4"
      attack_vectors:
        - "Host header injection"
        - "Multiple Host headers"
        - "Host vs X-Forwarded-Host"
        - "Port number manipulation"
      edge_cases:
        - "IPv6 in Host header"
        - "Missing Host in HTTP/1.1"
        - "Empty Host header"
        - "Host with userinfo"
    
    - topic: "http1_via_header_parsing"
      description: "Via header for proxy chain tracking"
      complexity: "medium"
      rfc_reference: "RFC 7230 Section 5.7.1"
      attack_vectors:
        - "Via header injection"
        - "Fake proxy chain"
        - "Via header overflow"
        - "Comment injection"
      edge_cases:
        - "Pseudonym in Via"
        - "Maximum Via chain length"
        - "Via with received-protocol"
        - "Port in received-by"
    
    - topic: "http1_te_header_smuggling"
      description: "Transfer-Encoding header for request smuggling"
      complexity: "hard"
      rfc_reference: "RFC 7230"
      attack_vectors:
        - "TE header with malformed values"
        - "TE vs Transfer-Encoding confusion"
        - "Obfuscated Transfer-Encoding"
        - "Space after header name"
      edge_cases:
        - "Transfer-Encoding: chunked, identity"
        - "Transfer-Encoding with parameters"
        - "Multiple Transfer-Encoding headers"
        - "Transfer-Encoding in trailer"

  # --------------------------------------------------------------------------
  # HTTP/2 PROTOCOL PARSING (15 topics)
  # --------------------------------------------------------------------------
  http_2_parsing:
    - topic: "http2_hpack_compression"
      description: "HPACK header compression and dynamic table"
      complexity: "hard"
      rfc_reference: "RFC 7541"
      attack_vectors:
        - "HPACK bomb (memory exhaustion)"
        - "Dynamic table size update abuse"
        - "Never indexed header leak"
        - "Huffman decoding overflow"
      edge_cases:
        - "Maximum dynamic table size"
        - "Zero-length header name"
        - "Integer overflow in size updates"
        - "Interleaved dynamic table changes"
    
    - topic: "http2_stream_multiplexing"
      description: "HTTP/2 stream creation and management"
      complexity: "hard"
      rfc_reference: "RFC 7540 Section 5"
      attack_vectors:
        - "Stream ID exhaustion"
        - "Stream dependency cycle"
        - "Zombie stream DoS"
        - "Priority manipulation"
      edge_cases:
        - "Maximum concurrent streams"
        - "Stream ID wraparound"
        - "Push promise stream IDs"
        - "Half-closed stream handling"
    
    - topic: "http2_flow_control"
      description: "HTTP/2 flow control windows"
      complexity: "hard"
      rfc_reference: "RFC 7540 Section 5.2"
      attack_vectors:
        - "Flow control window exhaustion"
        - "WINDOW_UPDATE integer overflow"
        - "Rapid window updates DoS"
        - "Negative flow control"
      edge_cases:
        - "Zero window size"
        - "Connection vs stream window"
        - "Window update on closed stream"
        - "Initial window size setting"
    
    - topic: "http2_priority_handling"
      description: "HTTP/2 stream priorities and dependencies"
      complexity: "hard"
      rfc_reference: "RFC 7540 Section 5.3"
      attack_vectors:
        - "Priority flood attack"
        - "Dependency tree manipulation"
        - "Exclusive dependency abuse"
        - "Weight manipulation"
      edge_cases:
        - "Self-dependency"
        - "Dependency on closed stream"
        - "Maximum dependency tree depth"
        - "Priority on idle stream"
    
    - topic: "http2_frame_parsing"
      description: "HTTP/2 frame type parsing and validation"
      complexity: "hard"
      rfc_reference: "RFC 7540 Section 4"
      attack_vectors:
        - "Unknown frame type handling"
        - "Frame padding overflow"
        - "Maximum frame size violation"
        - "Frame flags abuse"
      edge_cases:
        - "Zero-length frames"
        - "Reserved frame types"
        - "Continuation frame sequence"
        - "Frame on stream 0"
    
    - topic: "http2_settings_frame"
      description: "HTTP/2 SETTINGS frame negotiation"
      complexity: "hard"
      rfc_reference: "RFC 7540 Section 6.5"
      attack_vectors:
        - "SETTINGS flood"
        - "Invalid setting identifier"
        - "Out-of-range setting value"
        - "SETTINGS with ACK and payload"
      edge_cases:
        - "Initial SETTINGS race"
        - "SETTINGS acknowledgment timing"
        - "Unknown setting identifiers"
        - "Maximum settings per frame"
    
    - topic: "http2_goaway_handling"
      description: "HTTP/2 GOAWAY frame and connection shutdown"
      complexity: "medium"
      rfc_reference: "RFC 7540 Section 6.8"
      attack_vectors:
        - "GOAWAY with wrong last stream ID"
        - "GOAWAY flood"
        - "GOAWAY with debug data leak"
        - "GOAWAY race conditions"
      edge_cases:
        - "Multiple GOAWAY frames"
        - "GOAWAY on fresh connection"
        - "Requests after GOAWAY"
        - "GOAWAY debug data size"
    
    - topic: "http2_rst_stream_handling"
      description: "HTTP/2 RST_STREAM frame processing"
      complexity: "medium"
      rfc_reference: "RFC 7540 Section 6.4"
      attack_vectors:
        - "RST_STREAM flood"
        - "RST_STREAM on idle stream"
        - "Invalid error code"
        - "RST_STREAM race with DATA"
      edge_cases:
        - "RST_STREAM on half-closed"
        - "Multiple RST_STREAM same stream"
        - "RST_STREAM with wrong size"
        - "RST_STREAM on stream 0"
    
    - topic: "http2_push_promise"
      description: "HTTP/2 server push mechanism"
      complexity: "hard"
      rfc_reference: "RFC 7540 Section 8.2"
      attack_vectors:
        - "Push promise resource confusion"
        - "Push promise header injection"
        - "Unauthorized push"
        - "Push promise flood"
      edge_cases:
        - "Push promise with invalid parent"
        - "Disable push after promise"
        - "Push promise header block"
        - "Promised stream ID collision"
    
    - topic: "http2_continuation_frames"
      description: "HTTP/2 CONTINUATION frame handling"
      complexity: "hard"
      rfc_reference: "RFC 7540 Section 6.10"
      attack_vectors:
        - "CONTINUATION flood"
        - "Incomplete header block"
        - "Interleaved CONTINUATION"
        - "CONTINUATION without HEADERS"
      edge_cases:
        - "Empty CONTINUATION"
        - "Maximum header block size"
        - "END_HEADERS timing"
        - "CONTINUATION across streams"
    
    - topic: "http2_pseudo_headers"
      description: "HTTP/2 pseudo-header field validation"
      complexity: "hard"
      rfc_reference: "RFC 7540 Section 8.1.2.1"
      attack_vectors:
        - "Missing required pseudo-header"
        - "Duplicate pseudo-headers"
        - "Pseudo-header after regular"
        - "Invalid :path value"
      edge_cases:
        - "Empty :authority"
        - ":scheme case sensitivity"
        - ":method with invalid value"
        - ":status in request"
    
    - topic: "http2_data_frame_padding"
      description: "HTTP/2 DATA frame padding"
      complexity: "medium"
      rfc_reference: "RFC 7540 Section 6.1"
      attack_vectors:
        - "Padding length overflow"
        - "All-padding DATA frame"
        - "Padding oracle attack"
        - "Padding with flow control"
      edge_cases:
        - "Maximum padding length"
        - "Padding without PADDED flag"
        - "Zero padding specified"
        - "Padding exceeds frame"
    
    - topic: "http2_ping_frame"
      description: "HTTP/2 PING frame handling"
      complexity: "low"
      rfc_reference: "RFC 7540 Section 6.7"
      attack_vectors:
        - "PING flood"
        - "PING with wrong size"
        - "PING on non-zero stream"
        - "Forged PING ACK"
      edge_cases:
        - "Concurrent PING requests"
        - "PING timeout handling"
        - "PING with ACK flag"
        - "PING response ordering"
    
    - topic: "http2_window_update_frame"
      description: "HTTP/2 WINDOW_UPDATE frame processing"
      complexity: "hard"
      rfc_reference: "RFC 7540 Section 6.9"
      attack_vectors:
        - "Zero window increment"
        - "Window overflow"
        - "WINDOW_UPDATE flood"
        - "Negative effective window"
      edge_cases:
        - "WINDOW_UPDATE on idle stream"
        - "WINDOW_UPDATE on closed stream"
        - "Initial window updates"
        - "Connection-level update"
    
    - topic: "http2_altsvc_frame"
      description: "HTTP/2 ALTSVC frame handling"
      complexity: "medium"
      rfc_reference: "RFC 7838 Section 4"
      attack_vectors:
        - "ALTSVC redirection attack"
        - "ALTSVC with invalid origin"
        - "ALTSVC cache poisoning"
        - "Cross-origin ALTSVC"
      edge_cases:
        - "ALTSVC on non-zero stream"
        - "Empty ALTSVC field value"
        - "ALTSVC max-age handling"
        - "Multiple alternative services"

  # --------------------------------------------------------------------------
  # HTTP/3 AND QUIC PROTOCOL PARSING (15 topics)
  # --------------------------------------------------------------------------
  http_3_quic_parsing:
    - topic: "quic_connection_migration"
      description: "QUIC connection ID and migration handling"
      complexity: "expert"
      rfc_reference: "RFC 9000 Section 9"
      attack_vectors:
        - "Connection ID spoofing"
        - "Migration flood attack"
        - "Path validation bypass"
        - "Connection ID collision"
      edge_cases:
        - "Zero-length connection ID"
        - "Retire CID before use"
        - "NAT rebinding detection"
        - "Preferred address migration"
    
    - topic: "quic_0_rtt_replay"
      description: "QUIC 0-RTT early data and replay protection"
      complexity: "expert"
      rfc_reference: "RFC 9001 Section 4.6"
      attack_vectors:
        - "0-RTT replay attack"
        - "0-RTT data duplication"
        - "Anti-replay failure"
        - "0-RTT rejection handling"
      edge_cases:
        - "0-RTT with new connection ID"
        - "Server 0-RTT rejection"
        - "0-RTT limit exceeded"
        - "0-RTT and retry token"
    
    - topic: "quic_loss_recovery"
      description: "QUIC packet loss detection and recovery"
      complexity: "expert"
      rfc_reference: "RFC 9002"
      attack_vectors:
        - "ACK manipulation"
        - "Spurious retransmission trigger"
        - "PTO manipulation"
        - "RTT estimation attack"
      edge_cases:
        - "Packet reordering"
        - "Probe timeout"
        - "Crypto retransmission"
        - "Multiple packet number spaces"
    
    - topic: "quic_stream_frames"
      description: "QUIC STREAM frame parsing and handling"
      complexity: "hard"
      rfc_reference: "RFC 9000 Section 19.8"
      attack_vectors:
        - "Stream offset overflow"
        - "FIN without data"
        - "Overlapping stream data"
        - "Stream ID exhaustion"
      edge_cases:
        - "Zero-length STREAM frame"
        - "Maximum offset"
        - "Out-of-order stream data"
        - "Bidirectional vs unidirectional"
    
    - topic: "quic_frame_coalescing"
      description: "QUIC packet coalescing and multiple frames"
      complexity: "hard"
      rfc_reference: "RFC 9000 Section 12.2"
      attack_vectors:
        - "Coalesced packet injection"
        - "Frame ordering attack"
        - "Invalid frame type"
        - "Coalescing across epochs"
      edge_cases:
        - "Maximum coalesced size"
        - "Partial coalesced packet"
        - "Coalescing with key updates"
        - "Empty QUIC packet"
    
    - topic: "quic_version_negotiation"
      description: "QUIC version negotiation mechanism"
      complexity: "medium"
      rfc_reference: "RFC 9000 Section 6"
      attack_vectors:
        - "Version downgrade attack"
        - "Fake version negotiation"
        - "Version confusion"
        - "Grease version handling"
      edge_cases:
        - "No common version"
        - "Version negotiation to unknown"
        - "Reserved versions"
        - "Version in Initial packet"
    
    - topic: "quic_crypto_handshake"
      description: "QUIC-TLS cryptographic handshake"
      complexity: "expert"
      rfc_reference: "RFC 9001"
      attack_vectors:
        - "Handshake timeout attack"
        - "Crypto stream injection"
        - "Key derivation attack"
        - "Handshake corruption"
      edge_cases:
        - "Handshake fragmentation"
        - "Handshake done timing"
        - "Client Initial size"
        - "Handshake secrets update"
    
    - topic: "quic_address_validation"
      description: "QUIC address validation with Retry"
      complexity: "hard"
      rfc_reference: "RFC 9000 Section 8"
      attack_vectors:
        - "Retry token forgery"
        - "Path validation spoofing"
        - "Amplification attack"
        - "Address validation bypass"
      edge_cases:
        - "Retry token expiry"
        - "Path challenge/response"
        - "Multiple path validations"
        - "NAT hole punching"
    
    - topic: "http3_qpack_compression"
      description: "HTTP/3 QPACK header compression"
      complexity: "expert"
      rfc_reference: "RFC 9204"
      attack_vectors:
        - "QPACK bomb"
        - "Dynamic table synchronization"
        - "Section acknowledgment abuse"
        - "Encoder stream manipulation"
      edge_cases:
        - "Blocked streams"
        - "Table capacity updates"
        - "Header acknowledgment"
        - "Insert count mismatch"
    
    - topic: "http3_control_stream"
      description: "HTTP/3 control stream handling"
      complexity: "hard"
      rfc_reference: "RFC 9114 Section 6.2.1"
      attack_vectors:
        - "Control stream hijacking"
        - "Multiple control streams"
        - "SETTINGS flood"
        - "Control stream close"
      edge_cases:
        - "Missing control stream"
        - "Control stream ordering"
        - "Unknown frame types"
        - "Reserved stream types"
    
    - topic: "http3_server_push"
      description: "HTTP/3 server push mechanism"
      complexity: "hard"
      rfc_reference: "RFC 9114 Section 4.6"
      attack_vectors:
        - "Push ID collision"
        - "Unauthorized push"
        - "Push cancellation race"
        - "MAX_PUSH_ID manipulation"
      edge_cases:
        - "Push stream ordering"
        - "Push ID wraparound"
        - "Cancelled push"
        - "Push without promise"
    
    - topic: "quic_connection_close"
      description: "QUIC CONNECTION_CLOSE frame handling"
      complexity: "medium"
      rfc_reference: "RFC 9000 Section 19.19"
      attack_vectors:
        - "Forged CONNECTION_CLOSE"
        - "Close during handshake"
        - "Close frame injection"
        - "Application vs transport close"
      edge_cases:
        - "Close reason phrase"
        - "Close after draining"
        - "Multiple close frames"
        - "Close frame size"
    
    - topic: "quic_key_update"
      description: "QUIC key update mechanism"
      complexity: "expert"
      rfc_reference: "RFC 9001 Section 6"
      attack_vectors:
        - "Key update flood"
        - "Key phase confusion"
        - "Old key exploitation"
        - "Key update timing"
      edge_cases:
        - "Key update during handshake"
        - "Received packet with old key"
        - "Key update retransmission"
        - "Simultaneous key updates"
    
    - topic: "quic_datagram_extension"
      description: "QUIC unreliable datagram extension"
      complexity: "medium"
      rfc_reference: "RFC 9221"
      attack_vectors:
        - "Datagram flood"
        - "Oversized datagram"
        - "Datagram without negotiation"
        - "Datagram ID confusion"
      edge_cases:
        - "Maximum datagram size"
        - "Zero-length datagram"
        - "Datagram flow control"
        - "Datagram frame types"
    
    - topic: "quic_multipath"
      description: "QUIC multipath extension handling"
      complexity: "expert"
      rfc_reference: "draft-ietf-quic-multipath"
      attack_vectors:
        - "Path spoofing"
        - "Scheduler manipulation"
        - "Path status confusion"
        - "Multipath ID collision"
      edge_cases:
        - "Path abandonment"
        - "Unidirectional paths"
        - "Path priority"
        - "Multipath with migration"

  # --------------------------------------------------------------------------
  # TLS PROTOCOL PARSING (15 topics)
  # --------------------------------------------------------------------------
  tls_parsing:
    - topic: "tls_handshake_parsing"
      description: "TLS handshake message parsing"
      complexity: "hard"
      rfc_reference: "RFC 8446"
      attack_vectors:
        - "Handshake fragmentation attack"
        - "Invalid message sequence"
        - "Handshake message overflow"
        - "Early data exploitation"
      edge_cases:
        - "Maximum handshake size"
        - "Fragmented ClientHello"
        - "Empty extensions list"
        - "Unknown handshake type"
    
    - topic: "tls_cipher_negotiation"
      description: "TLS cipher suite negotiation"
      complexity: "hard"
      rfc_reference: "RFC 8446 Section 4.1.1"
      attack_vectors:
        - "Cipher downgrade attack"
        - "Grease handling failure"
        - "NULL cipher injection"
        - "Export cipher exploitation"
      edge_cases:
        - "No common cipher suite"
        - "Cipher suite order"
        - "Unknown cipher suites"
        - "TLS 1.3 vs 1.2 suites"
    
    - topic: "tls_certificate_validation"
      description: "TLS certificate chain validation"
      complexity: "hard"
      rfc_reference: "RFC 5280"
      attack_vectors:
        - "Chain validation bypass"
        - "Wildcard certificate abuse"
        - "Name constraint violation"
        - "Path length constraint bypass"
      edge_cases:
        - "Self-signed certificate"
        - "Expired but valid chain"
        - "Cross-signed certificates"
        - "Missing intermediate"
    
    - topic: "tls_1_3_0_rtt"
      description: "TLS 1.3 0-RTT early data handling"
      complexity: "expert"
      rfc_reference: "RFC 8446 Section 2.3"
      attack_vectors:
        - "0-RTT replay"
        - "Early data rejection handling"
        - "0-RTT content type confusion"
        - "Anti-replay bypass"
      edge_cases:
        - "0-RTT without ticket"
        - "Maximum early data"
        - "0-RTT key derivation"
        - "Rejected 0-RTT fallback"
    
    - topic: "tls_1_3_post_handshake"
      description: "TLS 1.3 post-handshake authentication"
      complexity: "expert"
      rfc_reference: "RFC 8446 Section 4.6.2"
      attack_vectors:
        - "Post-handshake auth flood"
        - "Client certificate theft"
        - "Post-handshake timing"
        - "Unexpected auth request"
      edge_cases:
        - "Multiple post-handshake auths"
        - "Post-handshake failure"
        - "Certificate chain in post-handshake"
        - "Post-handshake and key update"
    
    - topic: "tls_session_tickets"
      description: "TLS session ticket handling"
      complexity: "hard"
      rfc_reference: "RFC 8446 Section 4.6.1"
      attack_vectors:
        - "Ticket decryption oracle"
        - "Ticket lifetime abuse"
        - "Cross-ticket confusion"
        - "Ticket key rotation failure"
      edge_cases:
        - "Multiple tickets"
        - "Expired ticket"
        - "Ticket age calculation"
        - "Obfuscated ticket age"
    
    - topic: "tls_alert_handling"
      description: "TLS alert protocol parsing"
      complexity: "medium"
      rfc_reference: "RFC 8446 Section 6"
      attack_vectors:
        - "Alert flood"
        - "Unexpected alert level"
        - "Alert before handshake"
        - "Alert after close"
      edge_cases:
        - "Unknown alert description"
        - "Warning vs fatal"
        - "Close_notify handling"
        - "Alert fragmentation"
    
    - topic: "tls_extension_parsing"
      description: "TLS extension parsing and validation"
      complexity: "hard"
      rfc_reference: "RFC 8446 Section 4.2"
      attack_vectors:
        - "Extension overflow"
        - "Duplicate extension"
        - "Unknown extension handling"
        - "Extension injection"
      edge_cases:
        - "Empty extension data"
        - "Maximum extension count"
        - "Extension ordering"
        - "Extension in wrong message"
    
    - topic: "tls_sni_parsing"
      description: "TLS Server Name Indication parsing"
      complexity: "medium"
      rfc_reference: "RFC 6066 Section 3"
      attack_vectors:
        - "SNI injection"
        - "Multiple SNI values"
        - "SNI length overflow"
        - "Invalid hostname in SNI"
      edge_cases:
        - "Empty SNI"
        - "IP address in SNI"
        - "Unicode in SNI"
        - "SNI case sensitivity"
    
    - topic: "tls_alpn_negotiation"
      description: "TLS Application-Layer Protocol Negotiation"
      complexity: "medium"
      rfc_reference: "RFC 7301"
      attack_vectors:
        - "ALPN protocol confusion"
        - "No common protocol handling"
        - "ALPN injection"
        - "ALPN length overflow"
      edge_cases:
        - "Empty ALPN list"
        - "Unknown protocol identifier"
        - "ALPN ordering priority"
        - "ALPN in resumed session"
    
    - topic: "tls_key_share"
      description: "TLS 1.3 key_share extension"
      complexity: "expert"
      rfc_reference: "RFC 8446 Section 4.2.8"
      attack_vectors:
        - "Invalid key share group"
        - "HelloRetryRequest manipulation"
        - "Key share mismatch"
        - "Weak curve selection"
      edge_cases:
        - "Empty key share"
        - "Multiple key shares"
        - "Grease key shares"
        - "HelloRetryRequest key share"
    
    - topic: "tls_record_layer"
      description: "TLS record layer parsing"
      complexity: "hard"
      rfc_reference: "RFC 8446 Section 5"
      attack_vectors:
        - "Record layer overflow"
        - "Content type confusion"
        - "Record fragmentation attack"
        - "Padding oracle"
      edge_cases:
        - "Maximum record size"
        - "Empty record"
        - "Encrypted content type"
        - "Record version field"
    
    - topic: "tls_signature_algorithms"
      description: "TLS signature algorithms extension"
      complexity: "hard"
      rfc_reference: "RFC 8446 Section 4.2.3"
      attack_vectors:
        - "Signature algorithm downgrade"
        - "Legacy algorithm exploitation"
        - "RSA-PSS vs RSA-PKCS1"
        - "Curve/signature mismatch"
      edge_cases:
        - "No common algorithm"
        - "Certificate signature algorithm"
        - "Signature algorithm order"
        - "signature_algorithms_cert"
    
    - topic: "tls_psk_modes"
      description: "TLS 1.3 PSK key exchange modes"
      complexity: "expert"
      rfc_reference: "RFC 8446 Section 4.2.9"
      attack_vectors:
        - "PSK without ke mode"
        - "External PSK confusion"
        - "PSK binder failure"
        - "PSK identity theft"
      edge_cases:
        - "Multiple PSK identities"
        - "PSK with DHE vs PSK only"
        - "PSK binder truncation"
        - "Ticket-based PSK"
    
    - topic: "tls_certificate_compression"
      description: "TLS certificate compression"
      complexity: "medium"
      rfc_reference: "RFC 8879"
      attack_vectors:
        - "Compression bomb"
        - "Algorithm confusion"
        - "Decompression timeout"
        - "Partial decompression"
      edge_cases:
        - "Unknown compression algorithm"
        - "Empty compressed certificate"
        - "Maximum decompressed size"
        - "Multiple algorithms"

  # --------------------------------------------------------------------------
  # WEBSOCKET PROTOCOL PARSING (10 topics)
  # --------------------------------------------------------------------------
  websocket_parsing:
    - topic: "websocket_handshake"
      description: "WebSocket opening handshake"
      complexity: "medium"
      rfc_reference: "RFC 6455 Section 4"
      attack_vectors:
        - "Sec-WebSocket-Key forgery"
        - "Origin validation bypass"
        - "Protocol upgrade confusion"
        - "Header injection"
      edge_cases:
        - "Missing required headers"
        - "Invalid Accept hash"
        - "Subprotocol negotiation"
        - "Extension negotiation"
    
    - topic: "websocket_frame_parsing"
      description: "WebSocket frame format parsing"
      complexity: "hard"
      rfc_reference: "RFC 6455 Section 5"
      attack_vectors:
        - "Payload length overflow"
        - "Masking key manipulation"
        - "RSV bit abuse"
        - "Opcode confusion"
      edge_cases:
        - "Zero-length payload"
        - "Maximum payload size"
        - "Extended payload length"
        - "Unmasked client frame"
    
    - topic: "websocket_fragmentation"
      description: "WebSocket message fragmentation"
      complexity: "hard"
      rfc_reference: "RFC 6455 Section 5.4"
      attack_vectors:
        - "Fragmentation bomb"
        - "Interleaved control frames"
        - "FIN bit manipulation"
        - "Fragment reassembly DoS"
      edge_cases:
        - "Empty fragments"
        - "Maximum fragment count"
        - "Control frame in fragmented message"
        - "Single-frame message"
    
    - topic: "websocket_close_handshake"
      description: "WebSocket closing handshake"
      complexity: "medium"
      rfc_reference: "RFC 6455 Section 7"
      attack_vectors:
        - "Close frame injection"
        - "Status code manipulation"
        - "Close reason overflow"
        - "Half-close exploitation"
      edge_cases:
        - "Close without status"
        - "Invalid close code"
        - "Close reason encoding"
        - "Multiple close frames"
    
    - topic: "websocket_ping_pong"
      description: "WebSocket ping/pong frames"
      complexity: "low"
      rfc_reference: "RFC 6455 Section 5.5.2"
      attack_vectors:
        - "Ping flood"
        - "Pong without ping"
        - "Ping payload manipulation"
        - "Ping fragmentation"
      edge_cases:
        - "Maximum ping payload"
        - "Concurrent pings"
        - "Unsolicited pong"
        - "Ping during close"
    
    - topic: "websocket_extensions"
      description: "WebSocket extension negotiation"
      complexity: "hard"
      rfc_reference: "RFC 6455 Section 9"
      attack_vectors:
        - "Extension parameter injection"
        - "Compression bomb (permessage-deflate)"
        - "Extension ordering attack"
        - "Unknown extension handling"
      edge_cases:
        - "Empty extension value"
        - "Multiple extension instances"
        - "Extension parameters"
        - "Server extension rejection"
    
    - topic: "websocket_subprotocol"
      description: "WebSocket subprotocol negotiation"
      complexity: "medium"
      rfc_reference: "RFC 6455 Section 11.5"
      attack_vectors:
        - "Subprotocol confusion"
        - "Unauthorized subprotocol"
        - "Subprotocol injection"
        - "Missing subprotocol handling"
      edge_cases:
        - "No common subprotocol"
        - "Empty subprotocol"
        - "Multiple subprotocols offered"
        - "Subprotocol with parameters"
    
    - topic: "websocket_binary_text"
      description: "WebSocket binary vs text frame handling"
      complexity: "medium"
      rfc_reference: "RFC 6455 Section 5.6"
      attack_vectors:
        - "UTF-8 validation bypass"
        - "Invalid UTF-8 injection"
        - "Opcode switching attack"
        - "Content-type confusion"
      edge_cases:
        - "Empty text frame"
        - "Invalid UTF-8 continuation"
        - "Binary as text"
        - "Partial UTF-8 sequence"
    
    - topic: "websocket_masking"
      description: "WebSocket masking implementation"
      complexity: "medium"
      rfc_reference: "RFC 6455 Section 5.3"
      attack_vectors:
        - "Masking key prediction"
        - "Unmasked frame from client"
        - "Masked frame from server"
        - "Masking algorithm bypass"
      edge_cases:
        - "Zero masking key"
        - "Repeated masking key"
        - "Partial masking"
        - "Masking empty payload"
    
    - topic: "websocket_compression"
      description: "WebSocket per-message deflate compression"
      complexity: "hard"
      rfc_reference: "RFC 7692"
      attack_vectors:
        - "Compression ratio attack"
        - "Decompression bomb"
        - "Context takeover manipulation"
        - "Window bits attack"
      edge_cases:
        - "Empty compressed message"
        - "Incompressible data"
        - "Maximum window bits"
        - "No context takeover"

  # --------------------------------------------------------------------------
  # GRPC AND PROTOCOL BUFFERS (10 topics)
  # --------------------------------------------------------------------------
  grpc_protobuf:
    - topic: "protobuf_wire_format"
      description: "Protocol Buffers wire format parsing"
      complexity: "hard"
      rfc_reference: "Protocol Buffers Encoding"
      attack_vectors:
        - "Field number overflow"
        - "Wire type confusion"
        - "Nested message bomb"
        - "Unknown field exploitation"
      edge_cases:
        - "Maximum field number"
        - "Repeated field packing"
        - "Default value handling"
        - "Oneof field conflicts"
    
    - topic: "protobuf_varint_encoding"
      description: "Protocol Buffers varint encoding"
      complexity: "medium"
      rfc_reference: "Protocol Buffers Encoding"
      attack_vectors:
        - "Varint overflow"
        - "Overlong varint encoding"
        - "Negative varint handling"
        - "Varint parsing DoS"
      edge_cases:
        - "Maximum varint bytes"
        - "Zero varint"
        - "Signed vs unsigned varint"
        - "ZigZag encoding"
    
    - topic: "grpc_framing"
      description: "gRPC HTTP/2 message framing"
      complexity: "hard"
      rfc_reference: "gRPC HTTP/2 Protocol"
      attack_vectors:
        - "Message size overflow"
        - "Compression bomb"
        - "Trailer manipulation"
        - "Status code confusion"
      edge_cases:
        - "Empty message"
        - "Maximum message size"
        - "Compressed flag handling"
        - "Trailer-only response"
    
    - topic: "grpc_streaming"
      description: "gRPC streaming message handling"
      complexity: "hard"
      rfc_reference: "gRPC Protocol"
      attack_vectors:
        - "Stream exhaustion"
        - "Half-close manipulation"
        - "Flow control abuse"
        - "Cancel propagation"
      edge_cases:
        - "Empty stream"
        - "Server streaming limits"
        - "Bidirectional race conditions"
        - "Stream error handling"
    
    - topic: "grpc_metadata"
      description: "gRPC metadata handling"
      complexity: "medium"
      rfc_reference: "gRPC Protocol"
      attack_vectors:
        - "Metadata injection"
        - "Binary metadata abuse"
        - "Reserved metadata names"
        - "Metadata size limits"
      edge_cases:
        - "Empty metadata value"
        - "Duplicate metadata keys"
        - "grpc- prefix handling"
        - "Metadata encoding"
    
    - topic: "grpc_status_codes"
      description: "gRPC status code handling"
      complexity: "medium"
      rfc_reference: "gRPC Status Codes"
      attack_vectors:
        - "Status code confusion"
        - "Details message abuse"
        - "Rich error handling"
        - "Status in trailers"
      edge_cases:
        - "Unknown status code"
        - "OK with error details"
        - "Cancelled vs deadline exceeded"
        - "Status message encoding"
    
    - topic: "grpc_deadlines"
      description: "gRPC deadline propagation"
      complexity: "hard"
      rfc_reference: "gRPC Protocol"
      attack_vectors:
        - "Deadline manipulation"
        - "Timeout overflow"
        - "Clock skew exploitation"
        - "Deadline propagation failure"
      edge_cases:
        - "Negative deadline"
        - "Maximum deadline"
        - "Already expired deadline"
        - "No deadline vs infinite"
    
    - topic: "grpc_compression"
      description: "gRPC compression handling"
      complexity: "medium"
      rfc_reference: "gRPC Protocol"
      attack_vectors:
        - "Compression algorithm confusion"
        - "Decompression bomb"
        - "Unsupported algorithm"
        - "Message too large after decompression"
      edge_cases:
        - "Identity compression"
        - "Compressed flag mismatch"
        - "Per-message compression"
        - "Compression level"
    
    - topic: "grpc_reflection"
      description: "gRPC server reflection"
      complexity: "medium"
      rfc_reference: "gRPC Server Reflection"
      attack_vectors:
        - "Service enumeration"
        - "Method discovery"
        - "Proto file extraction"
        - "Reflection abuse"
      edge_cases:
        - "Nested message types"
        - "Extension handling"
        - "Service with no methods"
        - "Empty proto file"
    
    - topic: "grpc_interceptors"
      description: "gRPC interceptor chain handling"
      complexity: "hard"
      rfc_reference: "gRPC Interceptors"
      attack_vectors:
        - "Interceptor bypass"
        - "Context manipulation"
        - "Error swallowing"
        - "Interceptor ordering"
      edge_cases:
        - "Multiple interceptors"
        - "Interceptor exception"
        - "Stream interceptors"
        - "Cancellation in interceptor"

  # --------------------------------------------------------------------------
  # DNS PROTOCOL PARSING (10 topics)
  # --------------------------------------------------------------------------
  dns_parsing:
    - topic: "dns_wire_format"
      description: "DNS message wire format parsing"
      complexity: "hard"
      rfc_reference: "RFC 1035"
      attack_vectors:
        - "Name compression pointer loop"
        - "QCOUNT/ANCOUNT manipulation"
        - "DNS ID spoofing"
        - "Truncation bit abuse"
      edge_cases:
        - "Maximum label length"
        - "Maximum name length"
        - "Empty name (root)"
        - "Case preservation"
    
    - topic: "dns_name_compression"
      description: "DNS message compression"
      complexity: "hard"
      rfc_reference: "RFC 1035 Section 4.1.4"
      attack_vectors:
        - "Compression pointer loop"
        - "Out-of-bounds pointer"
        - "Nested compression"
        - "Compression bomb"
      edge_cases:
        - "Maximum compression depth"
        - "Forward pointer"
        - "Compression at name boundary"
        - "Partial label compression"
    
    - topic: "dns_edns"
      description: "Extension mechanisms for DNS (EDNS)"
      complexity: "hard"
      rfc_reference: "RFC 6891"
      attack_vectors:
        - "OPT RR manipulation"
        - "EDNS buffer size attack"
        - "Unknown option handling"
        - "Multiple OPT records"
      edge_cases:
        - "EDNS version negotiation"
        - "DO bit handling"
        - "Empty OPT record"
        - "Maximum UDP payload"
    
    - topic: "dnssec_validation"
      description: "DNSSEC signature verification"
      complexity: "expert"
      rfc_reference: "RFC 4033-4035"
      attack_vectors:
        - "Signature replay"
        - "Chain of trust bypass"
        - "NSEC/NSEC3 enumeration"
        - "Key tag collision"
      edge_cases:
        - "Expired signature"
        - "Key rollover"
        - "Algorithm negotiation"
        - "Insecure delegation"
    
    - topic: "dns_record_types"
      description: "DNS resource record type parsing"
      complexity: "hard"
      rfc_reference: "RFC 1035, RFC 3596"
      attack_vectors:
        - "Unknown record type handling"
        - "RDATA overflow"
        - "Record type confusion"
        - "Class field manipulation"
      edge_cases:
        - "Zero TTL"
        - "Maximum RDATA length"
        - "Pseudo-records (OPT)"
        - "Obsolete record types"
    
    - topic: "dns_cname_handling"
      description: "DNS CNAME record handling"
      complexity: "hard"
      rfc_reference: "RFC 1034"
      attack_vectors:
        - "CNAME chain loop"
        - "CNAME chain bomb"
        - "CNAME with other data"
        - "DNAME vs CNAME"
      edge_cases:
        - "CNAME at zone apex"
        - "Maximum CNAME chain"
        - "CNAME to different zone"
        - "CNAME TTL handling"
    
    - topic: "dns_srv_records"
      description: "DNS SRV record parsing"
      complexity: "medium"
      rfc_reference: "RFC 2782"
      attack_vectors:
        - "Priority/weight manipulation"
        - "Port number overflow"
        - "Target name validation"
        - "SRV record confusion"
      edge_cases:
        - "Zero weight handling"
        - "Multiple equal priority"
        - "SRV to CNAME"
        - "Empty SRV response"
    
    - topic: "dns_txt_records"
      description: "DNS TXT record parsing"
      complexity: "medium"
      rfc_reference: "RFC 1035, RFC 7208"
      attack_vectors:
        - "TXT record injection"
        - "Character string overflow"
        - "Concatenation confusion"
        - "SPF/DKIM parsing"
      edge_cases:
        - "Empty TXT record"
        - "Multiple character strings"
        - "Maximum TXT length"
        - "Binary in TXT"
    
    - topic: "dns_over_https"
      description: "DNS over HTTPS (DoH) handling"
      complexity: "hard"
      rfc_reference: "RFC 8484"
      attack_vectors:
        - "DoH response injection"
        - "Content-type confusion"
        - "Caching header manipulation"
        - "DoH endpoint hijacking"
      edge_cases:
        - "GET vs POST"
        - "Accept header handling"
        - "DNS wireformat vs JSON"
        - "TCP fallback"
    
    - topic: "dns_over_tls"
      description: "DNS over TLS (DoT) handling"
      complexity: "hard"
      rfc_reference: "RFC 7858"
      attack_vectors:
        - "TLS downgrade"
        - "Certificate validation bypass"
        - "Connection reuse confusion"
        - "Padding analysis"
      edge_cases:
        - "Connection timeout"
        - "TLS resumption"
        - "Multiple queries per connection"
        - "PKIX vs DANE"

  # --------------------------------------------------------------------------
  # SSH PROTOCOL PARSING (8 topics)
  # --------------------------------------------------------------------------
  ssh_parsing:
    - topic: "ssh_key_exchange"
      description: "SSH key exchange algorithm handling"
      complexity: "expert"
      rfc_reference: "RFC 4253"
      attack_vectors:
        - "Algorithm downgrade"
        - "Key exchange injection"
        - "DH parameter manipulation"
        - "Guess packet attack"
      edge_cases:
        - "No common algorithm"
        - "Key re-exchange"
        - "ECDH curve selection"
        - "Post-quantum KEX"
    
    - topic: "ssh_channel_multiplexing"
      description: "SSH channel management"
      complexity: "hard"
      rfc_reference: "RFC 4254"
      attack_vectors:
        - "Channel ID exhaustion"
        - "Window size manipulation"
        - "Channel type confusion"
        - "Extended data abuse"
      edge_cases:
        - "Maximum channels"
        - "Zero window size"
        - "Channel close races"
        - "Unknown channel type"
    
    - topic: "ssh_authentication"
      description: "SSH user authentication"
      complexity: "hard"
      rfc_reference: "RFC 4252"
      attack_vectors:
        - "Authentication bypass"
        - "Username enumeration"
        - "Partial success confusion"
        - "Method order manipulation"
      edge_cases:
        - "None authentication"
        - "Keyboard-interactive"
        - "Multiple auth methods"
        - "Auth failure limit"
    
    - topic: "ssh_public_key_auth"
      description: "SSH public key authentication"
      complexity: "hard"
      rfc_reference: "RFC 4252 Section 7"
      attack_vectors:
        - "Public key confusion"
        - "Signature algorithm mismatch"
        - "Authorized keys parsing"
        - "Certificate validation"
      edge_cases:
        - "Multiple public keys"
        - "Key algorithm negotiation"
        - "OpenSSH certificates"
        - "FIDO/U2F keys"
    
    - topic: "ssh_packet_format"
      description: "SSH binary packet protocol"
      complexity: "hard"
      rfc_reference: "RFC 4253 Section 6"
      attack_vectors:
        - "Packet length overflow"
        - "Padding oracle"
        - "MAC verification bypass"
        - "Compression bomb"
      edge_cases:
        - "Maximum packet size"
        - "Minimum padding"
        - "Encrypted packet boundary"
        - "Sequence number wraparound"
    
    - topic: "ssh_subsystem"
      description: "SSH subsystem handling (SFTP)"
      complexity: "hard"
      rfc_reference: "RFC 4254 Section 6.5"
      attack_vectors:
        - "Subsystem injection"
        - "SFTP path traversal"
        - "Subsystem version confusion"
        - "Request/response desync"
      edge_cases:
        - "Unknown subsystem"
        - "Subsystem failure"
        - "Multiple subsystems"
        - "Subsystem EOF"
    
    - topic: "ssh_agent_protocol"
      description: "SSH agent protocol handling"
      complexity: "hard"
      rfc_reference: "draft-miller-ssh-agent"
      attack_vectors:
        - "Agent forwarding hijack"
        - "Key constraint bypass"
        - "Agent socket injection"
        - "Key extraction"
      edge_cases:
        - "Locked agent"
        - "Key lifetime"
        - "Confirm constraints"
        - "Extension messages"
    
    - topic: "ssh_port_forwarding"
      description: "SSH port forwarding handling"
      complexity: "hard"
      rfc_reference: "RFC 4254 Section 7"
      attack_vectors:
        - "Unauthorized forwarding"
        - "Forwarding to internal hosts"
        - "Dynamic forwarding abuse"
        - "Reverse forwarding hijack"
      edge_cases:
        - "Wildcard bind address"
        - "Privileged port forwarding"
        - "Maximum forwards"
        - "Forwarding with gateway ports"

  # --------------------------------------------------------------------------
  # BGP/OSPF/MPLS ROUTING PROTOCOLS (8 topics)
  # --------------------------------------------------------------------------
  routing_protocols:
    - topic: "bgp_path_attributes"
      description: "BGP path attribute parsing"
      complexity: "expert"
      rfc_reference: "RFC 4271"
      attack_vectors:
        - "AS_PATH manipulation"
        - "Community hijacking"
        - "Origin validation bypass"
        - "Extended community injection"
      edge_cases:
        - "AS_SET handling"
        - "AS_CONFED_SEQUENCE"
        - "Large communities"
        - "Unknown attribute handling"
    
    - topic: "bgp_route_selection"
      description: "BGP best path selection"
      complexity: "expert"
      rfc_reference: "RFC 4271 Section 9.1"
      attack_vectors:
        - "LOCAL_PREF manipulation"
        - "MED manipulation"
        - "IGP metric confusion"
        - "Route oscillation"
      edge_cases:
        - "Tie-breaking rules"
        - "Multiple paths"
        - "Route dampening"
        - "Soft reconfiguration"
    
    - topic: "bgp_message_format"
      description: "BGP message parsing"
      complexity: "hard"
      rfc_reference: "RFC 4271"
      attack_vectors:
        - "Marker field validation"
        - "Message length overflow"
        - "UPDATE message crafting"
        - "NOTIFICATION abuse"
      edge_cases:
        - "Maximum message size"
        - "Minimum UPDATE"
        - "Withdrawn routes only"
        - "Incremental UPDATE"
    
    - topic: "ospf_lsa_parsing"
      description: "OSPF LSA parsing"
      complexity: "expert"
      rfc_reference: "RFC 2328"
      attack_vectors:
        - "LSA sequence number attack"
        - "Router LSA manipulation"
        - "Network LSA injection"
        - "MaxAge LSA flood"
      edge_cases:
        - "LSA types"
        - "Opaque LSAs"
        - "LSA age handling"
        - "Database overflow"
    
    - topic: "ospf_spf_calculation"
      description: "OSPF SPF algorithm"
      complexity: "expert"
      rfc_reference: "RFC 2328 Section 16"
      attack_vectors:
        - "SPF trigger DoS"
        - "Metric manipulation"
        - "Stub area abuse"
        - "NSSA translation"
      edge_cases:
        - "Equal cost multipath"
        - "ABR selection"
        - "Virtual links"
        - "Incremental SPF"
    
    - topic: "mpls_label_stacking"
      description: "MPLS label stack handling"
      complexity: "expert"
      rfc_reference: "RFC 3032"
      attack_vectors:
        - "Label stack overflow"
        - "Bottom of stack manipulation"
        - "TTL propagation abuse"
        - "Label confusion"
      edge_cases:
        - "Maximum label stack"
        - "Penultimate hop popping"
        - "Explicit null labels"
        - "Special labels (0-15)"
    
    - topic: "ldp_message_parsing"
      description: "LDP message format parsing"
      complexity: "hard"
      rfc_reference: "RFC 5036"
      attack_vectors:
        - "LDP session hijacking"
        - "Label space confusion"
        - "FEC manipulation"
        - "Targeted LDP abuse"
      edge_cases:
        - "Unknown TLVs"
        - "Address families"
        - "Label retention"
        - "Liberal vs conservative"
    
    - topic: "segment_routing"
      description: "Segment routing label handling"
      complexity: "expert"
      rfc_reference: "RFC 8402"
      attack_vectors:
        - "SID manipulation"
        - "SRGB/SRLB collision"
        - "Anycast SID abuse"
        - "Adjacency SID spoofing"
      edge_cases:
        - "Node vs adjacency SID"
        - "Binding SIDs"
        - "SR policy"
        - "TI-LFA backup"

  # --------------------------------------------------------------------------
  # IPSEC AND IKE (6 topics)
  # --------------------------------------------------------------------------
  ipsec_ike:
    - topic: "ike_negotiation"
      description: "IKE SA negotiation"
      complexity: "expert"
      rfc_reference: "RFC 7296"
      attack_vectors:
        - "IKE downgrade attack"
        - "Proposal manipulation"
        - "Cookie DoS"
        - "Invalid SPI handling"
      edge_cases:
        - "Multiple proposals"
        - "Transform ordering"
        - "PRF negotiation"
        - "DH group selection"
    
    - topic: "esp_processing"
      description: "ESP packet processing"
      complexity: "expert"
      rfc_reference: "RFC 4303"
      attack_vectors:
        - "Replay attack"
        - "ICV bypass"
        - "Padding oracle"
        - "Traffic flow confidentiality"
      edge_cases:
        - "Extended sequence number"
        - "Combined mode algorithms"
        - "ESN wraparound"
        - "Dummy packets"
    
    - topic: "ah_processing"
      description: "AH packet processing"
      complexity: "hard"
      rfc_reference: "RFC 4302"
      attack_vectors:
        - "ICV manipulation"
        - "Mutable field handling"
        - "Replay window"
        - "Transport/tunnel mode confusion"
      edge_cases:
        - "Alignment requirements"
        - "IP options handling"
        - "Fragment handling"
        - "Nested AH"
    
    - topic: "ike_child_sa"
      description: "IKE Child SA creation"
      complexity: "expert"
      rfc_reference: "RFC 7296 Section 2"
      attack_vectors:
        - "Traffic selector manipulation"
        - "PFS bypass"
        - "Rekey confusion"
        - "Delete race condition"
      edge_cases:
        - "Narrowing selectors"
        - "Multiple Child SAs"
        - "Rekey collision"
        - "Child SA deletion"
    
    - topic: "ike_fragmentation"
      description: "IKE message fragmentation"
      complexity: "hard"
      rfc_reference: "RFC 7383"
      attack_vectors:
        - "Fragment reassembly DoS"
        - "Fragment ordering attack"
        - "Overlapping fragments"
        - "Fragment number overflow"
      edge_cases:
        - "Maximum fragment count"
        - "Fragment timeout"
        - "Retransmission of fragments"
        - "MTU discovery"
    
    - topic: "ike_eap"
      description: "IKE EAP authentication"
      complexity: "expert"
      rfc_reference: "RFC 7296 Section 2.16"
      attack_vectors:
        - "EAP method downgrade"
        - "Identity confusion"
        - "EAP-TLS bypass"
        - "MSK extraction"
      edge_cases:
        - "EAP retransmission"
        - "Multiple EAP methods"
        - "EAP only authentication"
        - "EAP notification"

  # --------------------------------------------------------------------------
  # SIP/RTP/RTCP VOIP PROTOCOLS (6 topics)
  # --------------------------------------------------------------------------
  voip_protocols:
    - topic: "sip_parsing"
      description: "SIP message parsing"
      complexity: "hard"
      rfc_reference: "RFC 3261"
      attack_vectors:
        - "Header injection"
        - "Via header manipulation"
        - "Contact header spoofing"
        - "CSeq manipulation"
      edge_cases:
        - "Compact form headers"
        - "URI parameters"
        - "Body boundary"
        - "Transport parameter"
    
    - topic: "sip_dialog_state"
      description: "SIP dialog state machine"
      complexity: "hard"
      rfc_reference: "RFC 3261 Section 12"
      attack_vectors:
        - "Dialog hijacking"
        - "Early dialog manipulation"
        - "Fork confusion"
        - "To-tag manipulation"
      edge_cases:
        - "Provisional responses"
        - "2xx retransmission"
        - "Dialog termination"
        - "Target refresh"
    
    - topic: "sip_registration"
      description: "SIP REGISTER handling"
      complexity: "hard"
      rfc_reference: "RFC 3261 Section 10"
      attack_vectors:
        - "Registration hijacking"
        - "Contact manipulation"
        - "Expires manipulation"
        - "Third-party registration"
      edge_cases:
        - "Multiple contacts"
        - "Wildcard deregistration"
        - "Registration timeout"
        - "Path header"
    
    - topic: "rtp_packet_handling"
      description: "RTP packet processing"
      complexity: "hard"
      rfc_reference: "RFC 3550"
      attack_vectors:
        - "SSRC collision"
        - "Sequence number manipulation"
        - "Timestamp manipulation"
        - "Marker bit abuse"
      edge_cases:
        - "Sequence wraparound"
        - "Jitter handling"
        - "Payload type change"
        - "CSRC handling"
    
    - topic: "rtcp_processing"
      description: "RTCP report processing"
      complexity: "hard"
      rfc_reference: "RFC 3550 Section 6"
      attack_vectors:
        - "SR/RR manipulation"
        - "SDES injection"
        - "BYE packet injection"
        - "Compound packet attacks"
      edge_cases:
        - "RTCP interval"
        - "Bandwidth calculation"
        - "APP packet handling"
        - "RTCP multiplexing"
    
    - topic: "srtp_processing"
      description: "SRTP packet handling"
      complexity: "expert"
      rfc_reference: "RFC 3711"
      attack_vectors:
        - "Replay attack"
        - "Key derivation attack"
        - "MKI manipulation"
        - "ROC manipulation"
      edge_cases:
        - "Key derivation rate"
        - "Master key lifetime"
        - "SRTP vs SRTCP index"
        - "Unencrypted RTCP"

  # --------------------------------------------------------------------------
  # MQTT AND IOT PROTOCOLS (6 topics)
  # --------------------------------------------------------------------------
  iot_protocols:
    - topic: "mqtt_packet_parsing"
      description: "MQTT control packet parsing"
      complexity: "medium"
      rfc_reference: "MQTT 5.0 Spec"
      attack_vectors:
        - "Remaining length overflow"
        - "Topic filter injection"
        - "Will message abuse"
        - "Packet identifier collision"
      edge_cases:
        - "Zero remaining length"
        - "Maximum topic length"
        - "QoS 2 flow"
        - "Retain handling"
    
    - topic: "mqtt_qos_handling"
      description: "MQTT QoS level handling"
      complexity: "hard"
      rfc_reference: "MQTT 5.0 Spec Section 4.3"
      attack_vectors:
        - "QoS downgrade"
        - "Message duplication"
        - "Lost PUBACK"
        - "PUBREL/PUBCOMP confusion"
      edge_cases:
        - "QoS 0 fire and forget"
        - "Maximum in-flight messages"
        - "Session state recovery"
        - "Packet identifier reuse"
    
    - topic: "mqtt_retained_messages"
      description: "MQTT retained message handling"
      complexity: "medium"
      rfc_reference: "MQTT 5.0 Spec Section 3.3.1.3"
      attack_vectors:
        - "Retained message flooding"
        - "Empty retained payload"
        - "Retained message expiry"
        - "Will retained"
      edge_cases:
        - "Retained across reconnect"
        - "Delete retained"
        - "Retained in clean session"
        - "Retained with QoS"
    
    - topic: "coap_message_parsing"
      description: "CoAP message parsing"
      complexity: "medium"
      rfc_reference: "RFC 7252"
      attack_vectors:
        - "Option number overflow"
        - "Token manipulation"
        - "Payload marker abuse"
        - "Block transfer attack"
      edge_cases:
        - "Empty option value"
        - "Unknown option handling"
        - "Maximum token length"
        - "Confirmable vs non-confirmable"
    
    - topic: "coap_observe"
      description: "CoAP observe extension"
      complexity: "hard"
      rfc_reference: "RFC 7641"
      attack_vectors:
        - "Observation flooding"
        - "Stale notification"
        - "Reorder attack"
        - "Observe sequence overflow"
      edge_cases:
        - "Observe registration"
        - "Observe cancellation"
        - "Max-Age handling"
        - "Observe with block"
    
    - topic: "modbus_parsing"
      description: "Modbus TCP/RTU parsing"
      complexity: "medium"
      rfc_reference: "Modbus Application Protocol"
      attack_vectors:
        - "Function code injection"
        - "Address space manipulation"
        - "Transaction ID confusion"
        - "Exception response abuse"
      edge_cases:
        - "Broadcast address"
        - "Maximum register count"
        - "Coil vs register"
        - "Sub-function codes"

# ============================================================================
# VULNERABILITY PATTERNS - 50+ UNIQUE PATTERNS
# ============================================================================
vulnerability_patterns:
  integer_vulnerabilities:
    - pattern: "integer_overflow_length"
      description: "Length field calculation wraps around on large values"
      severity: "critical"
      cwe: "CWE-190"
      trigger_conditions:
        - "Length field close to maximum integer value"
        - "Addition to length without overflow check"
        - "Multiplication of dimensions"
      exploitation:
        - "Memory corruption"
        - "Buffer overflow"
        - "Heap overflow"
      mitigation: "Check for overflow before arithmetic, use safe math functions"
    
    - pattern: "integer_underflow"
      description: "Subtraction results in negative/large positive value"
      severity: "critical"
      cwe: "CWE-191"
      trigger_conditions:
        - "Subtraction without bounds check"
        - "Unsigned arithmetic on signed value"
        - "Length minus offset calculations"
      exploitation:
        - "Buffer underread"
        - "Large allocation"
        - "Memory disclosure"
    
    - pattern: "signed_unsigned_mismatch"
      description: "Mixing signed and unsigned comparisons"
      severity: "high"
      cwe: "CWE-195"
      trigger_conditions:
        - "Comparing signed length to unsigned size"
        - "Casting between signed and unsigned"
        - "Negative value as large positive"
    
    - pattern: "truncation_error"
      description: "Value truncated when assigned to smaller type"
      severity: "high"
      cwe: "CWE-681"
      trigger_conditions:
        - "64-bit to 32-bit conversion"
        - "Integer to short/byte"
        - "Size_t to int"

  buffer_vulnerabilities:
    - pattern: "buffer_over_read"
      description: "Reading beyond buffer boundaries"
      severity: "high"
      cwe: "CWE-126"
      trigger_conditions:
        - "Length field exceeds actual data"
        - "Missing null terminator check"
        - "Incorrect loop bounds"
    
    - pattern: "buffer_over_write"
      description: "Writing beyond buffer boundaries"
      severity: "critical"
      cwe: "CWE-787"
      trigger_conditions:
        - "Unbounded copy operation"
        - "Incorrect size calculation"
        - "Off-by-one in index"
    
    - pattern: "heap_buffer_overflow"
      description: "Overflow in heap-allocated buffer"
      severity: "critical"
      cwe: "CWE-122"
      trigger_conditions:
        - "Dynamic allocation with wrong size"
        - "Reallocation too small"
        - "String concatenation overflow"
    
    - pattern: "stack_buffer_overflow"
      description: "Overflow in stack-allocated buffer"
      severity: "critical"
      cwe: "CWE-121"
      trigger_conditions:
        - "Fixed-size buffer with variable input"
        - "strcpy/sprintf usage"
        - "Recursive calls with large frames"

  injection_vulnerabilities:
    - pattern: "null_byte_injection"
      description: "Null byte terminates string prematurely"
      severity: "high"
      cwe: "CWE-626"
      trigger_conditions:
        - "Length-prefixed and null-terminated mix"
        - "C string functions on binary data"
        - "Filename/path handling"
    
    - pattern: "header_injection"
      description: "Attacker injects protocol headers"
      severity: "high"
      cwe: "CWE-113"
      trigger_conditions:
        - "CRLF in header value"
        - "Newline in log message"
        - "Unescaped user input in headers"
    
    - pattern: "command_injection"
      description: "Protocol commands injected through data"
      severity: "critical"
      cwe: "CWE-77"
      trigger_conditions:
        - "User data passed to shell"
        - "Protocol command in filename"
        - "Metacharacter not escaped"

  protocol_vulnerabilities:
    - pattern: "request_smuggling"
      description: "Desynchronization of request boundaries"
      severity: "critical"
      cwe: "CWE-444"
      trigger_conditions:
        - "Content-Length and Transfer-Encoding conflict"
        - "Different parser implementations"
        - "Proxy and backend disagree on boundaries"
      variants:
        - "CL.TE smuggling"
        - "TE.CL smuggling"
        - "TE.TE smuggling"
        - "HTTP/2 to HTTP/1.1 downgrade"
    
    - pattern: "response_splitting"
      description: "Attacker splits HTTP response"
      severity: "high"
      cwe: "CWE-113"
      trigger_conditions:
        - "CRLF in redirect location"
        - "Newline in Set-Cookie"
        - "Headers reflect user input"
    
    - pattern: "protocol_downgrade"
      description: "Forcing use of weaker protocol version"
      severity: "high"
      cwe: "CWE-757"
      trigger_conditions:
        - "Version negotiation interception"
        - "Fallback on failure"
        - "Capability stripping"
      affected_protocols:
        - "TLS 1.3 to 1.2"
        - "HTTP/2 to HTTP/1.1"
        - "SSHv2 algorithm downgrade"
    
    - pattern: "state_machine_violation"
      description: "Protocol state machine bypass"
      severity: "high"
      cwe: "CWE-841"
      trigger_conditions:
        - "Out-of-order messages accepted"
        - "Missing state validation"
        - "Race condition in state transition"
    
    - pattern: "desync_attack"
      description: "Frontend/backend protocol desynchronization"
      severity: "critical"
      cwe: "CWE-444"
      trigger_conditions:
        - "Different parsers for same protocol"
        - "Ambiguous message format"
        - "Chunked encoding variations"

  resource_vulnerabilities:
    - pattern: "amplification_attack"
      description: "Small request causes large response"
      severity: "high"
      cwe: "CWE-405"
      trigger_conditions:
        - "DNS ANY query"
        - "NTP monlist"
        - "SSDP NOTIFY"
      amplification_factors:
        dns_any: "28-54x"
        ntp_monlist: "556x"
        memcached: "51000x"
    
    - pattern: "reflection_attack"
      description: "Response sent to spoofed source"
      severity: "high"
      cwe: "CWE-406"
      trigger_conditions:
        - "UDP-based protocol"
        - "No source validation"
        - "Connectionless response"
    
    - pattern: "connection_exhaustion"
      description: "Exhausting connection table/resources"
      severity: "high"
      cwe: "CWE-400"
      trigger_conditions:
        - "Slow loris attack"
        - "Half-open connections"
        - "TCP state table exhaustion"
    
    - pattern: "memory_exhaustion"
      description: "Unbounded memory allocation"
      severity: "high"
      cwe: "CWE-770"
      trigger_conditions:
        - "No limit on request size"
        - "Recursive structure parsing"
        - "Compression bomb"

  timing_vulnerabilities:
    - pattern: "timing_side_channel"
      description: "Information leaked through timing"
      severity: "medium"
      cwe: "CWE-208"
      trigger_conditions:
        - "Non-constant-time comparison"
        - "Early termination on error"
        - "Cache timing differences"
    
    - pattern: "race_condition"
      description: "Protocol race condition"
      severity: "high"
      cwe: "CWE-362"
      trigger_conditions:
        - "TOCTOU on state"
        - "Concurrent message handling"
        - "Non-atomic operations"

  cryptographic_vulnerabilities:
    - pattern: "weak_cipher"
      description: "Use of weak cryptographic algorithm"
      severity: "high"
      cwe: "CWE-327"
      weak_algorithms:
        - "DES, 3DES"
        - "RC4"
        - "MD5, SHA1 for signatures"
        - "RSA-1024"
    
    - pattern: "padding_oracle"
      description: "Padding errors leak plaintext information"
      severity: "critical"
      cwe: "CWE-649"
      trigger_conditions:
        - "Different errors for padding vs MAC"
        - "Timing difference on padding check"
        - "CBC mode with detectable padding"
    
    - pattern: "nonce_reuse"
      description: "Reusing nonce/IV in encryption"
      severity: "critical"
      cwe: "CWE-323"
      trigger_conditions:
        - "Counter overflow"
        - "Random IV collision"
        - "Session resumption without fresh nonce"

  covert_channels:
    - pattern: "protocol_covert_channel"
      description: "Data hidden in protocol fields"
      severity: "medium"
      cwe: "CWE-385"
      channels:
        - "DNS TXT records"
        - "ICMP payload"
        - "TCP ISN"
        - "IP identification field"
        - "HTTP header padding"
    
    - pattern: "timing_covert_channel"
      description: "Data encoded in timing"
      severity: "medium"
      cwe: "CWE-385"
      methods:
        - "Packet interarrival times"
        - "Response delays"
        - "Bandwidth modulation"

# ============================================================================
# EDGE CASES - 100+ UNIQUE CASES
# ============================================================================
edge_cases:
  size_limits:
    - case: "maximum_header_size"
      description: "Headers at or near maximum allowed size"
      tests:
        - "Exactly at limit"
        - "One byte over limit"
        - "Limit per header vs total"
        - "Different limits for request/response"
      protocols:
        http1: "8KB typical server limit"
        http2: "16KB HPACK table, 16MB max frame"
        quic: "Flow control dependent"
    
    - case: "maximum_uri_length"
      description: "URI at maximum length"
      tests:
        - "GET with very long URL"
        - "Query string at limit"
        - "Path components at limit"
      browser_limits:
        ie: "2083 characters"
        chrome: "~32KB"
        nginx: "8KB default"
    
    - case: "maximum_body_size"
      description: "Request/response body at limits"
      tests:
        - "Exactly at server limit"
        - "Content-Length at max uint32/uint64"
        - "Chunked encoding with huge chunks"
    
    - case: "maximum_connections"
      description: "Connection limit handling"
      tests:
        - "At max concurrent connections"
        - "Connection pool exhaustion"
        - "Per-host limits"
        - "Global vs per-client limits"
    
    - case: "maximum_streams_http2"
      description: "HTTP/2 concurrent stream limits"
      tests:
        - "At SETTINGS_MAX_CONCURRENT_STREAMS"
        - "Creating streams after limit"
        - "Closed streams counting"
        - "Push promise streams"

  timeout_handling:
    - case: "connection_timeout"
      description: "Timeout during connection establishment"
      tests:
        - "TCP SYN timeout"
        - "TLS handshake timeout"
        - "HTTP/2 preface timeout"
    
    - case: "read_timeout"
      description: "Timeout waiting for data"
      tests:
        - "Partial header timeout"
        - "Partial body timeout"
        - "Keep-alive timeout"
        - "Between chunks timeout"
    
    - case: "write_timeout"
      description: "Timeout writing data"
      tests:
        - "Slow client write"
        - "Buffer full condition"
        - "Stalled response streaming"
    
    - case: "overall_request_timeout"
      description: "Total request processing timeout"
      tests:
        - "Long-running request"
        - "Timeout during processing"
        - "Timeout accumulation"

  error_recovery:
    - case: "connection_reset"
      description: "RST received mid-stream"
      tests:
        - "RST during request body"
        - "RST during response headers"
        - "RST during chunked body"
    
    - case: "half_closed"
      description: "Half-closed connection handling"
      tests:
        - "FIN from client, server continues"
        - "FIN from server, client continues"
        - "Shutdown write vs read"
    
    - case: "partial_write"
      description: "Write only partially completes"
      tests:
        - "Buffer full returns partial"
        - "Signal interrupts write"
        - "Graceful handling of short write"
    
    - case: "corrupted_data"
      description: "Invalid/corrupted data received"
      tests:
        - "Invalid UTF-8"
        - "Truncated message"
        - "Bad checksum/MAC"

  tcp_edge_cases:
    - case: "tcp_simultaneous_open"
      description: "Both sides send SYN simultaneously"
      tests:
        - "SYN crossing in transit"
        - "State machine handling"
        - "Connection establishment"
    
    - case: "tcp_simultaneous_close"
      description: "Both sides send FIN simultaneously"
      tests:
        - "FIN crossing in transit"
        - "TIME_WAIT handling"
        - "2MSL timeout"
    
    - case: "tcp_out_of_order"
      description: "Segments arrive out of order"
      tests:
        - "Reordering depth"
        - "SACK handling"
        - "Fast retransmit trigger"
    
    - case: "tcp_duplicate_segments"
      description: "Same segment received multiple times"
      tests:
        - "Duplicate detection"
        - "ACK generation"
        - "Memory handling"
    
    - case: "tcp_overlapping_segments"
      description: "Segments overlap in sequence space"
      tests:
        - "Which data takes precedence"
        - "Evasion attacks"
        - "Memory coalescing"

  ip_edge_cases:
    - case: "ip_fragmentation"
      description: "IP packet fragmentation"
      tests:
        - "Fragment overlap"
        - "Tiny fragments"
        - "Fragment timeout"
        - "Reassembly buffer limits"
    
    - case: "jumbo_frames"
      description: "Ethernet jumbo frames"
      tests:
        - "MTU 9000"
        - "Mixed MTU path"
        - "PMTUD with jumbo"
    
    - case: "ipv4_ipv6_interop"
      description: "IPv4/IPv6 interoperability"
      tests:
        - "Dual stack"
        - "Happy Eyeballs"
        - "DNS64/NAT64"
        - "IPv4-mapped IPv6"

  platform_specific:
    - case: "linux_specific"
      description: "Linux networking stack behaviors"
      specifics:
        - "SO_REUSEPORT load balancing"
        - "TCP_FASTOPEN"
        - "splice/sendfile"
        - "io_uring"
        - "eBPF programs"
    
    - case: "bsd_specific"
      description: "BSD/macOS networking differences"
      specifics:
        - "kqueue edge-triggered"
        - "TCP_NOPUSH"
        - "kevent filters"
    
    - case: "windows_specific"
      description: "Windows networking differences"
      specifics:
        - "IOCP completion ports"
        - "WSAPoll limitations"
        - "Named pipe transport"
        - "WinSock error codes"
    
    - case: "container_networking"
      description: "Container/Docker networking"
      specifics:
        - "Bridge mode"
        - "Host mode"
        - "macvlan/ipvlan"
        - "Overlay networks"
        - "CNI plugins"
    
    - case: "cloud_networking"
      description: "Cloud provider networking"
      specifics:
        - "VPC peering"
        - "NAT gateway"
        - "Load balancer"
        - "Private endpoints"
        - "Cross-region latency"

# ============================================================================
# PLATFORM-SPECIFIC ISSUES
# ============================================================================
platform_issues:
  linux:
    socket_options:
      - option: "SO_REUSEADDR"
        behavior: "Allow binding to address in TIME_WAIT"
        security_note: "Can cause port hijacking"
      - option: "SO_REUSEPORT"
        behavior: "Allow multiple sockets on same port"
        load_balancing: "Kernel distributes connections"
      - option: "TCP_NODELAY"
        behavior: "Disable Nagle's algorithm"
        use_case: "Low latency applications"
      - option: "TCP_CORK"
        behavior: "Cork output until full packet"
        use_case: "Batch small writes"
      - option: "TCP_QUICKACK"
        behavior: "Send ACK immediately"
        use_case: "Interactive protocols"
      - option: "TCP_FASTOPEN"
        behavior: "Send data in SYN"
        security: "Replay possible for non-idempotent requests"
    
    kernel_parameters:
      - param: "net.core.somaxconn"
        description: "Maximum listen backlog"
        default: 4096
      - param: "net.ipv4.tcp_max_syn_backlog"
        description: "Maximum SYN queue size"
        default: 128
      - param: "net.ipv4.tcp_syncookies"
        description: "SYN cookie protection"
        default: 1
      - param: "net.ipv4.tcp_tw_reuse"
        description: "TIME_WAIT socket reuse"
        default: 0
      - param: "net.core.rmem_max"
        description: "Maximum receive buffer"
        default: 212992
      - param: "net.core.wmem_max"
        description: "Maximum send buffer"
        default: 212992
    
    io_models:
      - model: "select"
        max_fds: 1024
        edge_triggered: false
        note: "FD_SETSIZE limit"
      - model: "poll"
        max_fds: "unlimited"
        edge_triggered: false
        note: "Linear scan"
      - model: "epoll"
        max_fds: "unlimited"
        edge_triggered: "optional"
        note: "O(1) for ready events"
      - model: "io_uring"
        max_fds: "unlimited"
        edge_triggered: "N/A"
        note: "Kernel 5.1+, async I/O"

  bsd_macos:
    differences:
      - area: "Socket options"
        detail: "TCP_NOPUSH instead of TCP_CORK"
      - area: "Event notification"
        detail: "kqueue instead of epoll"
      - area: "sendfile"
        detail: "Different signature than Linux"
      - area: "Route table"
        detail: "Different ioctl interface"

  windows:
    differences:
      - area: "I/O model"
        detail: "IOCP for async I/O"
      - area: "Socket API"
        detail: "WinSock with different error codes"
      - area: "Nonblocking"
        detail: "ioctlsocket instead of fcntl"
      - area: "File/socket"
        detail: "Separate handles, no unified FD"

  service_mesh:
    - component: "Envoy"
      protocol_handling:
        - "L4/L7 routing"
        - "Connection pooling"
        - "Circuit breaking"
        - "Retry policies"
      edge_cases:
        - "Proxy protocol header"
        - "HTTP/1.1 upgrade"
        - "gRPC bridging"
    
    - component: "Istio"
      protocol_handling:
        - "mTLS injection"
        - "Header manipulation"
        - "Traffic mirroring"
      edge_cases:
        - "Sidecar injection"
        - "Init container networking"
        - "Headless services"

  ebpf_networking:
    programs:
      - type: "XDP"
        description: "eXpress Data Path"
        use_cases:
          - "DDoS mitigation"
          - "Load balancing"
          - "Packet filtering"
      - type: "TC"
        description: "Traffic Control"
        use_cases:
          - "Packet modification"
          - "QoS"
          - "Container networking"
      - type: "Socket"
        description: "Socket programs"
        use_cases:
          - "Socket filtering"
          - "Connection tracking"
          - "Policy enforcement"

# ============================================================================
# DIFFICULTY CONFIGURATION
# ============================================================================
difficulty:
  estimated: "hard"
  time_range: [1800, 5400]
  command_steps: [25, 65]
  
  difficulty_matrix:
    beginner:
      time_range: [600, 1200]
      complexity: "Single protocol, obvious vulnerability"
      example: "Missing Content-Length validation"
    
    intermediate:
      time_range: [1200, 2400]
      complexity: "Protocol interactions, subtle bugs"
      example: "HTTP/1.1 keep-alive resource leak"
    
    advanced:
      time_range: [2400, 3600]
      complexity: "Multi-protocol, security implications"
      example: "HTTP/2 to HTTP/1.1 request smuggling"
    
    expert:
      time_range: [3600, 7200]
      complexity: "Novel attack vectors, cross-layer issues"
      example: "QUIC 0-RTT replay with encrypted SNI"
  
  difficulty_amplifiers:
    nightmare:
      multiplier: 3.0
      description: "Production network incident requiring deep protocol expertise"
      requirements:
        - "12+ deeply interacting traps across OSI layers"
        - "Requires understanding of kernel network stack implementation"
        - "Time estimate: 90-180 minutes for senior network engineers with kernel development experience"
        - "Cross-platform protocol behavior differences"
        - "Requires synthesizing protocol specs, OS internals, and security knowledge"
    
    nightmare_plus:
      multiplier: 5.0
      estimated_time: [28800, 86400]  # 8-24 hours
      command_steps: [400, 1500]
      techniques_required: 12
      description: "Kernel-level debugging difficulty requiring intimate knowledge of TCP/IP stack implementation"
      requirements:
        - "20+ deeply interacting traps across all protocol layers and parser components"
        - "Requires source-level protocol implementation debugging"
        - "Time estimate: 8-24 hours for protocol security researchers"
        - "Must understand implementation variances across all major platforms"
        - "Requires reproducing race conditions in protocol state machines"
        - "Must analyze parser behavior under adversarial memory conditions"
        - "Requires understanding of JIT-compiled protocol parsers (V8, SpiderMonkey)"
        - "Must exploit timing windows in asynchronous protocol handling"
        - "Requires custom fuzzer development for novel attack vectors"
        - "Must chain multiple protocol-layer vulnerabilities into single exploit"
  
  kernel_internals_requirements:
    linux_networking_stack:
      - component: "sk_buff management"
        knowledge_required:
          - "SKB cloning and reference counting"
          - "SKB linearization and fragmentation"
          - "Zero-copy and page pool handling"
          - "GSO/GRO packet coalescing internals"
      - component: "Protocol handler registration"
        knowledge_required:
          - "dev_add_pack() and protocol dispatch"
          - "Network namespace protocol isolation"
          - "Raw socket packet delivery"
      - component: "netfilter protocol helpers"
        knowledge_required:
          - "ALG (Application Layer Gateway) helpers"
          - "Expectation handling for FTP/SIP/etc"
          - "Connection tracking protocol extensions"
      - component: "TCP protocol implementation"
        knowledge_required:
          - "tcp_rcv_state_process() state machine"
          - "TCP out-of-order queue handling"
          - "TCP memory pressure and collapse"
          - "SACK scoreboard implementation"
    
    bsd_socket_layer:
      - component: "mbuf protocol handling"
        knowledge_required:
          - "Protocol header prepending in mbufs"
          - "mbuf cluster chain management"
          - "Protocol input queue processing"
      - component: "KAME IPv6 stack"
        knowledge_required:
          - "Extension header processing"
          - "Fragment reassembly implementation"
          - "Routing header type 0 handling"
    
    windows_networking:
      - component: "NDIS protocol drivers"
        knowledge_required:
          - "Protocol binding and unbinding"
          - "OID request handling"
          - "NBL chain processing"
      - component: "WFP (Windows Filtering Platform)"
        knowledge_required:
          - "Callout driver implementation"
          - "Stream layer inspection"
          - "ALE (Application Layer Enforcement)"
    
    hardware_parsing:
      - component: "NIC protocol offload"
        knowledge_required:
          - "Header split and RSC (Receive Segment Coalescing)"
          - "Flow director and RSS hash computation"
          - "Hardware parser limitations and fallback"
  
  protocol_specification_depth:
    rfc_knowledge:
      - rfc: "RFC 7230-7235 (HTTP/1.1)"
        deep_knowledge:
          - "Message framing ambiguities"
          - "Transfer-Encoding/Content-Length priority"
          - "Request target forms and Host header interaction"
          - "Connection header and hop-by-hop semantics"
      - rfc: "RFC 7540/9113 (HTTP/2)"
        deep_knowledge:
          - "HPACK dynamic table state synchronization"
          - "Stream state machine edge cases"
          - "GOAWAY and stream continuation races"
          - "PUSH_PROMISE validation requirements"
      - rfc: "RFC 9000/9001 (QUIC)"
        deep_knowledge:
          - "Packet number encoding ambiguity"
          - "Connection ID management lifecycle"
          - "Path validation and migration security"
          - "0-RTT replay protection mechanisms"
      - rfc: "RFC 8446 (TLS 1.3)"
        deep_knowledge:
          - "Handshake state machine violations"
          - "Early data (0-RTT) security boundaries"
          - "Post-handshake authentication edge cases"
          - "Key update synchronization"
    
    implementation_variance:
      - protocol: "HTTP/1.1"
        variances:
          - "nginx vs Apache chunk extension handling"
          - "HAProxy vs Envoy request smuggling susceptibility"
          - "Go net/http vs Python requests header normalization"
      - protocol: "TLS"
        variances:
          - "OpenSSL vs BoringSSL vs LibreSSL renegotiation"
          - "GnuTLS vs wolfSSL certificate validation"
          - "NSS vs SChannel extension handling"
      - protocol: "HTTP/2"
        variances:
          - "nghttp2 vs h2 (Go) stream priority handling"
          - "Cloudflare vs AWS ALB HPACK implementation"
    
    state_machine_exploitation:
      - protocol: "HTTP/2"
        attacks:
          - "Rapid Reset (CVE-2023-44487) amplification"
          - "CONTINUATION flood for resource exhaustion"
          - "Priority tree manipulation for DoS"
      - protocol: "QUIC"
        attacks:
          - "Connection migration spoofing"
          - "0-RTT replay for non-idempotent operations"
          - "Key update desynchronization"
    
    timing_side_channels:
      - channel: "TLS record padding"
        exploitation: "Plaintext length inference"
      - channel: "HTTP/2 frame timing"
        exploitation: "Cross-origin information leakage"
      - channel: "DNS response timing"
        exploitation: "Cache state inference"
  
  hardware_considerations:
    nic_parser_limitations:
      - limitation: "Header parsing depth"
        impact: "Deep encapsulation bypasses hardware offload"
        symptoms: ["Sudden performance drop", "CPU parsing fallback"]
      - limitation: "Protocol recognition"
        impact: "Non-standard ports disable offload"
        symptoms: ["Checksum errors", "TSO disabled"]
    
    acceleration_failures:
      - feature: "Inline TLS offload (kTLS)"
        failure_modes:
          - "Cipher suite not supported by hardware"
          - "Record size exceeds hardware limit"
          - "Key update during active transmission"
      - feature: "QUIC hardware offload"
        failure_modes:
          - "Connection ID rotation handling"
          - "0-RTT packet processing order"
          - "Path validation packet format"
    
    dpdk_parser_issues:
      - issue: "Packet classification errors"
        symptoms: ["Wrong queue placement", "Protocol misidentification"]
        diagnosis: ["rte_flow queries", "packet mark inspection"]
      - issue: "Fragmented packet handling"
        symptoms: ["Incomplete reassembly", "Memory leaks"]
        diagnosis: ["IP reassembly stats", "mbuf pool monitoring"]
  
  quality_requirements:
    minimum_difficulty: "90-180 minutes for senior network engineers with kernel development experience"

anti_patterns:
  llm_failure_modes:
    - "Applying generic network debugging without considering protocol state"
    - "Missing socket option inheritance and default value issues"
    - "Ignoring MTU and fragmentation edge cases"
    - "Not considering DNS resolver library differences"
    - "Missing TIME_WAIT and connection state machine issues"
    - "Overlooking TLS handshake and certificate chain problems"
    - "Assuming network behavior is consistent across cloud providers"
    - "Missing race conditions in async network operations"
    - "Ignoring kernel parameter tuning effects on network behavior"
    - "Failing to recognize HTTP request smuggling CL.TE/TE.CL patterns"
    - "Missing Transfer-Encoding header obfuscation techniques"
    - "Ignoring HTTP/2 pseudo-header injection via HPACK"
    - "Not considering QUIC version negotiation downgrade attacks"
    - "Overlooking TLS 1.3 0-RTT replay vulnerability patterns"
    - "Missing gRPC protobuf varint overflow conditions"
    - "Ignoring WebSocket frame fragmentation bomb scenarios"
    - "Not recognizing DNS compression pointer loop attacks"
    - "Failing to identify DNSSEC chain of trust bypass techniques"
    - "Missing BGP path attribute manipulation patterns"
    - "Overlooking OSPF LSA sequence number wrap vulnerabilities"
    - "Ignoring IKEv2 proposal downgrade attack vectors"
    - "Not considering SIP dialog hijacking through Via manipulation"
    - "Missing MQTT retained message poisoning scenarios"
    - "Failing to detect CoAP blockwise transfer vulnerabilities"
    - "Ignoring Modbus function code injection patterns"
    - "Not recognizing SSH channel ID exhaustion attacks"
    - "Missing SRTP key derivation timing vulnerabilities"

generation_targets:
  minimum_difficulty: "90-180 minutes for senior network engineers with kernel development experience"

# ============================================================================
# LLM TRAP CONFIGURATIONS
# ============================================================================
traps:
  - type: "integer_overflow"
    description: "Length field calculation wraps around on large values"
    trigger: "Not validating length before allocating buffer"
    detection_method: "Fuzzing with edge-case values"
    common_mistakes:
      - "Using signed int for unsigned protocol field"
      - "Not checking for overflow in addition"
      - "Assuming length fits in smaller type"
  
  - type: "endian_confusion"
    description: "Mixing big-endian and little-endian operations"
    trigger: "Using wrong byte order functions"
    detection_method: "Cross-platform testing"
    common_mistakes:
      - "Assuming host byte order"
      - "Inconsistent ntohl/ntohs usage"
      - "Bitfield endianness"
  
  - type: "partial_validation"
    description: "Checksum validation can be bypassed with specific values"
    trigger: "Validating checksum before checking length"
    detection_method: "Order-of-operations audit"
    common_mistakes:
      - "Checking MAC before length"
      - "Validation on partial data"
      - "Early return on first error"
  
  - type: "state_machine_confusion"
    description: "Protocol state transitions not enforced"
    trigger: "Messages accepted in wrong state"
    common_mistakes:
      - "No state tracking"
      - "State enum without validation"
      - "Race condition in state update"
  
  - type: "resource_leak"
    description: "Resources not freed on error path"
    trigger: "Exception or error without cleanup"
    common_mistakes:
      - "Early return without cleanup"
      - "No finally/defer block"
      - "Missing error handler"
  
  - type: "injection_flaw"
    description: "User input incorporated unsafely"
    trigger: "Concatenation without sanitization"
    common_mistakes:
      - "String formatting with user data"
      - "No escaping of special characters"
      - "Trust boundary confusion"

# ============================================================================
# TASK GENERATION TEMPLATES
# ============================================================================
instruction_template: |
  You are debugging a {{ scenario_type }} network protocol parser.
  The parser is located at {{ path }}.
  
  Multiple security issues have been reported:
  {{ issues }}
  
  Your task:
  {{ task_steps }}
  
  The protocol handles {{ packet_rate }} packets per second in production.

task_templates:
  security_audit:
    template: |
      Perform a security audit of the {{ protocol }} parser at {{ path }}.
      
      Focus areas:
      1. Integer overflow in size fields
      2. Buffer boundary validation
      3. State machine correctness
      4. Error handling completeness
      5. Resource cleanup in all paths
      
      The parser processes {{ packet_rate }} messages/second.
      Report all vulnerabilities found with severity ratings.
  
  vulnerability_fix:
    template: |
      Fix the {{ vulnerability_type }} vulnerability in {{ path }}.
      
      Vulnerability details:
      {{ vuln_description }}
      
      Requirements:
      - Fix must not break existing functionality
      - Add test cases for the vulnerability
      - Performance impact must be minimal
      - Handle all edge cases
  
  protocol_implementation:
    template: |
      Implement a secure {{ protocol }} parser for {{ use_case }}.
      
      Requirements:
      {{ requirements }}
      
      Security considerations:
      {{ security_requirements }}
      
      Performance target: {{ performance_target }}
  
  fuzzing_harness:
    template: |
      Create a fuzzing harness for the {{ protocol }} parser at {{ path }}.
      
      The harness should:
      1. Accept arbitrary binary input
      2. Exercise all parser code paths
      3. Detect memory safety issues
      4. Report coverage metrics
      
      Target vulnerabilities: {{ target_vulns }}

# ============================================================================
# REFERENCE SOLUTION
# ============================================================================
reference_solution: |
  #!/usr/bin/env python3
  """
  Secure network protocol parser with full validation.
  Demonstrates best practices for protocol parsing security.
  """
  import struct
  import zlib
  from dataclasses import dataclass
  from enum import Enum, auto
  from typing import Optional, Tuple, List
  import logging
  
  # Constants
  MAX_PAYLOAD_SIZE = 1024 * 1024  # 1MB limit
  MAX_HEADER_SIZE = 8192  # 8KB limit
  MAGIC = 0xDEADBEEF
  MIN_PACKET_SIZE = 14  # header + checksum minimum
  
  logger = logging.getLogger(__name__)
  
  class ParseError(Exception):
      """Base exception for parsing errors."""
      pass
  
  class InvalidMagicError(ParseError):
      """Magic number validation failed."""
      pass
  
  class InvalidLengthError(ParseError):
      """Length field validation failed."""
      pass
  
  class ChecksumError(ParseError):
      """Checksum validation failed."""
      pass
  
  class TruncatedPacketError(ParseError):
      """Packet is shorter than expected."""
      pass
  
  class ProtocolVersion(Enum):
      """Supported protocol versions."""
      V1 = 1
      V2 = 2
  
  @dataclass
  class ParsedMessage:
      """Parsed message structure."""
      version: ProtocolVersion
      payload: bytes
      checksum: int
      raw_length: int
  
  def validate_length(length: int, max_size: int, field_name: str) -> None:
      """
      Validate a length field with proper bounds checking.
      
      Raises InvalidLengthError if length is invalid.
      """
      if length < 0:
          raise InvalidLengthError(f"{field_name} cannot be negative: {length}")
      if length > max_size:
          raise InvalidLengthError(
              f"{field_name} exceeds maximum ({length} > {max_size})"
          )
  
  def safe_add(a: int, b: int, max_val: int = 2**63 - 1) -> int:
      """
      Add two integers with overflow check.
      
      Raises OverflowError if result would overflow.
      """
      if a > max_val - b:
          raise OverflowError(f"Integer overflow: {a} + {b}")
      return a + b
  
  def parse_packet(data: bytes) -> ParsedMessage:
      """
      Safely parse network packet with comprehensive validation.
      
      Security measures:
      1. Validate all lengths before use
      2. Check for integer overflow
      3. Validate magic before processing
      4. Verify checksum after all parsing
      5. Handle endianness explicitly
      
      Args:
          data: Raw binary packet data
          
      Returns:
          ParsedMessage with validated contents
          
      Raises:
          ParseError: On any validation failure
      """
      # Length check first - before any parsing
      if len(data) < MIN_PACKET_SIZE:
          raise TruncatedPacketError(
              f"Packet too short: {len(data)} < {MIN_PACKET_SIZE}"
          )
      
      # Parse header with explicit big-endian (network byte order)
      magic = struct.unpack('>I', data[0:4])[0]
      if magic != MAGIC:
          raise InvalidMagicError(f"Invalid magic: {hex(magic)}, expected {hex(MAGIC)}")
      
      version_raw = struct.unpack('>H', data[4:6])[0]
      try:
          version = ProtocolVersion(version_raw)
      except ValueError:
          raise ParseError(f"Unknown protocol version: {version_raw}")
      
      payload_len = struct.unpack('>I', data[6:10])[0]
      
      # Critical: Validate length BEFORE using it
      validate_length(payload_len, MAX_PAYLOAD_SIZE, "payload_length")
      
      # Calculate expected total size with overflow check
      try:
          expected_total = safe_add(10, payload_len)
          expected_total = safe_add(expected_total, 4)  # + checksum
      except OverflowError as e:
          raise InvalidLengthError(f"Length calculation overflow: {e}")
      
      # Validate actual data length
      if len(data) < expected_total:
          raise TruncatedPacketError(
              f"Packet truncated: have {len(data)}, need {expected_total}"
          )
      
      if len(data) > expected_total:
          logger.warning(
              f"Extra data after packet: {len(data) - expected_total} bytes"
          )
      
      # Extract payload and checksum
      payload = data[10:10+payload_len]
      stored_checksum = struct.unpack('>I', data[10+payload_len:10+payload_len+4])[0]
      
      # Calculate and verify checksum AFTER all parsing
      computed_checksum = zlib.crc32(data[:10+payload_len]) & 0xFFFFFFFF
      if computed_checksum != stored_checksum:
          raise ChecksumError(
              f"Checksum mismatch: computed {hex(computed_checksum)}, "
              f"stored {hex(stored_checksum)}"
          )
      
      return ParsedMessage(
          version=version,
          payload=payload,
          checksum=stored_checksum,
          raw_length=expected_total
      )
  
  def parse_packet_stream(stream: bytes) -> List[ParsedMessage]:
      """
      Parse multiple packets from a stream.
      
      Handles packet boundaries correctly and validates each packet.
      """
      messages = []
      offset = 0
      
      while offset < len(stream):
          remaining = stream[offset:]
          
          if len(remaining) < MIN_PACKET_SIZE:
              if len(remaining) > 0:
                  logger.warning(f"Trailing bytes at end of stream: {len(remaining)}")
              break
          
          try:
              message = parse_packet(remaining)
              messages.append(message)
              offset += message.raw_length
          except ParseError as e:
              logger.error(f"Parse error at offset {offset}: {e}")
              break
      
      return messages

# ============================================================================
# TEST CASES
# ============================================================================
fail_to_pass:
  - "test_integer_overflow_length"
  - "test_checksum_bypass"
  - "test_truncated_packet"
  - "test_negative_length"
  - "test_maximum_length"
  - "test_header_injection"
  - "test_state_machine_bypass"

pass_to_pass:
  - "test_valid_packet"
  - "test_magic_validation"
  - "test_version_handling"
  - "test_empty_payload"
  - "test_maximum_valid_payload"

test_scenarios:
  - name: "Integer overflow in length"
    input: "Packet with length = 0xFFFFFFFF"
    expected: "InvalidLengthError"
    severity: "critical"
  
  - name: "Negative length interpretation"
    input: "Packet with length = 0x80000001 (negative in signed)"
    expected: "InvalidLengthError or safe handling"
    severity: "critical"
  
  - name: "Checksum validation order"
    input: "Packet with invalid checksum but truncated"
    expected: "TruncatedPacketError (not ChecksumError)"
    severity: "high"
  
  - name: "Endianness confusion"
    input: "Packet crafted for wrong byte order"
    expected: "InvalidMagicError"
    severity: "medium"

# ============================================================================
# VARIABLES FOR TASK GENERATION
# ============================================================================
variables:
  - name: scenario_type
    type: string
    options:
      - "production"
      - "real-time"
      - "embedded"
      - "high-frequency"
      - "distributed"
      - "edge"
      - "IoT"
      - "financial"
  
  - name: protocol
    type: string
    options:
      - "HTTP/1.1"
      - "HTTP/2"
      - "HTTP/3"
      - "WebSocket"
      - "gRPC"
      - "DNS"
      - "TLS"
      - "MQTT"
      - "CoAP"
      - "custom binary"
  
  - name: path
    type: path
    generator: random_path
    patterns:
      - "src/protocols/{protocol}_parser.rs"
      - "lib/network/{protocol}.py"
      - "core/parsers/{protocol}_handler.go"
  
  - name: packet_rate
    type: int
    min: 1000
    max: 1000000
    unit: "packets/second"
  
  - name: vulnerability_type
    type: string
    options:
      - "integer overflow"
      - "buffer overflow"
      - "request smuggling"
      - "injection"
      - "state machine bypass"
      - "resource exhaustion"
      - "timing attack"
  
  - name: task_steps
    type: template
    value: |
      1. Analyze the protocol parser for vulnerabilities
      2. Fix the integer overflow in length handling
      3. Ensure proper endianness across all fields
      4. Implement secure checksum validation
      5. Add comprehensive error handling
      6. Write test cases for edge cases
      7. Verify performance impact is acceptable

# ============================================================================
# ANTI-HARDCODING MEASURES
# ============================================================================
anti_hardcoding:
  canary_tokens: true
  randomize_paths: true
  dynamic_content: true
  
  randomization_strategies:
    - strategy: "Protocol version rotation"
      description: "Vary protocol version numbers"
    - strategy: "Magic number variation"
      description: "Use different magic values"
    - strategy: "Field order shuffling"
      description: "Reorder header fields"
    - strategy: "Encoding variation"
      description: "Vary between big/little endian"
  
  canary_types:
    - type: "Unique packet ID"
      location: "Header field"
    - type: "Timestamp"
      location: "Payload"
    - type: "Random checksum seed"
      location: "Trailer"

# ============================================================================
# PROTOCOL DIAGRAMS
# ============================================================================
# 
# Custom Binary Protocol Packet Format:
# 
#                               PACKET HEADER                                
# 
#   Magic (4B)   Version (2B)  Length (4B)          Payload (N bytes)     
#   0xDEADBEEF    Big-endian    Big-endian          Variable length       
# 
#                               PACKET TRAILER                               
# 
#                            Checksum (4B CRC32)                             
# 
#
# HTTP/1.1 Request/Response Flow:
#                                               
#  Client                                                 Server  
#                                               
#                                                              
#        GET /path HTTP/1.1                                    
#        Host: example.com                                     
#        Connection: keep-alive                                
#       > 
#                                                              
#                                 HTTP/1.1 200 OK              
#                                 Content-Length: 1234         
#                                 Connection: keep-alive       
#       < 
#                                                              
#        GET /path2 HTTP/1.1 (pipelined)                       
#       > 
#                                                              
#
# HTTP/2 Frame Format:
# 
#                               FRAME HEADER (9 bytes)                       
# 
#      Length (24 bits)   Type (8)  Flags (8)    Stream ID (32 bits)      
# 
#                               FRAME PAYLOAD                                
#                          (Length bytes, variable)                          
# 
#
# TLS 1.3 Handshake:
#                                               
#  Client                                                 Server  
#                                               
#        ClientHello                                           
#        + key_share                                           
#        + supported_versions                                  
#       > 
#                                                              
#                                 ServerHello                  
#                                 + key_share                  
#                                 + supported_versions         
#                                 {EncryptedExtensions}        
#                                 {Certificate}                
#                                 {CertificateVerify}          
#                                 {Finished}                   
#       < 
#                                                              
#        {Finished}                                            
#       > 
#                                                              
#        [Application Data]          [Application Data]        
#       <> 
#
# QUIC Packet Format:
# 
#                            QUIC LONG HEADER                                
# 
#  Header(1)  Version(4) DCID Len(1)   DCID      SCID Len(1)    SCID    
# 
#                           Type-specific fields                             
# 
#                           Encrypted Payload                                
# 
#
# ============================================================================
# END OF PROTOCOL PARSING VULNERABILITY FRAMEWORK
# ============================================================================
