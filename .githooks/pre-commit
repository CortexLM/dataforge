#!/bin/bash
set -e

# Skip hooks when SKIP_GIT_HOOKS=1 is set
if [ "${SKIP_GIT_HOOKS:-0}" = "1" ]; then
  echo "=== pre-commit: skipped (SKIP_GIT_HOOKS=1) ==="
  exit 0
fi

echo "=== pre-commit: formatting code ==="
cargo fmt --all

# Re-stage any files that were reformatted
git diff --name-only | while read -r file; do
  if [ -f "$file" ]; then
    git add "$file"
  fi
done

echo "=== pre-commit: running clippy ==="
cargo clippy --all-targets --all-features -- -D warnings

echo "=== pre-commit: all checks passed ==="
