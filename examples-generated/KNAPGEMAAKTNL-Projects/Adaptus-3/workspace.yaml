id: KNAPGEMAAKTNL-Projects/Adaptus-3
repo: KNAPGEMAAKTNL-Projects/Adaptus
base_commit: d99113ae90f4c86574d04868b130a568b07d9c51
merge_commit: 4705bd7a97db66dd6f48c8eecaa1dd37d34ef86f
language: javascript
difficulty_score: 3
created_at: 2026-02-14T12:56:44.159138811Z
patch: "diff --git a/public/app.js b/public/app.js\nindex 89f8d7f..df2f02e 100644\n--- a/public/app.js\n+++ b/public/app.js\n@@ -15,9 +15,17 @@ const state = {\n async function api(method, path, body) {\n   const opts = { method, headers: { 'Content-Type': 'application/json' } };\n   if (body) opts.body = JSON.stringify(body);\n-  const res = await fetch(`/api${path}`, opts);\n-  if (!res.ok) throw new Error(`API ${method} ${path}: ${res.status}`);\n-  return res.json();\n+  try {\n+    const res = await fetch(`/api${path}`, opts);\n+    if (!res.ok) throw new Error(`API ${method} ${path}: ${res.status}`);\n+    return res.json();\n+  } catch (err) {\n+    // Queue write operations on network failure\n+    if (method !== 'GET' && (err.name === 'TypeError' || err.message === 'Failed to fetch')) {\n+      return queueOfflineRequest(method, path, body);\n+    }\n+    throw err;\n+  }\n }\n \n // â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n@@ -36,6 +44,12 @@ async function init() {\n     });\n   }\n   navigate(location.hash || '#home');\n+\n+  // Offline queue: show badge and sync if online\n+  updateQueueBadge();\n+  if (navigator.onLine && getOfflineQueue().length > 0) {\n+    syncOfflineQueue();\n+  }\n }\n \n // â”€â”€â”€ Router â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n@@ -111,6 +125,139 @@ function formatVolume(kg) {\n   return kg.toString();\n }\n \n+function formatDuration(minutes) {\n+  if (!minutes || minutes <= 0) return '0m';\n+  const h = Math.floor(minutes / 60);\n+  const m = Math.round(minutes % 60);\n+  if (h > 0) return `${h}h ${m}m`;\n+  return `${m}m`;\n+}\n+\n+// â”€â”€â”€ Offline Queue â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n+function getOfflineQueue() {\n+  try { return JSON.parse(localStorage.getItem('adaptus-offline-queue') || '[]'); }\n+  catch { return []; }\n+}\n+\n+function saveOfflineQueue(queue) {\n+  localStorage.setItem('adaptus-offline-queue', JSON.stringify(queue));\n+  updateQueueBadge();\n+}\n+\n+function generateTempId() {\n+  return `temp_${Date.now()}_${Math.random().toString(36).slice(2, 8)}`;\n+}\n+\n+function queueOfflineRequest(method, path, body) {\n+  const queue = getOfflineQueue();\n+  const id = generateTempId();\n+  const entry = { id, method, path, body, timestamp: new Date().toISOString() };\n+\n+  // Temp ID system for session creation\n+  if (method === 'POST' && path === '/workouts') {\n+    entry.tempId = id;\n+    const synthetic = { id, started_at: new Date().toISOString(), completed_at: null, skipped_at: null, ...body };\n+    queue.push(entry);\n+    saveOfflineQueue(queue);\n+    return synthetic;\n+  }\n+\n+  if (method === 'POST' && path === '/sets') {\n+    const tempSetId = generateTempId();\n+    entry.tempId = tempSetId;\n+    // Check if workoutSessionId is a temp ID\n+    if (body && typeof body.workoutSessionId === 'string' && body.workoutSessionId.startsWith('temp_')) {\n+      entry.dependsOnTempId = body.workoutSessionId;\n+    }\n+    const synthetic = { id: tempSetId, logged_at: new Date().toISOString(), ...body };\n+    queue.push(entry);\n+    saveOfflineQueue(queue);\n+    return synthetic;\n+  }\n+\n+  // PUT/DELETE\n+  queue.push(entry);\n+  saveOfflineQueue(queue);\n+  return { queued: true };\n+}\n+\n+async function syncOfflineQueue() {\n+  const queue = getOfflineQueue();\n+  if (queue.length === 0) return;\n+\n+  showSyncToast(`Syncing ${queue.length} pending...`);\n+  const tempIdMap = {};\n+  const failed = [];\n+\n+  for (const entry of queue) {\n+    try {\n+      let { method, path, body } = entry;\n+\n+      // Resolve temp IDs in body\n+      if (body && entry.dependsOnTempId && tempIdMap[entry.dependsOnTempId]) {\n+        body = { ...body, workoutSessionId: tempIdMap[entry.dependsOnTempId] };\n+      }\n+\n+      // Resolve temp IDs in path\n+      for (const [tempId, realId] of Object.entries(tempIdMap)) {\n+        if (path.includes(tempId)) {\n+          path = path.replace(tempId, realId);\n+        }\n+      }\n+\n+      const opts = { method, headers: { 'Content-Type': 'application/json' } };\n+      if (body) opts.body = JSON.stringify(body);\n+      const res = await fetch(`/api${path}`, opts);\n+      if (!res.ok) throw new Error(`${res.status}`);\n+      const data = await res.json();\n+\n+      // Map temp IDs to real IDs\n+      if (entry.tempId && data && data.id) {\n+        tempIdMap[entry.tempId] = data.id;\n+      }\n+    } catch {\n+      failed.push(entry);\n+    }\n+  }\n+\n+  saveOfflineQueue(failed);\n+  if (failed.length === 0) {\n+    showSyncToast('All changes synced');\n+  } else {\n+    showSyncToast(`${failed.length} still pending`);\n+  }\n+}\n+\n+function updateQueueBadge() {\n+  const badge = document.getElementById('offline-badge');\n+  const count = document.getElementById('offline-count');\n+  if (!badge || !count) return;\n+  const queue = getOfflineQueue();\n+  if (queue.length > 0) {\n+    count.textContent = queue.length;\n+    badge.classList.remove('hidden');\n+  } else {\n+    badge.classList.add('hidden');\n+  }\n+}\n+\n+function showSyncToast(message) {\n+  let toast = document.getElementById('sync-toast');\n+  if (!toast) {\n+    toast = document.createElement('div');\n+    toast.id = 'sync-toast';\n+    toast.className = 'fixed top-2 left-1/2 -translate-x-1/2 z-[70] transition-opacity duration-300';\n+    document.body.appendChild(toast);\n+  }\n+  toast.innerHTML = `<span class=\"text-xs font-bold uppercase tracking-widest text-canvas bg-ink px-3 py-1.5\">${message}</span>`;\n+  toast.style.opacity = '1';\n+  clearTimeout(toast._hideTimeout);\n+  toast._hideTimeout = setTimeout(() => {\n+    toast.style.opacity = '0';\n+    setTimeout(() => { if (toast.parentNode) toast.remove(); }, 300);\n+  }, 3000);\n+}\n+\n // â”€â”€â”€ Rest Timer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n function startRestTimer(restStr) {\n   const total = parseRestSeconds(restStr);\n@@ -281,7 +428,7 @@ async function renderDashboard() {\n \n       <div class=\"border-2 border-ink/10 p-5 mb-5\">\n         <h3 class=\"text-[10px] font-bold uppercase tracking-widest text-ink/40 mb-4\">This Week</h3>\n-        <div class=\"grid grid-cols-3 gap-4 mb-4\">\n+        <div class=\"grid grid-cols-2 gap-4 mb-4\">\n           <div>\n             <span class=\"text-3xl font-black leading-none block\">${doneCount}</span>\n             <span class=\"text-[10px] font-bold uppercase tracking-widest text-ink/40\">/ ${weekSummary.totalWorkouts} done</span>\n@@ -294,6 +441,10 @@ async function renderDashboard() {\n             <span class=\"text-3xl font-black leading-none block\">${formatVolume(weekSummary.totalVolume)}</span>\n             <span class=\"text-[10px] font-bold uppercase tracking-widest text-ink/40\">volume</span>\n           </div>\n+          <div>\n+            <span class=\"text-3xl font-black leading-none block\">${weekSummary.totalDuration ? formatDuration(weekSummary.totalDuration) : 'â€”'}</span>\n+            <span class=\"text-[10px] font-bold uppercase tracking-widest text-ink/40\">duration</span>\n+          </div>\n         </div>\n         ${progressDots ? `\n           <div class=\"flex items-center gap-2 mb-4\">\n@@ -334,10 +485,13 @@ async function renderStats() {\n   const summary = await api('GET', '/stats/summary');\n \n   const prsHtml = summary.prs.length > 0 ? summary.prs.map(pr => `\n-    <div class=\"flex items-center justify-between py-3 border-b border-ink/10 last:border-0\">\n+    <button onclick=\"navigate('#exercise-stats/${encodeURIComponent(pr.exercise_name)}')\" class=\"flex items-center justify-between py-3 border-b border-ink/10 last:border-0 w-full text-left active:bg-ink/5 transition-colors duration-200\">\n       <span class=\"font-bold text-[15px] truncate flex-1 mr-3\">${pr.exercise_name}</span>\n-      <span class=\"font-black text-lg flex-shrink-0\">${pr.max_weight}<span class=\"text-sm font-bold text-ink/40 ml-0.5\">kg</span></span>\n-    </div>\n+      <span class=\"flex-shrink-0 text-right\">\n+        <span class=\"font-black text-lg\">${pr.max_weight}<span class=\"text-sm font-bold text-ink/40 ml-0.5\">kg</span></span>\n+        ${pr.estimated_1rm ? `<span class=\"text-xs font-bold text-electric ml-2\">${pr.estimated_1rm} e1rm</span>` : ''}\n+      </span>\n+    </button>\n   `).join('') : '<p class=\"text-sm text-ink/30 py-4\">No data yet. Log some sets!</p>';\n \n   document.getElementById('app').innerHTML = `\n@@ -350,7 +504,7 @@ async function renderStats() {\n \n       <div class=\"border-2 border-ink/10 p-5 mb-5\">\n         <h3 class=\"text-[10px] font-bold uppercase tracking-widest text-ink/40 mb-4\">All Time</h3>\n-        <div class=\"grid grid-cols-3 gap-4\">\n+        <div class=\"grid grid-cols-2 gap-4\">\n           <div>\n             <span class=\"text-3xl font-black leading-none block\">${summary.totalWorkouts}</span>\n             <span class=\"text-[10px] font-bold uppercase tracking-widest text-ink/40\">workouts</span>\n@@ -363,6 +517,10 @@ async function renderStats() {\n             <span class=\"text-3xl font-black leading-none block\">${formatVolume(summary.totalVolume)}</span>\n             <span class=\"text-[10px] font-bold uppercase tracking-widest text-ink/40\">volume (kg)</span>\n           </div>\n+          <div>\n+            <span class=\"text-3xl font-black leading-none block\">${summary.avgDuration ? formatDuration(summary.avgDuration) : 'â€”'}</span>\n+            <span class=\"text-[10px] font-bold uppercase tracking-widest text-ink/40\">avg duration</span>\n+          </div>\n         </div>\n       </div>\n \n@@ -636,7 +794,7 @@ async function renderWorkout(templateId) {\n           ${isCompleted ? '<span class=\"text-[10px] font-bold uppercase tracking-widest text-acid bg-ink px-2 py-1 rounded-full\">Completed</span>' : ''}\n           ${isSkipped ? '<span class=\"text-[10px] font-bold uppercase tracking-widest text-ink/60 bg-ink/10 px-2 py-1 rounded-full\">Skipped</span>' : ''}\n         </div>\n-        <p class=\"text-sm font-bold text-ink/40 uppercase tracking-widest mt-1\">${workout.focus} &middot; Week ${state.progress.week}</p>\n+        <p class=\"text-sm font-bold text-ink/40 uppercase tracking-widest mt-1\">${workout.focus} &middot; Week ${state.progress.week}${isCompleted && state.currentSession.started_at && state.currentSession.completed_at ? ` &middot; ${formatDuration((new Date(state.currentSession.completed_at) - new Date(state.currentSession.started_at)) / 60000)}` : ''}</p>\n       </div>\n \n       ${isSkipped ? `\n@@ -719,7 +877,17 @@ function closeCancelModal() {\n async function confirmCancelWorkout() {\n   closeCancelModal();\n   if (state.currentSession) {\n-    await api('DELETE', `/workouts/${state.currentSession.id}`);\n+    const sessionId = state.currentSession.id;\n+    // If session has a temp ID, remove related queue entries instead of sending DELETE\n+    if (typeof sessionId === 'string' && sessionId.startsWith('temp_')) {\n+      const queue = getOfflineQueue();\n+      const cleaned = queue.filter(e =>\n+        e.tempId !== sessionId && e.dependsOnTempId !== sessionId\n+      );\n+      saveOfflineQueue(cleaned);\n+    } else {\n+      await api('DELETE', `/workouts/${sessionId}`);\n+    }\n   }\n   dismissTimer();\n   // Clear all localStorage drafts for this workout\n@@ -1165,8 +1333,11 @@ async function confirmSkipWorkout(templateId, workoutName) {\n \n // â”€â”€â”€ View: Exercise Stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n async function renderExerciseStats(exerciseName) {\n-  const history = await api('GET', `/sets/exercise-history/${encodeURIComponent(exerciseName)}`);\n-  const pr = await api('GET', `/sets/pr/${encodeURIComponent(exerciseName)}`);\n+  const [history, pr, e1rm] = await Promise.all([\n+    api('GET', `/sets/exercise-history/${encodeURIComponent(exerciseName)}`),\n+    api('GET', `/sets/pr/${encodeURIComponent(exerciseName)}`),\n+    api('GET', `/sets/e1rm/${encodeURIComponent(exerciseName)}`),\n+  ]);\n \n   const prHtml = pr ? `\n     <div class=\"border-2 border-acid bg-acid/5 p-4 mb-5\">\n@@ -1178,6 +1349,14 @@ async function renderExerciseStats(exerciseName) {\n     </div>\n   ` : '';\n \n+  const e1rmHtml = e1rm ? `\n+    <div class=\"border-2 border-electric bg-electric/5 p-4 mb-5\">\n+      <h3 class=\"text-[10px] font-bold uppercase tracking-widest text-electric/60 mb-1\">Estimated 1RM</h3>\n+      <span class=\"text-2xl font-black text-electric\">${e1rm.estimated1rm}<span class=\"text-sm font-bold text-electric/40 ml-0.5\">kg</span></span>\n+      <p class=\"text-xs text-ink/40 mt-1\">From ${e1rm.fromWeight}kg &times; ${e1rm.fromReps} reps</p>\n+    </div>\n+  ` : '';\n+\n   const sessionsHtml = history.length > 0 ? [...history].reverse().map(s => {\n     const date = new Date(s.date).toLocaleDateString();\n     const setsStr = s.sets.map(set => `${set.weight_kg}kg&times;${set.reps}`).join('&ensp;&ensp;');\n@@ -1202,11 +1381,22 @@ async function renderExerciseStats(exerciseName) {\n       <p class=\"text-sm font-bold text-ink/40 uppercase tracking-widest mb-6\">History</p>\n \n       ${prHtml}\n+      ${e1rmHtml}\n \n       ${history.length >= 2 ? `\n         <div class=\"border-2 border-ink/10 p-4 mb-5\">\n-          <h3 class=\"text-[10px] font-bold uppercase tracking-widest text-ink/40 mb-3\">Weight Over Time</h3>\n-          <canvas id=\"progress-chart\" class=\"w-full\" height=\"180\"></canvas>\n+          <h3 class=\"text-[10px] font-bold uppercase tracking-widest text-ink/40 mb-3\">Progress Over Time</h3>\n+          <canvas id=\"progress-chart\" class=\"w-full\" height=\"200\"></canvas>\n+          <div class=\"flex items-center justify-center gap-4 mt-3\">\n+            <div class=\"flex items-center gap-1.5\">\n+              <div class=\"w-3 h-1 bg-[#CCFF00]\"></div>\n+              <span class=\"text-[10px] font-bold uppercase tracking-widest text-ink/40\">Max Weight</span>\n+            </div>\n+            <div class=\"flex items-center gap-1.5\">\n+              <div class=\"w-3 h-1 bg-electric\"></div>\n+              <span class=\"text-[10px] font-bold uppercase tracking-widest text-ink/40\">Est. 1RM</span>\n+            </div>\n+          </div>\n         </div>\n       ` : ''}\n \n@@ -1230,16 +1420,18 @@ function drawProgressChart(history, pr) {\n   // Hi-DPI support\n   const dpr = window.devicePixelRatio || 1;\n   const rect = canvas.getBoundingClientRect();\n+  const H = 200;\n   canvas.width = rect.width * dpr;\n-  canvas.height = 180 * dpr;\n+  canvas.height = H * dpr;\n   ctx.scale(dpr, dpr);\n   const W = rect.width;\n-  const H = 180;\n \n   const weights = history.map(s => s.maxWeight);\n-  const minW = Math.min(...weights);\n-  const maxW = Math.max(...weights);\n-  const range = maxW - minW || 1;\n+  const e1rms = history.map(s => s.bestE1rm || 0);\n+  const allValues = [...weights, ...e1rms.filter(v => v > 0)];\n+  const minV = Math.min(...allValues);\n+  const maxV = Math.max(...allValues);\n+  const range = maxV - minV || 1;\n \n   const padTop = 20, padBottom = 30, padLeft = 40, padRight = 15;\n   const chartW = W - padLeft - padRight;\n@@ -1251,7 +1443,7 @@ function drawProgressChart(history, pr) {\n   ctx.textAlign = 'right';\n   const steps = 4;\n   for (let i = 0; i <= steps; i++) {\n-    const val = minW + (range * i / steps);\n+    const val = minV + (range * i / steps);\n     const y = padTop + chartH - (chartH * i / steps);\n     ctx.fillText(Math.round(val) + '', padLeft - 8, y + 3);\n     ctx.strokeStyle = 'rgba(0,0,0,0.06)';\n@@ -1261,38 +1453,68 @@ function drawProgressChart(history, pr) {\n     ctx.stroke();\n   }\n \n+  // X positions\n+  const xPositions = history.map((s, i) => padLeft + (chartW * i / (history.length - 1)));\n+\n   // X axis labels\n   ctx.textAlign = 'center';\n   ctx.fillStyle = 'rgba(0,0,0,0.25)';\n-  const points = history.map((s, i) => {\n-    const x = padLeft + (chartW * i / (history.length - 1));\n-    const y = padTop + chartH - (chartH * (s.maxWeight - minW) / range);\n-    return { x, y, s };\n-  });\n-\n-  points.forEach((p, i) => {\n+  xPositions.forEach((x, i) => {\n     if (history.length <= 12 || i % Math.ceil(history.length / 8) === 0) {\n-      ctx.fillText('W' + p.s.weekNumber, p.x, H - 8);\n+      ctx.fillText('W' + history[i].weekNumber, x, H - 8);\n     }\n   });\n \n-  // Line\n+  // Helper: map value to Y\n+  const toY = (val) => padTop + chartH - (chartH * (val - minV) / range);\n+\n+  // E1RM line (draw first so weight line is on top)\n+  const hasE1rm = e1rms.some(v => v > 0);\n+  if (hasE1rm) {\n+    ctx.strokeStyle = '#7C3AED';\n+    ctx.lineWidth = 2;\n+    ctx.lineJoin = 'round';\n+    ctx.setLineDash([4, 3]);\n+    ctx.beginPath();\n+    e1rms.forEach((val, i) => {\n+      if (val <= 0) return;\n+      const x = xPositions[i];\n+      const y = toY(val);\n+      if (i === 0 || e1rms[i - 1] <= 0) ctx.moveTo(x, y);\n+      else ctx.lineTo(x, y);\n+    });\n+    ctx.stroke();\n+    ctx.setLineDash([]);\n+\n+    // E1RM dots\n+    e1rms.forEach((val, i) => {\n+      if (val <= 0) return;\n+      ctx.beginPath();\n+      ctx.arc(xPositions[i], toY(val), 2.5, 0, Math.PI * 2);\n+      ctx.fillStyle = '#7C3AED';\n+      ctx.fill();\n+    });\n+  }\n+\n+  // Weight line\n   ctx.strokeStyle = '#CCFF00';\n   ctx.lineWidth = 2.5;\n   ctx.lineJoin = 'round';\n   ctx.beginPath();\n-  points.forEach((p, i) => {\n-    if (i === 0) ctx.moveTo(p.x, p.y);\n-    else ctx.lineTo(p.x, p.y);\n+  weights.forEach((val, i) => {\n+    const x = xPositions[i];\n+    const y = toY(val);\n+    if (i === 0) ctx.moveTo(x, y);\n+    else ctx.lineTo(x, y);\n   });\n   ctx.stroke();\n \n-  // Dots\n+  // Weight dots\n   const prWeight = pr ? pr.weight_kg : null;\n-  points.forEach(p => {\n-    const isPr = p.s.maxWeight === prWeight;\n+  weights.forEach((val, i) => {\n+    const isPr = val === prWeight;\n     ctx.beginPath();\n-    ctx.arc(p.x, p.y, isPr ? 5 : 3, 0, Math.PI * 2);\n+    ctx.arc(xPositions[i], toY(val), isPr ? 5 : 3, 0, Math.PI * 2);\n     ctx.fillStyle = '#CCFF00';\n     ctx.fill();\n     if (isPr) {\n@@ -1303,5 +1525,16 @@ function drawProgressChart(history, pr) {\n   });\n }\n \n+// â”€â”€â”€ Online/Offline Events â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n+window.addEventListener('online', async () => {\n+  showSyncToast('Back online');\n+  await syncOfflineQueue();\n+  navigate(location.hash || '#home');\n+});\n+\n+window.addEventListener('offline', () => {\n+  showSyncToast('You are offline');\n+});\n+\n // â”€â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n init();\ndiff --git a/public/index.html b/public/index.html\nindex 9d1f125..70c594d 100644\n--- a/public/index.html\n+++ b/public/index.html\n@@ -45,6 +45,13 @@\n     <!-- Views rendered here by app.js -->\n   </div>\n \n+  <!-- Offline queue badge -->\n+  <div id=\"offline-badge\" class=\"fixed top-2 right-2 z-[60] hidden\">\n+    <span class=\"text-xs font-bold uppercase tracking-widest text-canvas bg-electric px-2 py-1\">\n+      <span id=\"offline-count\">0</span> pending\n+    </span>\n+  </div>\n+\n   <!-- Rest timer (persistent floating bar) -->\n   <div id=\"rest-timer\" class=\"fixed bottom-0 left-0 right-0 z-50 hidden\" style=\"padding-bottom: env(safe-area-inset-bottom);\">\n     <div id=\"timer-bar\" class=\"bg-ink text-canvas px-4 py-3 flex items-center justify-between\">\ndiff --git a/public/sw.js b/public/sw.js\nindex 3477e38..8b15db8 100644\n--- a/public/sw.js\n+++ b/public/sw.js\n@@ -1,4 +1,4 @@\n-const CACHE_NAME = 'adaptus-v4';\n+const CACHE_NAME = 'adaptus-v5';\n const STATIC_ASSETS = [\n   '/',\n   '/index.html',\ndiff --git a/routes/sets.js b/routes/sets.js\nindex 8aac65d..45da8c7 100644\n--- a/routes/sets.js\n+++ b/routes/sets.js\n@@ -47,6 +47,24 @@ router.get('/pr/:exerciseName', (req, res) => {\n   res.json(pr || null);\n });\n \n+router.get('/e1rm/:exerciseName', (req, res) => {\n+  const exerciseName = req.params.exerciseName;\n+  const sets = all(\n+    `SELECT weight_kg, reps, logged_at FROM set_logs WHERE exercise_name = ?`,\n+    [exerciseName]\n+  );\n+  if (!sets || sets.length === 0) return res.json(null);\n+\n+  let best = null;\n+  for (const s of sets) {\n+    const e1rm = s.weight_kg * (1 + s.reps / 30);\n+    if (!best || e1rm > best.estimated1rm) {\n+      best = { estimated1rm: Math.round(e1rm * 10) / 10, fromWeight: s.weight_kg, fromReps: s.reps, loggedAt: s.logged_at };\n+    }\n+  }\n+  res.json(best);\n+});\n+\n router.get('/exercise-history/:exerciseName', (req, res) => {\n   const exerciseName = req.params.exerciseName;\n   const sessions = all(\n@@ -68,11 +86,17 @@ router.get('/exercise-history/:exerciseName', (req, res) => {\n        ORDER BY set_number ASC`,\n       [s.workout_session_id, exerciseName]\n     );\n+    let bestE1rm = 0;\n+    for (const set of sets) {\n+      const e1rm = set.weight_kg * (1 + set.reps / 30);\n+      if (e1rm > bestE1rm) bestE1rm = e1rm;\n+    }\n     return {\n       date: s.date,\n       cycle: s.cycle,\n       weekNumber: s.week_number,\n       maxWeight: s.maxWeight,\n+      bestE1rm: Math.round(bestE1rm * 10) / 10,\n       totalVolume: Math.round(s.totalVolume),\n       sets,\n     };\ndiff --git a/routes/stats.js b/routes/stats.js\nindex ba98f7e..e466b12 100644\n--- a/routes/stats.js\n+++ b/routes/stats.js\n@@ -7,7 +7,8 @@ router.get('/summary', (req, res) => {\n     SELECT\n       COUNT(DISTINCT ws.id) as total_workouts,\n       COALESCE(SUM(sl.weight_kg * sl.reps), 0) as total_volume,\n-      COUNT(sl.id) as total_sets\n+      COUNT(sl.id) as total_sets,\n+      AVG((julianday(ws.completed_at) - julianday(ws.started_at)) * 24 * 60) as avg_duration_minutes\n     FROM workout_sessions ws\n     LEFT JOIN set_logs sl ON sl.workout_session_id = ws.id\n     WHERE ws.completed_at IS NOT NULL\n@@ -20,10 +21,22 @@ router.get('/summary', (req, res) => {\n     ORDER BY exercise_name ASC\n   `);\n \n+  // Compute estimated 1RM per exercise\n+  for (const pr of prs) {\n+    const allSets = all(`SELECT weight_kg, reps FROM set_logs WHERE exercise_name = ?`, [pr.exercise_name]);\n+    let maxE1rm = 0;\n+    for (const s of allSets) {\n+      const e1rm = s.weight_kg * (1 + s.reps / 30);\n+      if (e1rm > maxE1rm) maxE1rm = e1rm;\n+    }\n+    pr.estimated_1rm = Math.round(maxE1rm * 10) / 10;\n+  }\n+\n   res.json({\n     totalWorkouts: totals.total_workouts || 0,\n     totalSets: totals.total_sets || 0,\n     totalVolume: Math.round(totals.total_volume || 0),\n+    avgDuration: totals.avg_duration_minutes ? Math.round(totals.avg_duration_minutes) : null,\n     prs,\n   });\n });\n@@ -36,7 +49,8 @@ router.get('/week-summary', (req, res) => {\n     SELECT\n       COUNT(DISTINCT ws.id) as workouts_completed,\n       COALESCE(SUM(sl.weight_kg * sl.reps), 0) as total_volume,\n-      COUNT(sl.id) as total_sets\n+      COUNT(sl.id) as total_sets,\n+      SUM((julianday(ws.completed_at) - julianday(ws.started_at)) * 24 * 60) as total_duration_minutes\n     FROM workout_sessions ws\n     LEFT JOIN set_logs sl ON sl.workout_session_id = ws.id\n     WHERE ws.cycle = ? AND ws.week_number = ? AND ws.completed_at IS NOT NULL\n@@ -72,6 +86,7 @@ router.get('/week-summary', (req, res) => {\n     totalWorkouts: 5,\n     totalSets: stats.total_sets || 0,\n     totalVolume: Math.round(stats.total_volume || 0),\n+    totalDuration: stats.total_duration_minutes ? Math.round(stats.total_duration_minutes) : null,\n     prsThisWeek,\n   });\n });\n"
test_patch: ''
fail_to_pass: []
pass_to_pass:
- node --test
install_config:
  install: npm install
  node: '20'
  test_cmd: npm test
meta:
  added_lines: '318'
  difficulty: hard
  files_changed: '5'
  pr_title: 'feat: workout duration, estimated 1RM, and offline queue'
  removed_lines: '39'
  source: gh-archive-pr
  test_generation: agentic
prompt: |-
  KNAPGEMAAKTNL-Projects/Adaptus (#3): feat: workout duration, estimated 1RM, and offline queue

  ## Summary
  - **Workout Duration**: Derive from existing timestamps, display avg duration in stats, weekly total on dashboard, per-workout completion time
  - **Estimated 1RM**: Epley formula endpoint, e1rm per session in exercise history, electric purple accent card, dual-line progress chart, clickable exercise names in PR list
  - **Offline Queue**: Queue failed writes in localStorage with temp ID system, synthetic responses, auto-sync on reconnect, persistent badge, toast notifications, cancel cleanup

  ## Test plan
  - [ ] Complete a workout â†’ "Completed in X min" shows, dashboard/stats show duration
  - [ ] Exercise stats page shows estimated 1RM card, chart has two lines with legend
  - [ ] Stats page PR list shows e1rm values, exercise names are clickable
  - [ ] Turn off network â†’ log sets â†’ "X pending" badge appears
  - [ ] Turn on network â†’ queue syncs â†’ badge disappears â†’ data persists
  - [ ] Cancel workout while offline â†’ queue cleaned up

  ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)
quality_score: 0.72
quality_passed: true
docker_passed: false
workspace_path: null
status: ready
