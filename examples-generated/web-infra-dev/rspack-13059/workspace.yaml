id: web-infra-dev/rspack-13059
repo: web-infra-dev/rspack
base_commit: 0570e64fc7d4fbd9e82dc4a208ad986c18a005d7
merge_commit: 194cdee13a455a70f15ae82d2cc86f57afedb449
language: rust
difficulty_score: 3
created_at: 2026-02-14T12:49:58.972395447Z
patch: "diff --git a/.agents/ARTIFACTS.md b/.agents/ARTIFACTS.md\nindex aa00a136e1ab..7b5d26b9f16a 100644\n--- a/.agents/ARTIFACTS.md\n+++ b/.agents/ARTIFACTS.md\n@@ -8,6 +8,14 @@ Artifacts are data structures that hold intermediate compilation results. They a\n \n ## Core Concepts\n \n+### PASS Binding Rule\n+\n+An artifact's `PASS` must be bound to the pass where that artifact is first built in the compilation pipeline.\n+\n+- If an artifact is first produced in pass `X`, set `ArtifactExt::PASS` to `X`.\n+- Do not use `empty` as a fallback.\n+- If an artifact is read in later passes, it still stays bound to its first-build pass.\n+\n ### ArtifactExt Trait\n \n The `ArtifactExt` trait is the foundation of the artifact system. It associates each artifact with its corresponding incremental pass and provides recovery logic.\n@@ -60,7 +68,7 @@ Artifacts that directly implement `ArtifactExt`:\n | `SideEffectsOptimizeArtifact`     | `SIDE_EFFECTS_OPTIMIZATION`    | Side effects optimization data  |\n | `AsyncModulesArtifact`            | `INFER_ASYNC_MODULES`          | Async modules information       |\n | `DependenciesDiagnosticsArtifact` | `DEPENDENCIES_DIAGNOSTICS`     | Dependencies diagnostics        |\n-| `ImportedByDeferModulesArtifact`  | empty                          | Deferred module import tracking |\n+| `ImportedByDeferModulesArtifact`  | `OPTIMIZE_CHUNK_MODULES`       | Deferred module import tracking |\n \n ### Cache Artifacts\n \ndiff --git a/crates/node_binding/napi-binding.d.ts b/crates/node_binding/napi-binding.d.ts\nindex f8297d26cada..49d77662c542 100644\n--- a/crates/node_binding/napi-binding.d.ts\n+++ b/crates/node_binding/napi-binding.d.ts\n@@ -2328,6 +2328,7 @@ export interface RawIncremental {\n   finishModules: boolean\n   optimizeDependencies: boolean\n   buildChunkGraph: boolean\n+  optimizeChunkModules: boolean\n   moduleIds: boolean\n   chunkIds: boolean\n   modulesHashes: boolean\ndiff --git a/crates/rspack/tests/snapshots/defaults__default_options.snap b/crates/rspack/tests/snapshots/defaults__default_options.snap\nindex 3ade0c74f985..71205698f8cb 100644\n--- a/crates/rspack/tests/snapshots/defaults__default_options.snap\n+++ b/crates/rspack/tests/snapshots/defaults__default_options.snap\n@@ -1714,7 +1714,7 @@ CompilerOptions {\n     incremental: IncrementalOptions {\n         silent: true,\n         passes: IncrementalPasses(\n-            BUILD_MODULE_GRAPH | FINISH_MODULES | OPTIMIZE_DEPENDENCIES | MODULE_IDS | CHUNK_IDS | MODULES_HASHES | MODULES_CODEGEN | MODULES_RUNTIME_REQUIREMENTS | CHUNKS_RUNTIME_REQUIREMENTS | CHUNKS_HASHES | CHUNK_ASSET | EMIT_ASSETS,\n+            BUILD_MODULE_GRAPH | FINISH_MODULES | OPTIMIZE_DEPENDENCIES | OPTIMIZE_CHUNK_MODULES | MODULE_IDS | CHUNK_IDS | MODULES_HASHES | MODULES_CODEGEN | MODULES_RUNTIME_REQUIREMENTS | CHUNKS_RUNTIME_REQUIREMENTS | CHUNKS_HASHES | CHUNK_ASSET | EMIT_ASSETS,\n         ),\n     },\n     node: Some(\ndiff --git a/crates/rspack_binding_api/src/raw_options/raw_experiments/raw_incremental.rs b/crates/rspack_binding_api/src/raw_options/raw_experiments/raw_incremental.rs\nindex f13db2789540..71e12090cf16 100644\n--- a/crates/rspack_binding_api/src/raw_options/raw_experiments/raw_incremental.rs\n+++ b/crates/rspack_binding_api/src/raw_options/raw_experiments/raw_incremental.rs\n@@ -10,6 +10,7 @@ pub struct RawIncremental {\n   pub finish_modules: bool,\n   pub optimize_dependencies: bool,\n   pub build_chunk_graph: bool,\n+  pub optimize_chunk_modules: bool,\n   pub module_ids: bool,\n   pub chunk_ids: bool,\n   pub modules_hashes: bool,\n@@ -36,6 +37,9 @@ impl From<RawIncremental> for IncrementalOptions {\n     if value.build_chunk_graph {\n       passes.insert(IncrementalPasses::BUILD_CHUNK_GRAPH);\n     }\n+    if value.optimize_chunk_modules {\n+      passes.insert(IncrementalPasses::OPTIMIZE_CHUNK_MODULES);\n+    }\n     if value.module_ids {\n       passes.insert(IncrementalPasses::MODULE_IDS);\n     }\ndiff --git a/crates/rspack_core/src/artifacts/imported_by_defer_modules_artifact.rs b/crates/rspack_core/src/artifacts/imported_by_defer_modules_artifact.rs\nindex 08c7a1fdb57c..61803d4fe8f5 100644\n--- a/crates/rspack_core/src/artifacts/imported_by_defer_modules_artifact.rs\n+++ b/crates/rspack_core/src/artifacts/imported_by_defer_modules_artifact.rs\n@@ -8,8 +8,7 @@ use crate::{ArtifactExt, incremental::IncrementalPasses};\n pub struct ImportedByDeferModulesArtifact(IdentifierSet);\n \n impl ArtifactExt for ImportedByDeferModulesArtifact {\n-  // FIXME: define a proper incremental pass for this artifact\n-  const PASS: IncrementalPasses = IncrementalPasses::empty();\n+  const PASS: IncrementalPasses = IncrementalPasses::OPTIMIZE_CHUNK_MODULES;\n }\n \n impl Deref for ImportedByDeferModulesArtifact {\ndiff --git a/crates/rspack_core/src/artifacts/mod.rs b/crates/rspack_core/src/artifacts/mod.rs\nindex 0d51efe998b7..6810b53b5418 100644\n--- a/crates/rspack_core/src/artifacts/mod.rs\n+++ b/crates/rspack_core/src/artifacts/mod.rs\n@@ -34,8 +34,8 @@ pub trait ArtifactExt: Sized {\n \n   /// Determines whether this artifact should be recovered from the previous compilation.\n   ///\n-  /// Returns `true` if the artifact's pass is empty (always recover) or if\n-  /// the incremental system has readable mutations for this artifact's pass.\n+  /// Returns `true` when the incremental system has readable mutations for\n+  /// this artifact's pass.\n   fn should_recover(incremental: &Incremental) -> bool {\n     incremental.mutations_readable(Self::PASS)\n   }\ndiff --git a/crates/rspack_core/src/cache/memory.rs b/crates/rspack_core/src/cache/memory.rs\nindex a4f1a4b77bf9..4dfa0ec19fe0 100644\n--- a/crates/rspack_core/src/cache/memory.rs\n+++ b/crates/rspack_core/src/cache/memory.rs\n@@ -90,6 +90,18 @@ impl Cache for MemoryCache {\n     }\n   }\n \n+  // OPTIMIZE_CHUNK_MODULES: imported_by_defer_modules_artifact\n+  async fn before_optimize_chunk_modules(&mut self, compilation: &mut Compilation) {\n+    if let Some(old_compilation) = self.old_compilation.as_mut() {\n+      let incremental = &compilation.incremental;\n+      recover_artifact(\n+        incremental,\n+        &mut compilation.imported_by_defer_modules_artifact,\n+        &mut old_compilation.imported_by_defer_modules_artifact,\n+      );\n+    }\n+  }\n+\n   // MODULE_IDS: module_ids_artifact\n   async fn before_module_ids(&mut self, compilation: &mut Compilation) {\n     if let Some(old_compilation) = self.old_compilation.as_mut() {\ndiff --git a/crates/rspack_core/src/cache/mixed.rs b/crates/rspack_core/src/cache/mixed.rs\nindex eadc3c0425c7..67cc1059aa9a 100644\n--- a/crates/rspack_core/src/cache/mixed.rs\n+++ b/crates/rspack_core/src/cache/mixed.rs\n@@ -99,6 +99,22 @@ impl Cache for MixedCache {\n     self.persistent.after_build_chunk_graph(compilation).await;\n   }\n \n+  // OPTIMIZE_CHUNK_MODULES hooks\n+  async fn before_optimize_chunk_modules(&mut self, compilation: &mut Compilation) {\n+    self.memory.before_optimize_chunk_modules(compilation).await;\n+    self\n+      .persistent\n+      .before_optimize_chunk_modules(compilation)\n+      .await;\n+  }\n+\n+  async fn after_optimize_chunk_modules(&self, compilation: &Compilation) {\n+    self\n+      .persistent\n+      .after_optimize_chunk_modules(compilation)\n+      .await;\n+  }\n+\n   // MODULE_IDS hooks\n   async fn before_module_ids(&mut self, compilation: &mut Compilation) {\n     self.memory.before_module_ids(compilation).await;\ndiff --git a/crates/rspack_core/src/cache/mod.rs b/crates/rspack_core/src/cache/mod.rs\nindex a8a400da3059..be0566ad9517 100644\n--- a/crates/rspack_core/src/cache/mod.rs\n+++ b/crates/rspack_core/src/cache/mod.rs\n@@ -48,6 +48,10 @@ pub trait Cache: Debug + Send + Sync {\n   async fn before_build_chunk_graph(&mut self, _compilation: &mut Compilation) {}\n   async fn after_build_chunk_graph(&mut self, _compilation: &mut Compilation) {}\n \n+  // OPTIMIZE_CHUNK_MODULES hooks\n+  async fn before_optimize_chunk_modules(&mut self, _compilation: &mut Compilation) {}\n+  async fn after_optimize_chunk_modules(&self, _compilation: &Compilation) {}\n+\n   // MODULE_IDS hooks\n   async fn before_module_ids(&mut self, _compilation: &mut Compilation) {}\n   async fn after_module_ids(&self, _compilation: &Compilation) {}\ndiff --git a/crates/rspack_core/src/compilation/optimize_chunk_modules/mod.rs b/crates/rspack_core/src/compilation/optimize_chunk_modules/mod.rs\nindex e8d998a18ca8..45428a1894bd 100644\n--- a/crates/rspack_core/src/compilation/optimize_chunk_modules/mod.rs\n+++ b/crates/rspack_core/src/compilation/optimize_chunk_modules/mod.rs\n@@ -1,7 +1,7 @@\n use async_trait::async_trait;\n \n use super::*;\n-use crate::compilation::pass::PassExt;\n+use crate::{cache::Cache, compilation::pass::PassExt};\n \n pub struct OptimizeChunkModulesPass;\n \n@@ -11,6 +11,10 @@ impl PassExt for OptimizeChunkModulesPass {\n     \"optimize chunk modules\"\n   }\n \n+  async fn before_pass(&self, compilation: &mut Compilation, cache: &mut dyn Cache) {\n+    cache.before_optimize_chunk_modules(compilation).await;\n+  }\n+\n   async fn run_pass(&self, compilation: &mut Compilation) -> Result<()> {\n     compilation\n       .plugin_driver\n@@ -24,4 +28,8 @@ impl PassExt for OptimizeChunkModulesPass {\n \n     Ok(())\n   }\n+\n+  async fn after_pass(&self, compilation: &mut Compilation, cache: &mut dyn Cache) {\n+    cache.after_optimize_chunk_modules(compilation).await;\n+  }\n }\ndiff --git a/crates/rspack_core/src/incremental/mod.rs b/crates/rspack_core/src/incremental/mod.rs\nindex f52dfa5919ab..b758ae74ab30 100644\n--- a/crates/rspack_core/src/incremental/mod.rs\n+++ b/crates/rspack_core/src/incremental/mod.rs\n@@ -29,34 +29,37 @@ bitflags! {\n     /// Webpack stage: compilation.hooks.seal\n     /// https://webpack.js.org/api/compilation-hooks/#seal\n     const BUILD_CHUNK_GRAPH = 1 << 3;\n+    /// Webpack stage: compilation.hooks.optimizeChunkModules\n+    /// https://webpack.js.org/api/compilation-hooks/#optimizechunkmodules\n+    const OPTIMIZE_CHUNK_MODULES = 1 << 4;\n     /// Webpack stage: compilation.hooks.moduleIds\n     /// https://webpack.js.org/api/compilation-hooks/#moduleids\n-    const MODULE_IDS = 1 << 4;\n+    const MODULE_IDS = 1 << 5;\n     /// Webpack stage: compilation.hooks.chunkIds\n     /// https://webpack.js.org/api/compilation-hooks/#chunkids\n-    const CHUNK_IDS = 1 << 5;\n+    const CHUNK_IDS = 1 << 6;\n     /// Webpack stage: compilation.hooks.moduleHash beforeModuleHash / afterModuleHash\n     /// https://webpack.js.org/api/compilation-hooks/#beforemodulehash\n     /// https://webpack.js.org/api/compilation-hooks/#aftermodulehash\n-    const MODULES_HASHES = 1 << 6;\n+    const MODULES_HASHES = 1 << 7;\n     /// Webpack stage: compilation.hooks.codeGeneration / afterCodeGeneration\n     /// https://github.com/webpack/webpack/blob/d2a124db548cad6e84dffd93b502a4e74bfe2b6a/lib/Compilation.js#L902\n-    const MODULES_CODEGEN = 1 << 7;\n+    const MODULES_CODEGEN = 1 << 8;\n     /// Webpack stage: compilation.hooks.beforeRuntimeRequirement / afterRuntimeRequirement\n     /// https://github.com/webpack/webpack/blob/d2a124db548cad6e84dffd93b502a4e74bfe2b6a/lib/Compilation.js#L907\n-    const MODULES_RUNTIME_REQUIREMENTS = 1 << 8;\n-    const CHUNKS_RUNTIME_REQUIREMENTS = 1 << 9;\n+    const MODULES_RUNTIME_REQUIREMENTS = 1 << 9;\n+    const CHUNKS_RUNTIME_REQUIREMENTS = 1 << 10;\n     /// Webpack stage: compilation.hooks.chunkHash / contentHash\n     /// https://webpack.js.org/api/compilation-hooks/#contenthash\n-    const CHUNKS_HASHES = 1 << 10;\n+    const CHUNKS_HASHES = 1 << 11;\n     /// Webpack stage: compilation.hooks.chunkAsset\n     /// https://webpack.js.org/api/compilation-hooks/#chunkasset\n-    const CHUNK_ASSET = 1 << 11;\n+    const CHUNK_ASSET = 1 << 12;\n     /// Webpack stage: compiler.hooks.emit / afterEmit / assetEmitted\n     /// https://webpack.js.org/api/compiler-hooks/#emit\n     /// https://webpack.js.org/api/compiler-hooks/#afteremit\n     /// https://webpack.js.org/api/compiler-hooks/#assetemitted\n-    const EMIT_ASSETS = 1 << 12;\n+    const EMIT_ASSETS = 1 << 13;\n   }\n }\n \n@@ -67,6 +70,7 @@ impl IncrementalPasses {\n       Self::FINISH_MODULES => \"finishModules\",\n       Self::OPTIMIZE_DEPENDENCIES => \"optimizeDependencies\",\n       Self::BUILD_CHUNK_GRAPH => \"buildChunkGraph\",\n+      Self::OPTIMIZE_CHUNK_MODULES => \"optimizeChunkModules\",\n       Self::MODULE_IDS => \"moduleIds\",\n       Self::CHUNK_IDS => \"chunkIds\",\n       Self::MODULES_HASHES => \"modulesHashes\",\ndiff --git a/packages/rspack/etc/core.api.md b/packages/rspack/etc/core.api.md\nindex 7061df69f85a..0ec8e3b6bc26 100644\n--- a/packages/rspack/etc/core.api.md\n+++ b/packages/rspack/etc/core.api.md\n@@ -3697,6 +3697,7 @@ export type Incremental = {\n     finishModules?: boolean;\n     optimizeDependencies?: boolean;\n     buildChunkGraph?: boolean;\n+    optimizeChunkModules?: boolean;\n     moduleIds?: boolean;\n     chunkIds?: boolean;\n     modulesHashes?: boolean;\ndiff --git a/packages/rspack/src/config/defaults.ts b/packages/rspack/src/config/defaults.ts\nindex 3b9016f0ff79..ec0d02721e2c 100644\n--- a/packages/rspack/src/config/defaults.ts\n+++ b/packages/rspack/src/config/defaults.ts\n@@ -235,6 +235,7 @@ const applyIncrementalDefaults = (options: RspackOptionsNormalized) => {\n     D(options.incremental, 'finishModules', true);\n     D(options.incremental, 'optimizeDependencies', true);\n     D(options.incremental, 'buildChunkGraph', true);\n+    D(options.incremental, 'optimizeChunkModules', true);\n     D(options.incremental, 'moduleIds', true);\n     D(options.incremental, 'chunkIds', true);\n     D(options.incremental, 'modulesHashes', true);\ndiff --git a/packages/rspack/src/config/normalization.ts b/packages/rspack/src/config/normalization.ts\nindex 9b41606f9d1a..c123b12cbdad 100644\n--- a/packages/rspack/src/config/normalization.ts\n+++ b/packages/rspack/src/config/normalization.ts\n@@ -448,6 +448,7 @@ const getNormalizedIncrementalOptions = (\n       finishModules: false,\n       optimizeDependencies: false,\n       buildChunkGraph: true,\n+      optimizeChunkModules: false,\n       moduleIds: false,\n       chunkIds: false,\n       modulesHashes: false,\ndiff --git a/packages/rspack/src/config/types.ts b/packages/rspack/src/config/types.ts\nindex 9790875ffd01..c7809bebb1ef 100644\n--- a/packages/rspack/src/config/types.ts\n+++ b/packages/rspack/src/config/types.ts\n@@ -2756,6 +2756,11 @@ export type Incremental = {\n    */\n   buildChunkGraph?: boolean;\n \n+  /**\n+   * Enable incremental optimize chunk modules.\n+   */\n+  optimizeChunkModules?: boolean;\n+\n   /**\n    * Enable incremental module ids.\n    */\ndiff --git a/tests/rspack-test/defaultsCases/default/base.js b/tests/rspack-test/defaultsCases/default/base.js\nindex 2c6d97cb36ef..966857a7c07a 100644\n--- a/tests/rspack-test/defaultsCases/default/base.js\n+++ b/tests/rspack-test/defaultsCases/default/base.js\n@@ -51,6 +51,7 @@ module.exports = {\n \t\t\t    modulesCodegen: true,\n \t\t\t    modulesHashes: true,\n \t\t\t    modulesRuntimeRequirements: true,\n+\t\t\t    optimizeChunkModules: true,\n \t\t\t    optimizeDependencies: true,\n \t\t\t    silent: true,\n \t\t\t  },\n"
test_patch: ''
fail_to_pass: []
pass_to_pass:
- cargo +nightly-2025-11-13 test -p rspack --test defaults -- default_options
install_config:
  install: cargo fetch
  rust: '1.75'
  test_cmd: cargo test
meta:
  added_lines: '81'
  difficulty: hard
  files_changed: '16'
  pr_title: 'refactor: Bind ImportedByDeferModulesArtifact to optimize chunk modules pass'
  removed_lines: '16'
  source: gh-archive-pr
  test_generation: agentic
prompt: |-
  web-infra-dev/rspack (#13059): refactor: Bind ImportedByDeferModulesArtifact to optimize chunk modules pass

  Summary
  - document that artifacts must declare the pass where they are first created and update `ImportedByDeferModulesArtifact` to use the new `OPTIMIZE_CHUNK_MODULES` pass
  - add the new pass bit, expose it through the JS/Rust incremental options, and default it on so the pass participates in the incremental flow
  - hook the cache into `before/after_optimize_chunk_modules`, recover the artifact there, and wire the pass into the optimize chunk modules implementation

  Testing
  - Not run (not requested)
quality_score: 0.74
quality_passed: true
docker_passed: false
workspace_path: null
status: ready
