id: openatv/enigma2-3706
repo: openatv/enigma2
base_commit: 37e744e99a0bbb3abb041b137d14d8dedbf29eed
merge_commit: 42aaa304ba70d800761eb1d94d64b07114debecd
language: python
difficulty_score: 2
created_at: 2026-02-14T14:29:11.679010941Z
patch: "diff --git a/lib/service/servicedvb.cpp b/lib/service/servicedvb.cpp\nindex e259ed36845..5833f68cd96 100644\n--- a/lib/service/servicedvb.cpp\n+++ b/lib/service/servicedvb.cpp\n@@ -4365,6 +4365,7 @@ void eDVBServicePlay::setupSpeculativeDescrambling()\n \n \t// Create SoftDecoder (will start when session activates)\n \tm_soft_decoder = new eDVBSoftDecoder(m_service_handler, m_dvb_service, m_decoder_index);\n+\tm_soft_decoder->setNoAudio(m_noaudio);\n \tm_soft_decoder->setSession(m_csa_session);\n \n \t// Connect to SoftDecoder's audio PID selection signal\ndiff --git a/lib/service/servicedvbsoftdecoder.cpp b/lib/service/servicedvbsoftdecoder.cpp\nindex 4fce1e37fb4..38e2b5fbfd6 100644\n--- a/lib/service/servicedvbsoftdecoder.cpp\n+++ b/lib/service/servicedvbsoftdecoder.cpp\n@@ -17,6 +17,7 @@ eDVBSoftDecoder::eDVBSoftDecoder(eDVBServicePMTHandler& source_handler,\n \t, m_dvr_fd(-1)\n \t, m_running(false)\n \t, m_stopping(false)\n+\t, m_noaudio(false)\n \t, m_decoder_started(false)\n \t, m_last_pts(0)\n \t, m_stall_count(0)\n@@ -675,10 +676,13 @@ void eDVBSoftDecoder::updateDecoder(int vpid, int vpidtype, int pcrpid)\n \t\t\t\t       apid, atype, audio_index, program.audioStreams.size());\n \t\t\t}\n \n-\t\t\tm_decoder->setAudioPID(apid, atype);\n+\t\t\tif (!m_noaudio)\n+\t\t\t{\n+\t\t\t\tm_decoder->setAudioPID(apid, atype);\n \n-\t\t\t// Notify parent about selected audio PID\n-\t\t\tm_audio_pid_selected(apid);\n+\t\t\t\t// Notify parent about selected audio PID\n+\t\t\t\tm_audio_pid_selected(apid);\n+\t\t\t}\n \t\t}\n \n \t\t// Using explicit pcrpid breaks video on some HiSilicon devices (e.g. sf8008) in PVR loopback mode\n@@ -750,6 +754,8 @@ int eDVBSoftDecoder::setTrickmode()\n \n int eDVBSoftDecoder::setAudioPID(int pid, int type)\n {\n+\tif (m_noaudio)\n+\t\treturn 0;\n \tif (m_decoder)\n \t\treturn m_decoder->setAudioPID(pid, type);\n \treturn -1;\ndiff --git a/lib/service/servicedvbsoftdecoder.h b/lib/service/servicedvbsoftdecoder.h\nindex 0e3c862e507..a8742ccaef6 100644\n--- a/lib/service/servicedvbsoftdecoder.h\n+++ b/lib/service/servicedvbsoftdecoder.h\n@@ -44,6 +44,9 @@ class eDVBSoftDecoder : public iObject, public sigc::trackable\n \tint start();\n \tvoid stop();\n \n+\t// Suppress audio output (PIP mode)\n+\tvoid setNoAudio(bool noaudio) { m_noaudio = noaudio; }\n+\n \t// Status\n \tbool isRunning() const { return m_running; }\n \n@@ -110,6 +113,7 @@ class eDVBSoftDecoder : public iObject, public sigc::trackable\n \tint m_dvr_fd;\n \tbool m_running;\n \tbool m_stopping;\n+\tbool m_noaudio;  // When true, suppress audio (PIP mode)\n \tstd::set<int> m_pids_active;\n \n \t// CW waiting: Timer-based decoder start\n"
test_patch: ''
fail_to_pass:
- pytest -q /tmp/test_softcsa_noaudio.py
pass_to_pass:
- pytest -q /tmp/test_repo_sanity.py
install_config:
  install: pip install -e .
  python: '3.11'
  test_cmd: pytest
meta:
  added_lines: '14'
  difficulty: medium
  files_changed: '3'
  pr_title: '[SoftCSA] Suppress audio in SoftDecoder for PIP to prevent audio routing corruption'
  removed_lines: '3'
  source: gh-archive-pr
  test_generation: agentic
prompt: |-
  openatv/enigma2 (#3706): [SoftCSA] Suppress audio in SoftDecoder for PIP to prevent audio routing corruption

  Prevent picture-in-picture playback of CSA-ALT/SoftCSA channels from disrupting the main programâ€™s audio. When a SoftDecoder is used for PIP, it must not open or route audio in a way that interferes with the primary audio stream, matching the behavior of hardware decoding where PIP audio is suppressed. Ensure switching PIP from SoftCSA to free-to-air no longer causes main audio loss.
original_pr_body: "openatv/enigma2 (#3706): [SoftCSA] Suppress audio in SoftDecoder for PIP to prevent audio routing corruption\n\nWhen a CSA-ALT channel runs as PIP, the SoftDecoder unconditionally called setAudioPID(), opening audio1 and interfering with the main picture's audio0 routing. This caused reproducible audio loss when switching PIP from a SoftCSA channel to FreeTV.\r\n\r\nAdd m_noaudio flag to eDVBSoftDecoder, matching the existing guard in the hardware decoder path (eDVBServicePlay::selectAudioStream)."
quality_score: 0.5
quality_passed: true
docker_passed: false
workspace_path: null
status: ready
